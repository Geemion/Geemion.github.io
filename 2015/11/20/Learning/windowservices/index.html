<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Window服务学习笔记 | Lyon&#39;s blog</title>
  <meta name="author" content="Lyon">
  
  <meta name="description" content="Walk steps step by step">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Window服务学习笔记"/>
  <meta property="og:site_name" content="Lyon&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  #<link href="/favicon.ico" rel="icon">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Lyon&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="/js/jquery.min.js"></script>
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?1d807422614f63c8de98cdc3b546860c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
  <script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
    
  <script data-ad-client="ca-pub-6317609007693835" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>


<body>
  <!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0027_Simplified Chinese.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Lyon&#39;s blog</a></h1>
  <h2><a href="/">I hear and I forget.I see and I remember.I do and I understand.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/about">关于</a></li>
    
	<li> <a href="/atom.xml">RSS</a> </li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2015-11-20T08:12:00.000Z"><a href="/2015/11/20/Learning/windowservices/">2015-11-20</a></time>
      
      
  
    <h1 class="title">Window服务学习笔记</h1>
  

    </header>
	
<!-- Table of Contents -->

  <div id="toc" class="toc-article">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#关于Windows服务"><span class="toc-number">1.</span> <span class="toc-text">关于Windows服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows服务的各种属性"><span class="toc-number">2.</span> <span class="toc-text">Windows服务的各种属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实例"><span class="toc-number">3.</span> <span class="toc-text">实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码"><span class="toc-number">4.</span> <span class="toc-text">代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#代码二"><span class="toc-number">4.1.</span> <span class="toc-text">代码二</span></a></li></ol></li></ol>
  </div>


	
    <div class="entry">
      
        <p>参考资料:<br><a href="http://www.vckbase.com/index.php/wv/1193" target="_blank" rel="external">用 C 语言编写 Windows 服务程序的五个步骤</a><br><a href="http://blog.csdn.net/zhangpeng_linux/article/details/7001084" target="_blank" rel="external">如何编写windows服务程序</a><br><a href="https://joway.wang/blog/2015/04/22/WindowsService.html" target="_blank" rel="external">用C创建并调用Windows服务（守护进程）</a><br><a href="http://www.xfocus.net/articles/200308/601.html" target="_blank" rel="external">创建SvcHost.exe调用的服务原理与实践</a><br>黑客防线201301</p>
<div align="center"><br><img src="/img/windows%20Service.png" align="center"><br></div>

<h2 id="关于Windows服务">关于Windows服务</h2><p>Windows系统中的服务几乎是都是默默无闻的存在的，大部分是一些系统进程，负责电源管理、网络及安全方面等与用户无交互的工作,在客户服务模型中主要是作为服务端存在。</p>
<div align="center"><br><img src="/img/scm_scp_exe.png" align="center"><br></div><br>Windows服务主要由3个部分组成，包括服务应用、服务控制程序（scp）及服务控制管理器（scm）。<br>服务应用即运行的服务程序，与普通的Windows可执行程序类似，只是有一些与scm的接口函数，负责与scm通信。<br>服务控制程序（scp）即负责控制服务应用的程序，Windows系统内置了一些scm的功能，比如我们可以sc命令控制服务应用的启动、停止等，有一些服务也自带了scp提供一些自定义的共计功能。服务控制程序就是普通的Windows用户程序。<br>服务控制管理器（scm）就是系统中负责在系统中管理全部服务的应用的，包括安装服务、负责服务自启动。容易和服务控制程序（scp）混淆，scp只是一个工具而scm是一个系统，scp就好比一种方法，scm是一个机构[好吧。。。这个比方不好]。<br><a id="more"></a><br><div align="center"><br><img src="/img/scm.png" align="center"><br></div><br>SCM的可执行文件是Services.exe,Services.exe负责启动启动类型为SERVICE_AUTO_START的服务。这些服务一般都按照特定的顺序被Services.exe启动，启动顺序可以在ServiceGroupOrder和GroupOrder查询，这个顺序和DependOnGroup和DependOnService键值相关。<br>SCM通过命名管道控制各个服务。<br><div align="center"><br><img src="/img/services_start.png" align="center"><br></div>

<h2 id="Windows服务的各种属性">Windows服务的各种属性</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建服务功能函数,也可以通过直接修改注册表创建服务</span></span><br><span class="line"><span class="function">SC_HANDLE WINAPI <span class="title">CreateService</span><span class="params">(</span><br><span class="line">_In_      SC_HANDLE hSCManager,          <span class="comment">// handle to SCM database </span></span><br><span class="line">_In_      LPCTSTR   lpServiceName,		 <span class="comment">// name of service to start</span></span><br><span class="line">_In_opt_  LPCTSTR   lpDisplayName,		 <span class="comment">// display name</span></span><br><span class="line">_In_      DWORD     dwDesiredAccess,	 <span class="comment">// type of access to service</span></span><br><span class="line">_In_      DWORD     dwServiceType,		 <span class="comment">// type of service</span></span><br><span class="line">_In_      DWORD     dwStartType,		 <span class="comment">// when to start service</span></span><br><span class="line">_In_      DWORD     dwErrorControl,		 <span class="comment">// severity of service failure</span></span><br><span class="line">_In_opt_  LPCTSTR   lpBinaryPathName,	 <span class="comment">// name of binary file</span></span><br><span class="line">_In_opt_  LPCTSTR   lpLoadOrderGroup,	 <span class="comment">// name of load ordering group</span></span><br><span class="line">_Out_opt_ LPDWORD   lpdwTagId,			 <span class="comment">// tag identifier</span></span><br><span class="line">_In_opt_  LPCTSTR   lpDependencies,		 <span class="comment">// array of dependency names</span></span><br><span class="line">_In_opt_  LPCTSTR   lpServiceStartName,	 <span class="comment">// account name </span></span><br><span class="line">_In_opt_  LPCTSTR   lpPassword			 <span class="comment">// account password);</span></span><br><span class="line">)</span></span>;</span><br><span class="line"><span class="comment">//一个普通服务注册表项</span></span><br><span class="line">[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\MozillaMaintenance]</span><br><span class="line"><span class="string">"Type"</span>=dword:<span class="number">00000010</span></span><br><span class="line"><span class="string">"Start"</span>=dword:<span class="number">00000003</span></span><br><span class="line"><span class="string">"ErrorControl"</span>=dword:<span class="number">00000001</span></span><br><span class="line"><span class="string">"ImagePath"</span>=hex(<span class="number">2</span>):<span class="number">22</span>,<span class="number">00</span>,<span class="number">43</span>,<span class="number">00</span>,<span class="number">3</span>a,<span class="number">00</span>,<span class="number">5</span>c,<span class="number">00</span>,<span class="number">50</span>,<span class="number">00</span>,<span class="number">72</span>,<span class="number">00</span>,<span class="number">6f</span>,<span class="number">00</span>,<span class="number">67</span>,<span class="number">00</span>,<span class="number">72</span>,<span class="number">00</span>,<span class="number">61</span>,<span class="number">00</span>,\</span><br><span class="line">  <span class="number">6</span>d,<span class="number">00</span>,<span class="number">20</span>,<span class="number">00</span>,<span class="number">46</span>,<span class="number">00</span>,<span class="number">69</span>,<span class="number">00</span>,<span class="number">6</span>c,<span class="number">00</span>,<span class="number">65</span>,<span class="number">00</span>,<span class="number">73</span>,<span class="number">00</span>,<span class="number">20</span>,<span class="number">00</span>,<span class="number">28</span>,<span class="number">00</span>,<span class="number">78</span>,<span class="number">00</span>,<span class="number">38</span>,<span class="number">00</span>,<span class="number">36</span>,<span class="number">00</span>,<span class="number">29</span>,\</span><br><span class="line">  <span class="number">00</span>,<span class="number">5</span>c,<span class="number">00</span>,<span class="number">4</span>d,<span class="number">00</span>,<span class="number">6f</span>,<span class="number">00</span>,<span class="number">7</span>a,<span class="number">00</span>,<span class="number">69</span>,<span class="number">00</span>,<span class="number">6</span>c,<span class="number">00</span>,<span class="number">6</span>c,<span class="number">00</span>,<span class="number">61</span>,<span class="number">00</span>,<span class="number">20</span>,<span class="number">00</span>,<span class="number">4</span>d,<span class="number">00</span>,<span class="number">61</span>,<span class="number">00</span>,<span class="number">69</span>,<span class="number">00</span>,\</span><br><span class="line">  <span class="number">6</span>e,<span class="number">00</span>,<span class="number">74</span>,<span class="number">00</span>,<span class="number">65</span>,<span class="number">00</span>,<span class="number">6</span>e,<span class="number">00</span>,<span class="number">61</span>,<span class="number">00</span>,<span class="number">6</span>e,<span class="number">00</span>,<span class="number">63</span>,<span class="number">00</span>,<span class="number">65</span>,<span class="number">00</span>,<span class="number">20</span>,<span class="number">00</span>,<span class="number">53</span>,<span class="number">00</span>,<span class="number">65</span>,<span class="number">00</span>,<span class="number">72</span>,<span class="number">00</span>,<span class="number">76</span>,\</span><br><span class="line">  <span class="number">00</span>,<span class="number">69</span>,<span class="number">00</span>,<span class="number">63</span>,<span class="number">00</span>,<span class="number">65</span>,<span class="number">00</span>,<span class="number">5</span>c,<span class="number">00</span>,<span class="number">6</span>d,<span class="number">00</span>,<span class="number">61</span>,<span class="number">00</span>,<span class="number">69</span>,<span class="number">00</span>,<span class="number">6</span>e,<span class="number">00</span>,<span class="number">74</span>,<span class="number">00</span>,<span class="number">65</span>,<span class="number">00</span>,<span class="number">6</span>e,<span class="number">00</span>,<span class="number">61</span>,<span class="number">00</span>,\</span><br><span class="line">  <span class="number">6</span>e,<span class="number">00</span>,<span class="number">63</span>,<span class="number">00</span>,<span class="number">65</span>,<span class="number">00</span>,<span class="number">73</span>,<span class="number">00</span>,<span class="number">65</span>,<span class="number">00</span>,<span class="number">72</span>,<span class="number">00</span>,<span class="number">76</span>,<span class="number">00</span>,<span class="number">69</span>,<span class="number">00</span>,<span class="number">63</span>,<span class="number">00</span>,<span class="number">65</span>,<span class="number">00</span>,<span class="number">2</span>e,<span class="number">00</span>,<span class="number">65</span>,<span class="number">00</span>,<span class="number">78</span>,\</span><br><span class="line">  <span class="number">00</span>,<span class="number">65</span>,<span class="number">00</span>,<span class="number">22</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span></span><br><span class="line"><span class="string">"DisplayName"</span>=<span class="string">"Mozilla Maintenance Service"</span></span><br><span class="line"><span class="string">"WOW64"</span>=dword:<span class="number">00000001</span></span><br><span class="line"><span class="string">"ObjectName"</span>=<span class="string">"LocalSystem"</span></span><br><span class="line"><span class="string">"Description"</span>=<span class="string">"Mozilla 维护服务能确保您的计算机上使用了最新且最安全的 Mozilla Firefox 版本。保持 Firefox 版本及时更新对您的网络安全是非常重要的，Mozilla 强烈建议您将这个服务保持开启状态。"</span></span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\MozillaMaintenance\Security]</span><br><span class="line"><span class="string">"Security"</span>=hex:<span class="number">01</span>,<span class="number">00</span>,<span class="number">14</span>,<span class="number">80</span>,a4,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,b0,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">14</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">30</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">02</span>,\</span><br><span class="line">  <span class="number">00</span>,<span class="number">1</span>c,<span class="number">00</span>,<span class="number">01</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">02</span>,<span class="number">80</span>,<span class="number">14</span>,<span class="number">00</span>,ff,<span class="number">01</span>,<span class="number">0f</span>,<span class="number">00</span>,<span class="number">01</span>,<span class="number">01</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">01</span>,<span class="number">00</span>,<span class="number">00</span>,\</span><br><span class="line">  <span class="number">00</span>,<span class="number">00</span>,<span class="number">02</span>,<span class="number">00</span>,<span class="number">74</span>,<span class="number">00</span>,<span class="number">05</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">18</span>,<span class="number">00</span>,bd,<span class="number">00</span>,<span class="number">02</span>,<span class="number">00</span>,<span class="number">01</span>,<span class="number">02</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,\</span><br><span class="line">  <span class="number">05</span>,<span class="number">20</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">21</span>,<span class="number">02</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">14</span>,<span class="number">00</span>,fd,<span class="number">01</span>,<span class="number">02</span>,<span class="number">00</span>,<span class="number">01</span>,<span class="number">01</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">05</span>,\</span><br><span class="line">  <span class="number">12</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">18</span>,<span class="number">00</span>,ff,<span class="number">01</span>,<span class="number">0f</span>,<span class="number">00</span>,<span class="number">01</span>,<span class="number">02</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">05</span>,<span class="number">20</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">20</span>,\</span><br><span class="line">  <span class="number">02</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">14</span>,<span class="number">00</span>,<span class="number">8</span>d,<span class="number">01</span>,<span class="number">02</span>,<span class="number">00</span>,<span class="number">01</span>,<span class="number">01</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">05</span>,<span class="number">04</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,\</span><br><span class="line">  <span class="number">14</span>,<span class="number">00</span>,<span class="number">8</span>d,<span class="number">01</span>,<span class="number">02</span>,<span class="number">00</span>,<span class="number">01</span>,<span class="number">01</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">05</span>,<span class="number">06</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">01</span>,<span class="number">01</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,\</span><br><span class="line">  <span class="number">05</span>,<span class="number">12</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">01</span>,<span class="number">01</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">05</span>,<span class="number">12</span>,<span class="number">00</span>,<span class="number">00</span>,<span class="number">00</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>自启动<br>服务自启动应该是Windows提供给用户的启动最早的自启动接口了，当服务被设置为自启动后能够在不进入桌面就启动（所以Windows服务器中的网络服务都能在不登陆的情况下提供服务），并且很多系统服务默认自启动。<br>dwStartType有一下几个选项：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> SERVICE_BOOT_START             <span class="number">0x00000000</span>  启动最早，提供给一些硬件驱动使用，</span></span><br><span class="line">                                                   由system启动由NTLDR加载</span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> SERVICE_SYSTEM_START           <span class="number">0x00000001</span>  启动较早，提供给由IoInitSystem初始的驱动程序 内核初始化时加载</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> SERVICE_AUTO_START             <span class="number">0x00000002</span>  Windows服务使用，随系统自启动由service control manager启动</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> SERVICE_DEMAND_START           <span class="number">0x00000003</span>  Windows服务使用，服务需要手动启动</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> SERVICE_DISABLED               <span class="number">0x00000004</span>  Windows服务使用，该服务不能启动，</span></span><br><span class="line">                                                   如果启动会导致ERROR_SERVICE_DISABLED错误</span><br></pre></td></tr></table></figure>
</li>
<li><p>后台执行<br>Windows服务运行在后台，无界面很少与用户交互。出于安全方面的考虑，在Windows vista之后服务和普通用户程序运行在不同的session（session隔离或则服务隔离），如果服务需要与用户交互需要启动一个用于程序然后通过进程间通信的方式将结果呈现给用户（这就和驱动程序类似）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一个session隔离实验</span></span><br><span class="line">实验系统 Windows <span class="number">7</span></span><br><span class="line"><span class="comment">//创建一个与用户交互的cmd服务（注意等号与值中间有个空格）</span></span><br><span class="line"><span class="number">1.</span>sc Create CmdService binPath= <span class="string">"cmd /K start"</span> type= own type= interact </span><br><span class="line"><span class="comment">//启动该服务</span></span><br><span class="line"><span class="number">2.</span>sc start  CmdService</span><br><span class="line"><span class="number">3.</span>这时会看到一个消息弹出，选择查看消息。这是你会进入另一个世界，但这个世界还没有盘古开天 哈哈</span><br><span class="line"><span class="number">4.</span>在命令行中输入 explorer 并执行，完成开天辟地了 新世界创建成功</span><br></pre></td></tr></table></figure>
</li>
<li><p>高权限<br>我们知道Windows有个进程完整性级别这个东西，不同完整性界别有不同的权限。有Untrust、Low、Medium、Hight、System级别从低到高，而服务的进程性完整性级别就是最高的system，所以拥有的权限也是最多的。拥有debug、加载驱动、创建全局内存共享等权限。因此这也是各种恶意软件、防病毒软件都争夺的地方。</p>
</li>
</ul>
<h2 id="实例">实例</h2><p>一直一来都有种困惑在心头（其实现在也没有完全解决），就是各种防病毒软件怎么自启动的或则说怎么自启动后还拥有高权限的？通过注册表或则计划任务启动的都是运行在Medium完整性级别（就是普通用户进程权限很少）而服务虽然拥有高权限且启动早，但是运行在session 0存在服务隔离不能与用户交互。现在可能有个初步想法防病毒软件进程可能是通过服务或则驱动启动的。由服务启动可与用户交互的代码参考<a href="http://youngroe/2015/08/20/Windows/windows-Security-Mechanism/" target="_blank" rel="external">Windows安全机制学习笔记</a><br><strong>更新:自启动获得高权限的另外一种方式就通过计划任务实现，计划任务在配置时候可以选择用户权限。实例：<a href="https://enigma0x3.net/2016/07/22/bypassing-uac-on-windows-10-using-disk-cleanup/" target="_blank" rel="external">如何设置让 Everything 在 Win7 下开机启动](http://www.appinn.com/how-to-startup-everything-win7/)BYPASSING UAC ON WINDOWS 10 USING DISK CLEANUP</a></strong></p>
<h2 id="代码">代码</h2><p>这里总结了两种服务的代码，具体方式请看参考资料。第一种服务由自己的进程启动bin文件是个exe，创建服务只需要createservice就可以了。第二种由svchost启动的服务bin文件是个dll，创建服务除了需要createservice之外还需要增加修改一些注册表键值，包括HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost及服务自身注册表。</p>
<p>###代码一<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//功能：一个进程一个服务，用于向E:</span></span><br><span class="line"><span class="comment">//1.txt文件写入每2000毫秒后的可用内存大小(MB)</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> SLEEP_TIME <span class="number">5000</span> <span class="comment">//SLEEP_TIME 指定两次连续查询可用内存之间的毫秒间隔。</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> LOGFILE <span class="string">"C:\\1.txt"</span> <span class="comment">//日志文件的路径</span></span></span><br><span class="line"></span><br><span class="line">SERVICE_STATUS ServiceStatus;</span><br><span class="line">SERVICE_STATUS_HANDLE hStatus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> brun = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> WINAPI <span class="title">ServiceMain</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> WINAPI <span class="title">CtrlHandler</span><span class="params">(DWORD request)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">WriteToLog</span><span class="params">(<span class="keyword">char</span>* str)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	FILE* <span class="built_in">log</span>;</span><br><span class="line">	<span class="built_in">log</span> = fopen(LOGFILE, <span class="string">"a+"</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">log</span> == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">log</span>, <span class="string">"%s\n"</span>, str);</span><br><span class="line">	fclose(<span class="built_in">log</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">//定义一个SERVICE_TABLE_ENTRY 结构</span></span><br><span class="line">	SERVICE_TABLE_ENTRY ServiceTable[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">//一个程序可能包含若干个服务。每一个服务都必须列于专门的分派表中</span></span><br><span class="line">	<span class="comment">//（为此该程序定义了一个 ServiceTable 结构数组）(每个数组相对应于每个服务(除了最后一个数组))</span></span><br><span class="line">	<span class="comment">//这个表中的每一项都要在 SERVICE_TABLE_ENTRY 结构之中。</span></span><br><span class="line"></span><br><span class="line">	ServiceTable[<span class="number">0</span>].lpServiceName = (LPWSTR)<span class="string">"testservice"</span>;</span><br><span class="line">	ServiceTable[<span class="number">0</span>].lpServiceProc = (LPSERVICE_MAIN_FUNCTION)ServiceMain;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//分派表的最后一项必须是服务名和服务主函数域的 NULL 指针</span></span><br><span class="line">	ServiceTable[<span class="number">1</span>].lpServiceName = <span class="literal">NULL</span>;</span><br><span class="line">	ServiceTable[<span class="number">1</span>].lpServiceProc = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 启动服务的控制分派机线程</span></span><br><span class="line">	StartServiceCtrlDispatcher(ServiceTable);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务控制管理器（SCM：Services Control Manager）是一个管理系统所有服务的进程。</span></span><br><span class="line"><span class="comment">//当 SCM 启动某个服务时，它等待某个进程的主线程来调用 StartServiceCtrlDispatcher 函数。</span></span><br><span class="line"><span class="comment">//将分派表传递给 StartServiceCtrlDispatcher。这将把调用进程的主线程转换为控制分派器。</span></span><br><span class="line"><span class="comment">//该分派器启动一个新线程，该线程运行分派表中每个服务的 ServiceMain 函数（本文例子中只有一个服务）</span></span><br><span class="line"><span class="comment">//分派器还监视程序中所有服务的执行情况。然后分派器将控制请求从 SCM 传给服务。</span></span><br><span class="line"><span class="comment">//注意：如果 StartServiceCtrlDispatcher 函数30秒没有被调用，便会报错，</span></span><br><span class="line"><span class="comment">//为了避免这种情况，我们必须在 ServiceMain 函数中（参见本文例子）</span></span><br><span class="line"><span class="comment">//或在非主函数的单独线程中初始化服务分派表。</span></span><br><span class="line"><span class="comment">//本文所描述的服务不需要防范这样的情况。</span></span><br><span class="line"><span class="comment">//分派表中所有的服务执行完之后（例如，用户通过“服务”控制面板程序停止它们）或者发生错误时,</span></span><br><span class="line"><span class="comment">//StartServiceCtrlDispatcher 调用返回。然后主进程终止。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*ServiceMain（），该函数是服务的入口点。</span><br><span class="line">它运行在一个单独的线程当中，这个线程是由控制分派器创建的。</span><br><span class="line">ServiceMain 应该尽可能早早为服务注册控制处理器。</span><br><span class="line">这要通过调用 RegisterServiceCtrlHadler 函数来实现。</span><br><span class="line">你要将两个参数传递给此函数：服务名和指向 ControlHandlerfunction 的指针。</span><br><span class="line">它指示控制分派器调用 ControlHandler 函数处理 SCM 控制请求。</span><br><span class="line">注册完控制处理器之后，获得状态句柄（hStatus）。</span><br><span class="line">通过调用 SetServiceStatus 函数，用 hStatus 向 SCM 报告服务的状态。</span><br><span class="line"></span><br><span class="line">下面展示了如何指定服务特征和其当前状态来初始化 ServiceStatus 结构，</span><br><span class="line">ServiceStatus 结构的每个域都有其用途：</span><br><span class="line"></span><br><span class="line">dwServiceType：指示服务类型，创建 Win32 服务。赋值 SERVICE_WIN32；</span><br><span class="line">dwCurrentState：指定服务的当前状态。因为服务的初始化在这里没有完成，所以这里的状态为 SERVICE_START_PENDING；</span><br><span class="line">`dwWin32ExitCode 和 dwServiceSpecificExitCode：这两个域在你终止服务并报告退出细节时很有用。初始化服务时并不退出，因此，它们的值为 0；</span><br><span class="line">dwCheckPoint 和 dwWaitHint：这两个域表示初始化某个服务进程时要30秒以上。本文例子服务的初始化过程很短，所以这两个域的值都为 0。</span><br><span class="line"></span><br><span class="line">调用 SetServiceStatus 函数向 SCM 报告服务的状态时。要提供 hStatus 句柄和 ServiceStatus 结构。注意 ServiceStatus 一个全局变量，所以你可以跨多个函数使用它。ServiceMain 函数中，你给结构的几个域赋值，它们在服务运行的整个过程中都保持不变，比如：dwServiceType。</span><br><span class="line"></span><br><span class="line">在报告了服务状态之后，你可以调用 InitService 函数来完成初始化。这个函数只是添加一个说明性字符串到日志文件。如下面代码所示：</span><br><span class="line">服务初始化*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//在 ServiceMain 中，检查 InitService 函数的返回值。</span></span><br><span class="line"><span class="comment">//如果初始化有错（因为有可能写日志文件失败），</span></span><br><span class="line"><span class="comment">//则将服务状态置为终止并退出 ServiceMain：</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> WINAPI <span class="title">ServiceMain</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	ServiceStatus.dwServiceType = SERVICE_WIN32;</span><br><span class="line">	ServiceStatus.dwCurrentState = SERVICE_START_PENDING;</span><br><span class="line">	ServiceStatus.dwControlsAccepted = SERVICE_ACCEPT_SHUTDOWN</span><br><span class="line">		| SERVICE_ACCEPT_STOP;</span><br><span class="line">	ServiceStatus.dwWin32ExitCode = <span class="number">0</span>;</span><br><span class="line">	ServiceStatus.dwServiceSpecificExitCode = <span class="number">0</span>;</span><br><span class="line">	ServiceStatus.dwCheckPoint = <span class="number">0</span>;</span><br><span class="line">	ServiceStatus.dwWaitHint = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	hStatus = ::RegisterServiceCtrlHandler((LPCWSTR)<span class="string">"testservice"</span>, CtrlHandler);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hStatus == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		WriteToLog(<span class="string">"RegisterServiceCtrlHandler failed"</span>);</span><br><span class="line">		<span class="comment">// 初始化失败，终止服务</span></span><br><span class="line">		ServiceStatus.dwCurrentState = SERVICE_STOPPED;</span><br><span class="line">		ServiceStatus.dwWin32ExitCode = -<span class="number">1</span>;</span><br><span class="line">		SetServiceStatus(hStatus, &amp;ServiceStatus);</span><br><span class="line">		<span class="comment">// 退出 ServiceMain</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	WriteToLog(<span class="string">"RegisterServiceCtrlHandler success"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//向SCM 报告运行状态</span></span><br><span class="line">	ServiceStatus.dwCurrentState = SERVICE_RUNNING;</span><br><span class="line">	SetServiceStatus(hStatus, &amp;ServiceStatus);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//下面就开始任务循环了，你可以添加你自己希望服务做的工作</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	brun = <span class="literal">true</span>;</span><br><span class="line">	MEMORYSTATUS memstatus;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> str[<span class="number">100</span>];</span><br><span class="line">	<span class="built_in">memset</span>(str, <span class="string">'\0'</span>, <span class="number">100</span>);</span><br><span class="line">	<span class="keyword">while</span> (brun)</span><br><span class="line">	&#123;</span><br><span class="line">		GlobalMemoryStatus(&amp;memstatus);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> availmb = memstatus.dwAvailPhys / <span class="number">1024</span> / <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">		sprintf_s(str, <span class="number">100</span>, <span class="string">"available memory is %dMB"</span>, availmb);</span><br><span class="line"></span><br><span class="line">		WriteToLog(str);</span><br><span class="line"></span><br><span class="line">		Sleep(SLEEP_TIME);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	WriteToLog(<span class="string">"service stopped"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//循环一直到服务的状态为 SERVICE_RUNNING 或日志文件写入出错为止。</span></span><br><span class="line"><span class="comment">//状态可能在 ControlHandler 函数响应 SCM 控制请求时修改。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line">前面用 ServiceMain 函数注册了控制处理器函数。</span><br><span class="line">控制处理器检查 SCM 发送了什么请求并采取相应行动。</span><br><span class="line">每次你调用 SetServiceStatus 函数的时候，必须指定服务接收 STOP 和 SHUTDOWN 请求。</span><br><span class="line">而这些请求要在 ControlHandler 函数中处理它们。</span><br><span class="line">STOP 请求是 SCM 终止服务的时候发送的。</span><br><span class="line">例如，如果用户在“服务”控制面板中手动终止服务。</span><br><span class="line">SHUTDOWN 请求是关闭机器时，由 SCM 发送给所有运行中服务的请求。</span><br><span class="line">两种情况的处理方式相同：写日志文件，监视停止；向SCM 报告SERVICE_STOPPED 状态。</span><br><span class="line"></span><br><span class="line">由于 ServiceStatus 结构对于整个程序而言为全局量，</span><br><span class="line">ServiceStatus 中的工作循环在当前状态改变或服务终止后停止。</span><br><span class="line">其它的控制请求如：PAUSE 和 CONTINUE 在本文的例子没有处理。</span><br><span class="line">控制处理器函数必须报告服务状态，即便 SCM 每次发送控制请求的时候状态保持相同。</span><br><span class="line">因此，不管响应什么请求，都要调用 SetServiceStatus。</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> WINAPI <span class="title">CtrlHandler</span><span class="params">(DWORD request)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (request)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> SERVICE_CONTROL_STOP:</span><br><span class="line">		brun = <span class="literal">false</span>;</span><br><span class="line">		ServiceStatus.dwCurrentState = SERVICE_STOPPED;</span><br><span class="line">		WriteToLog(<span class="string">"SERVICE_CONTROL_STOP---SERVICE_STOPPED"</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> SERVICE_CONTROL_SHUTDOWN:</span><br><span class="line">		brun = <span class="literal">false</span>;</span><br><span class="line">		ServiceStatus.dwCurrentState = SERVICE_STOPPED;</span><br><span class="line">		WriteToLog(<span class="string">"SERVICE_CONTROL_SHUTDOWN---SERVICE_STOPPED"</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	SetServiceStatus(hStatus, &amp;ServiceStatus);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="代码二">代码二</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SvcHostDLL.cpp : Demo for a service dll used by svchost.exe to host it.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// for detail comment see articles.</span></span><br><span class="line"><span class="comment">//   by bingle_at_email.com.cn</span></span><br><span class="line"><span class="comment">//      www.BingleSite.net</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">/* save following as a .def file to export function, only ServiceMain is needed.</span><br><span class="line">other used to install &amp; uninstall service.</span><br><span class="line">or use /EXPORT: link option to export them.</span><br><span class="line"></span><br><span class="line">EXPORTS</span><br><span class="line">	ServiceMain</span><br><span class="line">	InstallService</span><br><span class="line">	UninstallService</span><br><span class="line">	RundllUninstallA</span><br><span class="line">	RundllInstallA</span><br><span class="line">*/</span></span><br><span class="line"><span class="comment">/*</span><br><span class="line">To compile &amp; link: </span><br><span class="line">cl /MD /GX /LD svchostdll.cpp /link advapi32.lib /DLL /base:0x71000000 /export:ServiceMain /EXPORT:RundllUninstallA /EXPORT:RundllInstallA /EXPORT:InstallService /EXPORT:UninstallService</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Articles:</span></span><br><span class="line"><span class="comment">// 1. HOWTO Create a service dll used by svchost.exe by bingle, at: http://www.BingleSite.net/article/svchost-dll-service.html</span></span><br><span class="line"><span class="comment">// 2. Inside Win32 Services, Part 2 by: Mark Russinovich, at: http://www.winnetmag.com/Articles/Index.cfm?ArticleID=8943&amp;pg=3</span></span><br><span class="line"><span class="comment">// 3. Platform SDK: Tools - Rundll32, at: http://msdn.microsoft.com/library/en-us/tools/tools/rundll32.asp</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> DEFAULT_SERVICE <span class="string">"IPRIP"</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MY_EXECUTE_NAME <span class="string">"SvcHostDLL.exe"</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:<span class="number">4996</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//main service process function</span></span><br><span class="line"><span class="keyword">void</span> __<span class="function">stdcall <span class="title">ServiceMain</span><span class="params">( <span class="keyword">int</span> argc, wchar_t* argv[] )</span></span>;</span><br><span class="line"><span class="comment">//report service stat to the service control manager</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">TellSCM</span><span class="params">( DWORD dwState, DWORD dwExitCode, DWORD dwProgress )</span></span>;</span><br><span class="line"><span class="comment">//service control handler, call back by service control manager</span></span><br><span class="line"><span class="keyword">void</span> __<span class="function">stdcall <span class="title">ServiceHandler</span><span class="params">( DWORD dwCommand )</span></span>;</span><br><span class="line"><span class="comment">//RealService just create a process </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RealService</span><span class="params">(<span class="keyword">char</span> *cmd, <span class="keyword">int</span> bInteract)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Install this dll as a Service host by svchost.exe, service name is given by caller</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">InstallService</span><span class="params">(<span class="keyword">char</span> *name)</span></span>;</span><br><span class="line"><span class="comment">//unInstall a Service, be CARE FOR call this to delete a service</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">UninstallService</span><span class="params">(<span class="keyword">char</span> *name)</span></span>;</span><br><span class="line"><span class="comment">//Install this dll as a Service host by svchost.exe, used by RUNDLL32.EXE to call</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> CALLBACK <span class="title">RundllInstallA</span><span class="params">(HWND hwnd, HINSTANCE hinst, <span class="keyword">char</span> *param, <span class="keyword">int</span> nCmdShow)</span></span>;</span><br><span class="line"><span class="comment">//unInstall a Service used by RUNDLL32.EXE to call, be CARE FOR call this to delete a service</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> CALLBACK <span class="title">RundllUninstallA</span><span class="params">(HWND hwnd, HINSTANCE hinst, <span class="keyword">char</span> *param, <span class="keyword">int</span> nCmdShow)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//output the debug infor into log file(or stderr if a console program call me) &amp; DbgPrint</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OutputString</span><span class="params">( <span class="keyword">char</span> *lpFmt, ... )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//#pragma comment(linker, "/EXPORT:ServiceMain")</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//dll module handle used to get dll path in InstallService</span></span><br><span class="line">HANDLE hDll = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//Service HANDLE &amp; STATUS used to get service state</span></span><br><span class="line">SERVICE_STATUS_HANDLE hSrv;</span><br><span class="line">DWORD dwCurrState;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HANDLE hModule, </span><br><span class="line">                       DWORD  ul_reason_for_call, </span><br><span class="line">                       LPVOID lpReserved</span><br><span class="line">					 )</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">		hDll = hModule;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> _DEBUG</span></span><br><span class="line">		AllocConsole();</span><br><span class="line">		OutputString(<span class="string">"SvcHostDLL: DllMain called DLL_PROCESS_ATTACH"</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">		OutputString(<span class="string">"SvcHostDLL: DllMain called DLL_THREAD_ATTACH"</span>);</span><br><span class="line">	<span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">		OutputString(<span class="string">"SvcHostDLL: DllMain called DLL_THREAD_DETACH"</span>);</span><br><span class="line">	<span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">		TellSCM( SERVICE_STOP_PENDING, <span class="number">0</span>, <span class="number">0</span> );</span><br><span class="line">		Sleep(<span class="number">1500</span>);</span><br><span class="line">		TellSCM( SERVICE_STOPPED, <span class="number">0</span>, <span class="number">0</span> );</span><br><span class="line">		OutputString(<span class="string">"SvcHostDLL: DllMain called DLL_PROCESS_DETACH"</span>);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">GetSvcOption</span><span class="params">(<span class="keyword">char</span> *svcname, <span class="keyword">char</span> *file, <span class="keyword">int</span> *bInteract)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// Open a handle to the SC Manager database. </span></span><br><span class="line">	<span class="keyword">int</span> rc = <span class="number">0</span>, val = <span class="number">0</span>;</span><br><span class="line">	HKEY hkRoot = HKEY_LOCAL_MACHINE, hkParam = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!svcname || !svcname[<span class="number">0</span>]) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//query service setting</span></span><br><span class="line">	<span class="keyword">char</span> buff[<span class="number">500</span>];</span><br><span class="line">	_snprintf(buff, <span class="keyword">sizeof</span> buff, <span class="string">"SYSTEM\\CurrentControlSet\\Services\\%s\\Parameters"</span>, svcname);</span><br><span class="line">	rc = RegOpenKeyEx(hkRoot, buff, <span class="number">0</span>, KEY_QUERY_VALUE, &amp;hkRoot);</span><br><span class="line">	<span class="keyword">if</span>(ERROR_SUCCESS != rc)</span><br><span class="line">	&#123;</span><br><span class="line">		OutputString(<span class="string">"RegOpenKeyEx(%s) KEY_QUERY_VALUE error %d."</span>, buff, rc); </span><br><span class="line">		<span class="keyword">throw</span> <span class="string">""</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DWORD type, size = MAX_PATH;</span><br><span class="line">	rc = RegQueryValueEx(hkRoot, <span class="string">"program"</span>, <span class="number">0</span>, &amp;type, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)file, &amp;size);</span><br><span class="line">	SetLastError(rc);</span><br><span class="line">	<span class="keyword">if</span>(ERROR_SUCCESS != rc)</span><br><span class="line">		<span class="keyword">throw</span> <span class="string">"RegQueryValueEx(Parameters\\program)"</span>;</span><br><span class="line"></span><br><span class="line">	val++;</span><br><span class="line">	OutputString(<span class="string">"program=%s"</span>, file); </span><br><span class="line"></span><br><span class="line">	size = <span class="keyword">sizeof</span> *bInteract;</span><br><span class="line">	rc = RegQueryValueEx(hkRoot, <span class="string">"Interactive"</span>, <span class="number">0</span>, &amp;type, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)bInteract, &amp;size);</span><br><span class="line">	SetLastError(rc);</span><br><span class="line">	<span class="keyword">if</span>(ERROR_SUCCESS != rc)</span><br><span class="line">		<span class="keyword">throw</span> <span class="string">"RegQueryValueEx(Parameters\\Interactive)"</span>;</span><br><span class="line"></span><br><span class="line">	val++;</span><br><span class="line">	OutputString(<span class="string">"Interactive=%d"</span>, *bInteract); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;<span class="keyword">catch</span>(<span class="keyword">char</span> *str)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(str &amp;&amp; str[<span class="number">0</span>])</span><br><span class="line">		&#123;</span><br><span class="line">			rc = GetLastError();</span><br><span class="line">			OutputString(<span class="string">"%s error %d"</span>, str, rc);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	RegCloseKey(hkRoot);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __<span class="function">stdcall <span class="title">ServiceMain</span><span class="params">( <span class="keyword">int</span> argc, wchar_t* argv[] )</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="comment">//	DebugBreak();</span></span><br><span class="line">	<span class="keyword">char</span> svcname[<span class="number">256</span>], file[MAX_PATH];</span><br><span class="line">	<span class="built_in">strncpy</span>(svcname, (<span class="keyword">char</span>*)argv[<span class="number">0</span>], <span class="keyword">sizeof</span> svcname); <span class="comment">//it's should be unicode, but if it's ansi we do it well</span></span><br><span class="line">	wcstombs(svcname, argv[<span class="number">0</span>], <span class="keyword">sizeof</span> svcname);</span><br><span class="line">	OutputString(<span class="string">"SvcHostDLL: ServiceMain(%d, %s) called"</span>, argc, svcname);</span><br><span class="line"></span><br><span class="line">	hSrv = RegisterServiceCtrlHandler( svcname, (LPHANDLER_FUNCTION)ServiceHandler );</span><br><span class="line">    <span class="keyword">if</span>( hSrv == <span class="literal">NULL</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		OutputString(<span class="string">"SvcHostDLL: RegisterServiceCtrlHandler %S failed"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span> FreeConsole();</span><br><span class="line"></span><br><span class="line">    TellSCM( SERVICE_START_PENDING, <span class="number">0</span>, <span class="number">1</span> );</span><br><span class="line">    TellSCM( SERVICE_RUNNING, <span class="number">0</span>, <span class="number">0</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// call Real Service function noew</span></span><br><span class="line">	<span class="keyword">int</span> bInteract = argc &gt; <span class="number">2</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(argc &gt; <span class="number">1</span>)</span><br><span class="line">		<span class="built_in">strncpy</span>(file, (<span class="keyword">char</span>*)argv[<span class="number">1</span>], <span class="keyword">sizeof</span> file),</span><br><span class="line">		wcstombs(file, argv[<span class="number">1</span>], <span class="keyword">sizeof</span> file);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(!GetSvcOption(svcname, file, &amp;bInteract)) </span><br><span class="line">		<span class="built_in">strncpy</span>(file, MY_EXECUTE_NAME, <span class="keyword">sizeof</span> file);</span><br><span class="line"></span><br><span class="line">    RealService(file, bInteract);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span>&#123;</span><br><span class="line">		Sleep(<span class="number">10</span>);<span class="comment">//not quit until receive stop command, otherwise the service will stop</span></span><br><span class="line">	&#125;<span class="keyword">while</span>(dwCurrState != SERVICE_STOP_PENDING &amp;&amp; dwCurrState != SERVICE_STOPPED);</span><br><span class="line"></span><br><span class="line">	OutputString(<span class="string">"SvcHostDLL: ServiceMain done"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">TellSCM</span><span class="params">( DWORD dwState, DWORD dwExitCode, DWORD dwProgress )</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    SERVICE_STATUS srvStatus;</span><br><span class="line">    srvStatus.dwServiceType = SERVICE_WIN32_OWN_PROCESS;</span><br><span class="line">    srvStatus.dwCurrentState = dwCurrState = dwState;</span><br><span class="line">    srvStatus.dwControlsAccepted = SERVICE_ACCEPT_STOP | SERVICE_ACCEPT_PAUSE_CONTINUE | SERVICE_ACCEPT_SHUTDOWN;</span><br><span class="line">    srvStatus.dwWin32ExitCode = dwExitCode;</span><br><span class="line">    srvStatus.dwServiceSpecificExitCode = <span class="number">0</span>;</span><br><span class="line">    srvStatus.dwCheckPoint = dwProgress;</span><br><span class="line">    srvStatus.dwWaitHint = <span class="number">3000</span>;</span><br><span class="line">    <span class="keyword">return</span> SetServiceStatus( hSrv, &amp;srvStatus );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __<span class="function">stdcall <span class="title">ServiceHandler</span><span class="params">( DWORD dwCommand )</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// not really necessary because the service stops quickly</span></span><br><span class="line">	<span class="keyword">switch</span>( dwCommand )</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> SERVICE_CONTROL_STOP:</span><br><span class="line">        TellSCM( SERVICE_STOP_PENDING, <span class="number">0</span>, <span class="number">1</span> );</span><br><span class="line">		OutputString(<span class="string">"SvcHostDLL: ServiceHandler called SERVICE_CONTROL_STOP"</span>);</span><br><span class="line">		Sleep(<span class="number">10</span>);</span><br><span class="line">        TellSCM( SERVICE_STOPPED, <span class="number">0</span>, <span class="number">0</span> );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SERVICE_CONTROL_PAUSE:</span><br><span class="line">        TellSCM( SERVICE_PAUSE_PENDING, <span class="number">0</span>, <span class="number">1</span> );</span><br><span class="line">		OutputString(<span class="string">"SvcHostDLL: ServiceHandler called SERVICE_CONTROL_PAUSE"</span>);</span><br><span class="line">        TellSCM( SERVICE_PAUSED, <span class="number">0</span>, <span class="number">0</span> );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SERVICE_CONTROL_CONTINUE:</span><br><span class="line">        TellSCM( SERVICE_CONTINUE_PENDING, <span class="number">0</span>, <span class="number">1</span> );</span><br><span class="line">		OutputString(<span class="string">"SvcHostDLL: ServiceHandler called SERVICE_CONTROL_CONTINUE"</span>);</span><br><span class="line">        TellSCM( SERVICE_RUNNING, <span class="number">0</span>, <span class="number">0</span> );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SERVICE_CONTROL_INTERROGATE:</span><br><span class="line">		OutputString(<span class="string">"SvcHostDLL: ServiceHandler called SERVICE_CONTROL_INTERROGATE"</span>);</span><br><span class="line">        TellSCM( dwCurrState, <span class="number">0</span>, <span class="number">0</span> );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SERVICE_CONTROL_SHUTDOWN:</span><br><span class="line">		OutputString(<span class="string">"SvcHostDLL: ServiceHandler called SERVICE_CONTROL_SHUTDOWN"</span>);</span><br><span class="line">        TellSCM( SERVICE_STOPPED, <span class="number">0</span>, <span class="number">0</span> );</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//RealService just create a process </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RealService</span><span class="params">(<span class="keyword">char</span> *cmd, <span class="keyword">int</span> bInteract)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	OutputString(<span class="string">"SvcHostDLL: RealService called '%s' %s"</span>, cmd, bInteract ? <span class="string">"Interact"</span> : <span class="string">""</span>);</span><br><span class="line">	STARTUPINFO si = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	PROCESS_INFORMATION pi;</span><br><span class="line">	si.cb = <span class="keyword">sizeof</span> si;</span><br><span class="line">	<span class="keyword">if</span>(bInteract) si.lpDesktop = <span class="string">"WinSta0\\Default"</span>; </span><br><span class="line">	<span class="keyword">if</span>(!CreateProcess(<span class="literal">NULL</span>, cmd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi))</span><br><span class="line">		OutputString(<span class="string">"SvcHostDLL: CreateProcess(%s) error:%d"</span>, cmd, GetLastError());</span><br><span class="line">	<span class="keyword">else</span> OutputString(<span class="string">"SvcHostDLL: CreateProcess(%s) to %d"</span>, cmd, pi.dwProcessId);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">InstallService</span><span class="params">(<span class="keyword">char</span> *name)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// Open a handle to the SC Manager database. </span></span><br><span class="line">	<span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">	HKEY hkRoot = HKEY_LOCAL_MACHINE, hkParam = <span class="number">0</span>;</span><br><span class="line">	SC_HANDLE hscm = <span class="literal">NULL</span>, schService = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buff[<span class="number">500</span>];</span><br><span class="line">	<span class="keyword">char</span> *svcname = DEFAULT_SERVICE;</span><br><span class="line">	<span class="keyword">if</span>(name &amp;&amp; name[<span class="number">0</span>]) svcname = name;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//query svchost setting</span></span><br><span class="line">	<span class="keyword">char</span> *ptr, *pSvchost = <span class="string">"SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Svchost"</span>;</span><br><span class="line">	rc = RegOpenKeyEx(hkRoot, pSvchost, <span class="number">0</span>, KEY_QUERY_VALUE, &amp;hkRoot);</span><br><span class="line">	<span class="keyword">if</span>(ERROR_SUCCESS != rc)</span><br><span class="line">	&#123;</span><br><span class="line">		OutputString(<span class="string">"RegOpenKeyEx(%s) KEY_QUERY_VALUE error %d."</span>, pSvchost, rc); </span><br><span class="line">		<span class="keyword">throw</span> <span class="string">""</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DWORD type, size = <span class="keyword">sizeof</span> buff;</span><br><span class="line">	rc = RegQueryValueEx(hkRoot, <span class="string">"netsvcs"</span>, <span class="number">0</span>, &amp;type, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buff, &amp;size);</span><br><span class="line">	RegCloseKey(hkRoot);</span><br><span class="line">	SetLastError(rc);</span><br><span class="line">	<span class="keyword">if</span>(ERROR_SUCCESS != rc)</span><br><span class="line">		<span class="keyword">throw</span> <span class="string">"RegQueryValueEx(Svchost\\netsvcs)"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//实际情况服务存在创建失败</span></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	for(ptr = buff; *ptr; ptr = strchr(ptr, 0)+1)</span><br><span class="line">		if(stricmp(ptr, svcname) == 0) break;</span><br><span class="line"></span><br><span class="line">	if(*ptr == 0)</span><br><span class="line">	&#123;</span><br><span class="line">		OutputString("you specify service name not in Svchost\\netsvcs, must be one of following:"); </span><br><span class="line">		for(ptr = buff; *ptr; ptr = strchr(ptr, 0)+1)</span><br><span class="line">			OutputString(" - %s", ptr); </span><br><span class="line">		throw "";</span><br><span class="line">	&#125;*/</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//install service</span></span><br><span class="line">	hscm = OpenSCManager(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_ALL_ACCESS);</span><br><span class="line">	<span class="keyword">if</span> (hscm == <span class="literal">NULL</span>) </span><br><span class="line">		<span class="keyword">throw</span> <span class="string">"OpenSCManager()"</span>;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">char</span> *bin = <span class="string">"%SystemRoot%\\System32\\svchost.exe -k netsvcs"</span>;</span><br><span class="line"></span><br><span class="line">    schService = CreateService( </span><br><span class="line">        hscm,						<span class="comment">// SCManager database </span></span><br><span class="line">        svcname,					<span class="comment">// name of service </span></span><br><span class="line">        <span class="literal">NULL</span>,           <span class="comment">// service name to display </span></span><br><span class="line">        SERVICE_ALL_ACCESS,        <span class="comment">// desired access </span></span><br><span class="line">        SERVICE_WIN32_SHARE_PROCESS, <span class="comment">// service type </span></span><br><span class="line">        SERVICE_AUTO_START,      <span class="comment">// start type </span></span><br><span class="line">        SERVICE_ERROR_NORMAL,      <span class="comment">// error control type </span></span><br><span class="line">        bin,        <span class="comment">// service's binary </span></span><br><span class="line">        <span class="literal">NULL</span>,                      <span class="comment">// no load ordering group </span></span><br><span class="line">        <span class="literal">NULL</span>,                      <span class="comment">// no tag identifier </span></span><br><span class="line">        <span class="literal">NULL</span>,                      <span class="comment">// no dependencies </span></span><br><span class="line">        <span class="literal">NULL</span>,                      <span class="comment">// LocalSystem account </span></span><br><span class="line">        <span class="literal">NULL</span>);                     <span class="comment">// no password </span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (schService == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		OutputString(<span class="string">"CreateService(%s) error %d"</span>, svcname, rc = GetLastError());</span><br><span class="line">		<span class="keyword">throw</span> <span class="string">""</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    OutputString(<span class="string">"CreateService(%s) SUCCESS. Config it"</span>, svcname); </span><br><span class="line"> </span><br><span class="line">    CloseServiceHandle(schService); </span><br><span class="line">    CloseServiceHandle(hscm); </span><br><span class="line"></span><br><span class="line">	<span class="comment">//config service</span></span><br><span class="line">	hkRoot = HKEY_LOCAL_MACHINE;</span><br><span class="line">	<span class="built_in">strncpy</span>(buff, <span class="string">"SYSTEM\\CurrentControlSet\\Services\\"</span>, <span class="keyword">sizeof</span> buff);</span><br><span class="line">	<span class="built_in">strncat</span>(buff, svcname, <span class="number">100</span>);</span><br><span class="line">	rc = RegOpenKeyEx(hkRoot, buff, <span class="number">0</span>, KEY_ALL_ACCESS, &amp;hkRoot);</span><br><span class="line">	<span class="keyword">if</span>(ERROR_SUCCESS != rc)</span><br><span class="line">	&#123;</span><br><span class="line">		OutputString(<span class="string">"RegOpenKeyEx(%s) KEY_SET_VALUE error %d."</span>, svcname, rc); </span><br><span class="line">		<span class="keyword">throw</span> <span class="string">""</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rc = RegCreateKey(hkRoot, <span class="string">"Parameters"</span>, &amp;hkParam);</span><br><span class="line">	SetLastError(rc);</span><br><span class="line">	<span class="keyword">if</span>(ERROR_SUCCESS != rc)</span><br><span class="line">		<span class="keyword">throw</span> <span class="string">"RegCreateKey(Parameters)"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!GetModuleFileName(HMODULE(hDll), buff, <span class="keyword">sizeof</span> buff))</span><br><span class="line">		<span class="keyword">throw</span> <span class="string">"GetModuleFileName() get dll path"</span>;</span><br><span class="line"></span><br><span class="line">	rc = RegSetValueEx(hkParam, <span class="string">"ServiceDll"</span>, <span class="number">0</span>, REG_EXPAND_SZ, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buff, <span class="built_in">strlen</span>(buff)+<span class="number">1</span>);</span><br><span class="line">	SetLastError(rc);</span><br><span class="line">	<span class="keyword">if</span>(ERROR_SUCCESS != rc)</span><br><span class="line">		<span class="keyword">throw</span> <span class="string">"RegSetValueEx(ServiceDll)"</span>;</span><br><span class="line"></span><br><span class="line">	rc = RegSetValueEx(hkParam, <span class="string">"program"</span>, <span class="number">0</span>, REG_EXPAND_SZ, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)MY_EXECUTE_NAME, <span class="built_in">strlen</span>(MY_EXECUTE_NAME)+<span class="number">1</span>);</span><br><span class="line">	rc = <span class="number">0</span>;</span><br><span class="line">	rc = RegSetValueEx(hkParam, <span class="string">"Interactive"</span>, <span class="number">0</span>, REG_DWORD, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)&amp;rc, <span class="keyword">sizeof</span> rc);</span><br><span class="line"></span><br><span class="line">	OutputString(<span class="string">"Config service %s ok."</span>, svcname); </span><br><span class="line">	&#125;<span class="keyword">catch</span>(<span class="keyword">char</span> *str)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(str &amp;&amp; str[<span class="number">0</span>])</span><br><span class="line">		&#123;</span><br><span class="line">			rc = GetLastError();</span><br><span class="line">			OutputString(<span class="string">"%s error %d"</span>, str, rc);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	RegCloseKey(hkRoot);</span><br><span class="line">	RegCloseKey(hkParam);</span><br><span class="line">    CloseServiceHandle(schService); </span><br><span class="line">    CloseServiceHandle(hscm); </span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line">used to install by rundll32.exe</span><br><span class="line">Platform SDK: Tools - Rundll32</span><br><span class="line">The Run DLL utility (Rundll32.exe) included in Windows enables you to call functions exported from a 32-bit DLL. These functions must have the following syntax:</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> CALLBACK <span class="title">RundllInstallA</span><span class="params">(</span><br><span class="line">  HWND hwnd,        <span class="comment">// handle to owner window</span></span><br><span class="line">  HINSTANCE hinst,  <span class="comment">// instance handle for the DLL</span></span><br><span class="line">  <span class="keyword">char</span> *param,		<span class="comment">// string the DLL will parse</span></span><br><span class="line">  <span class="keyword">int</span> nCmdShow      <span class="comment">// show state</span></span><br><span class="line">)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	InstallService(param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">UninstallService</span><span class="params">(<span class="keyword">char</span> *name)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">	SC_HANDLE schService;</span><br><span class="line">	SC_HANDLE hscm;</span><br><span class="line"></span><br><span class="line">	__try&#123;</span><br><span class="line">	hscm = OpenSCManager(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_ALL_ACCESS);</span><br><span class="line">	<span class="keyword">if</span> (hscm == <span class="literal">NULL</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		OutputString(<span class="string">"OpenSCManager() error %d"</span>, rc = GetLastError() ); </span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> *svcname = DEFAULT_SERVICE;</span><br><span class="line">	<span class="keyword">if</span>(name &amp;&amp; name[<span class="number">0</span>]) svcname = name;</span><br><span class="line"></span><br><span class="line">	schService = OpenService(hscm, svcname, DELETE);</span><br><span class="line">    <span class="keyword">if</span> (schService == <span class="literal">NULL</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		OutputString(<span class="string">"OpenService(%s) error %d"</span>, svcname, rc = GetLastError() ); </span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (!DeleteService(schService) ) </span><br><span class="line">	&#123;</span><br><span class="line">		OutputString(<span class="string">"OpenService(%s) error %d"</span>, svcname, rc = GetLastError() ); </span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	OutputString(<span class="string">"DeleteService(%s) SUCCESS."</span>, svcname); </span><br><span class="line">	&#125;__except(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		OutputString(<span class="string">"Exception Catched 0x%X"</span>, GetExceptionCode());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    CloseServiceHandle(schService); </span><br><span class="line">    CloseServiceHandle(hscm);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line">used to uninstall by rundll32.exe</span><br><span class="line">Platform SDK: Tools - Rundll32</span><br><span class="line">The Run DLL utility (Rundll32.exe) included in Windows enables you to call functions exported from a 32-bit DLL. These functions must have the following syntax:</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> CALLBACK <span class="title">RundllUninstallA</span><span class="params">(</span><br><span class="line">  HWND hwnd,        <span class="comment">// handle to owner window</span></span><br><span class="line">  HINSTANCE hinst,  <span class="comment">// instance handle for the DLL</span></span><br><span class="line">  <span class="keyword">char</span> *param,		<span class="comment">// string the DLL will parse</span></span><br><span class="line">  <span class="keyword">int</span> nCmdShow      <span class="comment">// show state</span></span><br><span class="line">)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	UninstallService(param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//output the debug infor into log file &amp; DbgPrint</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OutputString</span><span class="params">( <span class="keyword">char</span> *lpFmt, ... )</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buff[<span class="number">1024</span>];</span><br><span class="line">	va_list	arglist;</span><br><span class="line">	va_start( arglist, lpFmt );</span><br><span class="line">	_vsnprintf( buff, <span class="keyword">sizeof</span> buff, lpFmt, arglist );</span><br><span class="line">	va_end( arglist );</span><br><span class="line"></span><br><span class="line">	DWORD len;</span><br><span class="line">	HANDLE herr = GetStdHandle(STD_OUTPUT_HANDLE);</span><br><span class="line">	<span class="keyword">if</span>(herr != INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		WriteFile(herr, buff, <span class="built_in">strlen</span>(buff), &amp;len, <span class="literal">NULL</span>);</span><br><span class="line">		WriteFile(herr, <span class="string">"\r\n"</span>, <span class="number">2</span>, &amp;len, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		FILE *fp = fopen(<span class="string">"SvcHost.DLL.log"</span>, <span class="string">"a"</span>);</span><br><span class="line">		<span class="keyword">if</span>(fp)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">char</span> date[<span class="number">20</span>], time[<span class="number">20</span>];</span><br><span class="line">			<span class="built_in">fprintf</span>(fp, <span class="string">"%s %s - %s\n"</span>, _strdate(date), _strtime(time), buff);</span><br><span class="line">			<span class="keyword">if</span>(!<span class="built_in">stderr</span>) fclose(fp);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	OutputDebugString(buff);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      

        
          <div class="alignleft post-nav">
            <em>上一篇: </em><a href="/2015/12/17/Tools/FLARE-IDA-Pro-msdn/">火眼（FireEye）实验室FLARE IDA Pro脚本系列：MSDN注释插件----实践</a>
          </div>
        
        
          <div class="alignright post-nav">
            <em>下一篇: </em><a href="/2015/10/30/Learning/Http-Protocl-learn/">Http协议初学</a>
          </div>
          <div class="clearfix"></div>
        

        
          <div class="copyright">
            
              <span class="claim">转载请注明youngroe.com</span>
            
            
              <span class="from-link">
                <em>本文链接地址:</em>
                <a href="/2015/11/20/Learning/windowservices/">
                  http://www.youngroe.com/2015/11/20/Learning/windowservices/
                </a>
              </span>
            
          </div>
        
        
  
  <div class="categories">
    <a href="/categories/Learning/">Learning</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Windows/">Windows</a>, <a href="/tags/服务/">服务</a>
  </div>

        
          <! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           ↑<br>
           欣赏此文？求鼓励，求支持！
        </span>
        <br>
      </div>  
    <div id="donate_guide" class="donate_bar center hidden" >
        <!-- 方式一： 
            ![](/img/Alipay.jpg)
            ![](/img/WeChatpay.jpg)
        -->
        <!-- 方式二；
            step1：在_config.yml中添加配置
                Alipay: /img/Alipay.jpg
                WeChatpay: /img/WeChatpay.jpg
            step2：此处两张图片的路径分别设置为如下
                <img src="undefined"
                <img src="undefined"
        -->
        <!-- 支付宝打赏图案 -->
        <img src="/img/Alipay.png" alt="支付宝打赏">
        <!-- 微信打赏图案 -->
        <img src="/img/WeChatpay.png" alt="微信打赏">
    </div>
    <script type="text/javascript">
        document.getElementById('btn_donate').onclick = function(){
            $('#donate_board').addClass('hidden');
            $('#donate_guide').removeClass('hidden');
        }
    </script>
</div>
<! -- 添加捐赠图标 -->
        
        <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
  clientID: '503c39aa3fb2b8c1b734',
  clientSecret: '65d784ff7a95a9dbf4a4208c9e32166ca29654f2',
  repo: 'geemion.github.io',
  owner: 'geemion',
  admin: 'geemion',
  pagerDirection:'first',
  id: md5(window.location.pathname)
})

gitalk.render('gitalk-container')
</script>
      
      <div class="clearfix"></div>
    </footer>
  </div>
  <div id="container"></div>
</span>
</article>


<section id="comment">
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Cybersecurity/">Cybersecurity</a><small>1</small></li>
  
    <li><a href="/categories/Debug/">Debug</a><small>7</small></li>
  
    <li><a href="/categories/Kernel/">Kernel</a><small>4</small></li>
  
    <li><a href="/categories/Learning/">Learning</a><small>8</small></li>
  
    <li><a href="/categories/Life/">Life</a><small>5</small></li>
  
    <li><a href="/categories/Others/">Others</a><small>1</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>6</small></li>
  
    <li><a href="/categories/Vulnerabilities/">Vulnerabilities</a><small>0</small></li>
  
    <li><a href="/categories/Windows/">Windows</a><small>13</small></li>
  
    <li><a href="/categories/life/">life</a><small>0</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2020/08/02/uncategorized/dns_hijacking/"></a>
      </li>
    
      <li>
        <a href="/2019/07/01/Windows/delphi_reverse_summary/">Delphi程序逆向反汇编技巧小记</a>
      </li>
    
      <li>
        <a href="/2019/06/25/Kernel/kernel_enum_wfp_callout_function/">Windows内核重拾：如何枚举系统中Windows Filtering Platform (WFP)驱动中的callout函数</a>
      </li>
    
      <li>
        <a href="/2019/05/06/Kernel/windows-driver-testing-basics/">Windows内核重拾：Windows驱动测试基础：工具、功能和示例（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2019/04/06/Windows/how-to-reverse-engineer-software-windows-in-a-right-way/">如何正确的对Windows软件进行逆向工程（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2019/01/12/Windows/a_crash_lead_deadlock/">Windows平台下一个崩溃而导致的死锁分析</a>
      </li>
    
      <li>
        <a href="/2018/12/01/Windows/windows_client_dns_over_https/">Windows客户端如何透明使用DNS-over-HTTPS</a>
      </li>
    
      <li>
        <a href="/2018/10/06/Cybersecurity/ddos-protection-techniques/">现代DDoS对抗技术概述（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2018/09/18/Life/xian/">西安周末游</a>
      </li>
    
      <li>
        <a href="/2018/01/06/Kernel/WindowsKernel_DebugObject/">Windows内核重拾：DebugObject</a>
      </li>
    
      <li>
        <a href="/2017/10/23/Tools/IDA-Pro-ClassInformer-Tutorial/">IDA Pro ClassInformer使用指南（翻译）</a>
      </li>
    
      <li>
        <a href="/2017/05/23/Windows/Kernel Data and Filtering Support/">Kernel Data and Filtering Support for Windows Server 2008（翻译）</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/ASM/" style="font-size: 10px;">ASM</a> <a href="/tags/Boost/" style="font-size: 10px;">Boost</a> <a href="/tags/DDoS/" style="font-size: 10px;">DDoS</a> <a href="/tags/DNS-over-HTTPS/" style="font-size: 10px;">DNS-over-HTTPS</a> <a href="/tags/Delphi/" style="font-size: 10px;">Delphi</a> <a href="/tags/Dll劫持/" style="font-size: 10px;">Dll劫持</a> <a href="/tags/GCC-GDB/" style="font-size: 10px;">GCC&GDB</a> <a href="/tags/GetVersionEx/" style="font-size: 10px;">GetVersionEx</a> <a href="/tags/Http/" style="font-size: 10px;">Http</a> <a href="/tags/IDA-Pro/" style="font-size: 13.33px;">IDA Pro</a> <a href="/tags/Linux/" style="font-size: 16.67px;">Linux</a> <a href="/tags/MSDN/" style="font-size: 13.33px;">MSDN</a> <a href="/tags/Malware/" style="font-size: 13.33px;">Malware</a> <a href="/tags/MiniDumpWriteDump/" style="font-size: 10px;">MiniDumpWriteDump</a> <a href="/tags/PEB/" style="font-size: 10px;">PEB</a> <a href="/tags/Procmon/" style="font-size: 10px;">Procmon</a> <a href="/tags/Runtime-Error/" style="font-size: 10px;">Runtime Error</a> <a href="/tags/SEH/" style="font-size: 10px;">SEH</a> <a href="/tags/SysinternalsSuite/" style="font-size: 10px;">SysinternalsSuite</a> <a href="/tags/Tips/" style="font-size: 10px;">Tips</a> <a href="/tags/UAC/" style="font-size: 10px;">UAC</a> <a href="/tags/UAF漏洞/" style="font-size: 10px;">UAF漏洞</a> <a href="/tags/VC/" style="font-size: 10px;">VC</a> <a href="/tags/Visual-Studio/" style="font-size: 13.33px;">Visual Studio</a> <a href="/tags/Windbg/" style="font-size: 10px;">Windbg</a> <a href="/tags/Windows/" style="font-size: 20px;">Windows</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/getaddrinfo/" style="font-size: 10px;">getaddrinfo</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/libeay32/" style="font-size: 10px;">libeay32</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/ndk/" style="font-size: 10px;">ndk</a> <a href="/tags/sublime-text3/" style="font-size: 10px;">sublime text3</a> <a href="/tags/x64/" style="font-size: 10px;">x64</a> <a href="/tags/体验/" style="font-size: 10px;">体验</a> <a href="/tags/内核/" style="font-size: 13.33px;">内核</a> <a href="/tags/内核结构/" style="font-size: 16.67px;">内核结构</a> <a href="/tags/安全机制/" style="font-size: 10px;">安全机制</a> <a href="/tags/异常处理/" style="font-size: 10px;">异常处理</a> <a href="/tags/提权/" style="font-size: 10px;">提权</a> <a href="/tags/服务/" style="font-size: 10px;">服务</a> <a href="/tags/权限/" style="font-size: 13.33px;">权限</a> <a href="/tags/栈溢出漏洞/" style="font-size: 10px;">栈溢出漏洞</a> <a href="/tags/测试/" style="font-size: 10px;">测试</a> <a href="/tags/漏洞调试/" style="font-size: 13.33px;">漏洞调试</a> <a href="/tags/生活/" style="font-size: 16.67px;">生活</a> <a href="/tags/脱壳/" style="font-size: 10px;">脱壳</a> <a href="/tags/西安/" style="font-size: 10px;">西安</a> <a href="/tags/计划/" style="font-size: 10px;">计划</a> <a href="/tags/读书/" style="font-size: 10px;">读书</a> <a href="/tags/调试/" style="font-size: 16.67px;">调试</a> <a href="/tags/转换/" style="font-size: 10px;">转换</a> <a href="/tags/进程/" style="font-size: 10px;">进程</a> <a href="/tags/逆向/" style="font-size: 10px;">逆向</a> <a href="/tags/重庆/" style="font-size: 10px;">重庆</a> <a href="/tags/驱动/" style="font-size: 16.67px;">驱动</a>
  </div>
</div>


  <div class="widget tag">
<h3 class="title">Links</h3>
<ul class="entry">
<li><a href="http://blog.ourren.com/" title="Ourren">Ourren</a></li>
<li><a href="http://www.hyjal.net/" title="Hyjal">Hyjal</a></li>
<li><a href="http://www.jianshu.com/users/fa15f4e416ae/latest_articles" title="Daemonceltics">Daemonceltics</a></li>
<li><a href="http://papap.info/" title="isee">isee</a></li>
</ul>
</div>

  <script type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=putG&d=yoFnN6V-ovhL-H4e9_69LvkTiX4uX7rEYJ15yL3G1Wg"></script>
</aside>
    <div class="clearfix"></div>
  </div>
  <div id="go-pg-top"><i class="icon-arrow-up"></i></div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2020 Lyon
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/page.js"></script>

</body>

</html>