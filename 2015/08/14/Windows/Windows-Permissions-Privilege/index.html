<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Windows权限机制学习 | Lyon&#39;s blog</title>
  <meta name="author" content="Lyon">
  
  <meta name="description" content="Walk steps step by step">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Windows权限机制学习"/>
  <meta property="og:site_name" content="Lyon&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  #<link href="/favicon.ico" rel="icon">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Lyon&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="/js/jquery.min.js"></script>
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?1d807422614f63c8de98cdc3b546860c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
  <script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
    
  <script data-ad-client="ca-pub-6317609007693835" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>


<body>
  <!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0027_Simplified Chinese.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Lyon&#39;s blog</a></h1>
  <h2><a href="/">I hear and I forget.I see and I remember.I do and I understand.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/about">关于</a></li>
    
	<li> <a href="/atom.xml">RSS</a> </li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      
        <img src="/img/Privilege.jpg">
      
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2015-08-14T08:05:45.000Z"><a href="/2015/08/14/Windows/Windows-Permissions-Privilege/">2015-08-14</a></time>
      
      
  
    <h1 class="title">Windows权限机制学习</h1>
  

    </header>
	
<!-- Table of Contents -->

  <div id="toc" class="toc-article">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#对windows权限机制最直观的认识"><span class="toc-number">1.</span> <span class="toc-text">对windows权限机制最直观的认识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows用户权限"><span class="toc-number">1.1.</span> <span class="toc-text">Windows用户权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启用某个权限及编程需要注意的地方"><span class="toc-number">1.2.</span> <span class="toc-text">启用某个权限及编程需要注意的地方</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#令牌TOKEN和安全描述符SD"><span class="toc-number">2.</span> <span class="toc-text">令牌TOKEN和安全描述符SD</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#令牌Token："><span class="toc-number">2.1.</span> <span class="toc-text">令牌Token：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安全描述符SD:"><span class="toc-number">2.2.</span> <span class="toc-text">安全描述符SD:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安全描述符SD的获取"><span class="toc-number">2.2.1.</span> <span class="toc-text">安全描述符SD的获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安全对象访问模型"><span class="toc-number">2.2.2.</span> <span class="toc-text">安全对象访问模型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于令牌TOKEN和安全描述符SD总结："><span class="toc-number">2.3.</span> <span class="toc-text">关于令牌TOKEN和安全描述符SD总结：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#向TOKEN中添加特权"><span class="toc-number">3.</span> <span class="toc-text">向TOKEN中添加特权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后记更新"><span class="toc-number">4.</span> <span class="toc-text">后记更新</span></a></li></ol>
  </div>


	
    <div class="entry">
      
        <p>参考资料：<br><a href="http://bbs.pediy.com/showthread.php?t=173381" target="_blank" rel="external">【原创】白话windows之 访问控制模型(Access Control Model)</a><br><a href="http://www.cppblog.com/weiym/archive/2013/08/25/202751.html?opt=admin" target="_blank" rel="external">浅析Windows安全相关的一些概念</a><br><a href="http://blog.csdn.net/gwzz1228/article/details/9031835" target="_blank" rel="external">CreateEvent 和OpenEvent时事件全局名称问题 Global</a></p>
<h2 id="对windows权限机制最直观的认识">对windows权限机制最直观的认识</h2><h3 id="Windows用户权限">Windows用户权限</h3><p>在之前的学习中对于windows权限机制有过零散的学习，但是对于整个windows权限管理机制没有一个全面的认识所以在这总结学习哈，虽然现在也没有搞清楚完。</p>
<p>Windows权限管理我觉得最常用的就是UAC权限（管理员权限）。每个进程都有自己的用户最常用的有标准用户、管理员（UAC）【注：这两个就是平常用户启用的进程的用户】，SYSTEM、LOCAL SERVICE、NETWORK SERVICE【注：这三个一般是系统进程及服务启动的且Windows启动后system用户已经登录到系统 】。而每个用户又有不同的特权Privilege，我们可以通过whoami -all查看当前用户所拥有的Privilege。</p>
<p><strong>Standard用户拥有的特权</strong><br><a id="more"></a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">用户信息</span><br><span class="line">----------------</span><br><span class="line">用户名         SID                                          </span><br><span class="line">============== =============================================</span><br><span class="line">xxxxx-pc\xxxxx S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">807732083</span>-<span class="number">3364155347</span>-<span class="number">3611615347</span>-<span class="number">1000</span></span><br><span class="line"></span><br><span class="line">组信息</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">组名                                      类型   SID                                                                                                         属性                          </span><br><span class="line">========================================= ====== =========================================================================================================== ==============================</span><br><span class="line">Mandatory Label\Medium Mandatory Level    标签   S-<span class="number">1</span>-<span class="number">16</span>-<span class="number">8192</span>                                                                                                                               </span><br><span class="line">Everyone                                  已知组 S-<span class="number">1</span>-<span class="number">1</span>-<span class="number">0</span>                                                                                                     必需的组, 启用于默认, 启用的组</span><br><span class="line">NT AUTHORITY\本地帐户和管理员组成员       已知组 S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">114</span>                                                                                                   只用于拒绝的组                </span><br><span class="line">xxxxx-PC\HelpLibraryUpdaters              别名   S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">807732083</span>-<span class="number">3364155347</span>-<span class="number">3611615347</span>-<span class="number">1005</span>                                                               必需的组, 启用于默认, 启用的组</span><br><span class="line">xxxxx-PC\HomeUsers                        别名   S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">807732083</span>-<span class="number">3364155347</span>-<span class="number">3611615347</span>-<span class="number">1007</span>                                                               必需的组, 启用于默认, 启用的组</span><br><span class="line">BUILTIN\Administrators                    别名   S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">32</span>-<span class="number">544</span>                                                                                                只用于拒绝的组                </span><br><span class="line">BUILTIN\Performance Log Users             别名   S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">32</span>-<span class="number">559</span>                                                                                                必需的组, 启用于默认, 启用的组</span><br><span class="line">BUILTIN\Users                             别名   S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">32</span>-<span class="number">545</span>                                                                                                必需的组, 启用于默认, 启用的组</span><br><span class="line">NT AUTHORITY\INTERACTIVE                  已知组 S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">4</span>                                                                                                     必需的组, 启用于默认, 启用的组</span><br><span class="line">CONSOLE LOGON                             已知组 S-<span class="number">1</span>-<span class="number">2</span>-<span class="number">1</span>                                                                                                     必需的组, 启用于默认, 启用的组</span><br><span class="line">NT AUTHORITY\Authenticated Users          已知组 S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">11</span>                                                                                                    必需的组, 启用于默认, 启用的组</span><br><span class="line">NT AUTHORITY\This Organization            已知组 S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">15</span>                                                                                                    必需的组, 启用于默认, 启用的组</span><br><span class="line">MicrosoftAccount\xxxxxx@hotmail.com 用户   S-<span class="number">1</span>-<span class="number">11</span>-<span class="number">96</span>-<span class="number">3623454863</span>-<span class="number">58364</span>-<span class="number">18864</span>-<span class="number">2661722203</span>-<span class="number">1597581903</span>-<span class="number">1104678397</span>-<span class="number">164429628</span>-<span class="number">127097849</span>-<span class="number">1926226238</span>-<span class="number">1128639863</span> 必需的组, 启用于默认, 启用的组</span><br><span class="line">NT AUTHORITY\本地帐户                     已知组 S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">113</span>                                                                                                   必需的组, 启用于默认, 启用的组</span><br><span class="line">LOCAL                                     已知组 S-<span class="number">1</span>-<span class="number">2</span>-<span class="number">0</span>                                                                                                     必需的组, 启用于默认, 启用的组</span><br><span class="line">NT AUTHORITY\云帐户身份验证               已知组 S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">64</span>-<span class="number">36</span>                                                                                                 必需的组, 启用于默认, 启用的组</span><br><span class="line"></span><br><span class="line">特权信息</span><br><span class="line">----------------------</span><br><span class="line">特权名                        描述                 状态  </span><br><span class="line">============================= ==================== ======</span><br><span class="line">SeShutdownPrivilege           关闭系统             已禁用</span><br><span class="line">SeChangeNotifyPrivilege       绕过遍历检查         已启用</span><br><span class="line">SeUndockPrivilege             从扩展坞上取下计算机 已禁用</span><br><span class="line">SeIncreaseWorkingSetPrivilege 增加进程工作集       已禁用</span><br><span class="line">SeTimeZonePrivilege           更改时区             已禁用</span><br></pre></td></tr></table></figure></p>
<p><strong>UAC用户权限</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">用户信息</span><br><span class="line">----------------</span><br><span class="line">用户名         SID                                          </span><br><span class="line">============== =============================================</span><br><span class="line">xxxxx-pc\xxxxx S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">807732083</span>-<span class="number">3364155347</span>-<span class="number">3611615347</span>-<span class="number">1000</span></span><br><span class="line">组信息</span><br><span class="line">-----------------</span><br><span class="line">组名                                      类型   SID                                                                                                         属性                                  </span><br><span class="line">========================================= ====== =========================================================================================================== ==========================================</span><br><span class="line">Mandatory Label\High Mandatory Level      标签   S-<span class="number">1</span>-<span class="number">16</span>-<span class="number">12288</span>                                                                                                                                          </span><br><span class="line">Everyone                                  已知组 S-<span class="number">1</span>-<span class="number">1</span>-<span class="number">0</span>                                                                                                     必需的组, 启用于默认, 启用的组            </span><br><span class="line">NT AUTHORITY\本地帐户和管理员组成员       已知组 S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">114</span>                                                                                                   必需的组, 启用于默认, 启用的组        </span><br><span class="line">xxxxx-PC\HelpLibraryUpdaters              别名   S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">807732083</span>-<span class="number">3364155347</span>-<span class="number">3611615347</span>-<span class="number">1005</span>                                                               必需的组, 启用于默认, 启用的组            </span><br><span class="line">xxxxx-PC\HomeUsers                        别名   S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">807732083</span>-<span class="number">3364155347</span>-<span class="number">3611615347</span>-<span class="number">1007</span>                                                               必需的组, 启用于默认, 启用的组            </span><br><span class="line">BUILTIN\Administrators                    别名   S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">32</span>-<span class="number">544</span>                                                                                                必需的组, 启用于默认, 启用的组, 组的所有者</span><br><span class="line">BUILTIN\Performance Log Users             别名   S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">32</span>-<span class="number">559</span>                                                                                                必需的组, 启用于默认, 启用的组         </span><br><span class="line">BUILTIN\Users                             别名   S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">32</span>-<span class="number">545</span>                                                                                                必需的组, 启用于默认, 启用的组            </span><br><span class="line">NT AUTHORITY\INTERACTIVE                  已知组 S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">4</span>                                                                                                     必需的组, 启用于默认, 启用的组            </span><br><span class="line">CONSOLE LOGON                             已知组 S-<span class="number">1</span>-<span class="number">2</span>-<span class="number">1</span>                                                                                                     必需的组, 启用于默认, 启用的组            </span><br><span class="line">NT AUTHORITY\Authenticated Users          已知组 S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">11</span>                                                                                                    必需的组, 启用于默认, 启用的组            </span><br><span class="line">NT AUTHORITY\This Organization            已知组 S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">15</span>                                                                                                    必需的组, 启用于默认, 启用的组            </span><br><span class="line">MicrosoftAccount\xxxxxx@hotmail.com 用户   S-<span class="number">1</span>-<span class="number">11</span>-<span class="number">96</span>-<span class="number">3623454863</span>-<span class="number">58364</span>-<span class="number">18864</span>-<span class="number">2661722203</span>-<span class="number">1597581903</span>-<span class="number">1104678397</span>-<span class="number">164429628</span>-<span class="number">127097849</span>-<span class="number">1926226238</span>-<span class="number">1128639863</span> 必需的组, 启用于默认, 启用的组            </span><br><span class="line">NT AUTHORITY\本地帐户                     已知组 S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">113</span>                                                                                                   必需的组, 启用于默认, 启用的组            </span><br><span class="line">LOCAL                                     已知组 S-<span class="number">1</span>-<span class="number">2</span>-<span class="number">0</span>                                                                                                     必需的组, 启用于默认, 启用的组            </span><br><span class="line">NT AUTHORITY\云帐户身份验证               已知组 S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">64</span>-<span class="number">36</span>                                                                                                 必需的组, 启用于默认, 启用的组     </span><br><span class="line"></span><br><span class="line">特权信息</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">特权名                          描述                                                                                       状态  </span><br><span class="line">=============================== ==========================                                                                ======</span><br><span class="line">SeIncreaseQuotaPrivilege        为进程调整内存配额         																  已禁用</span><br><span class="line">SeSecurityPrivilege             管理审核和安全日志         																  已禁用</span><br><span class="line">SeTakeOwnershipPrivilege        取得文件或其他对象的所有权 																  已禁用</span><br><span class="line">SeLoadDriverPrivilege           加载和卸载设备驱动程序    																  已禁用</span><br><span class="line">SeSystemProfilePrivilege        配置文件系统性能															              已禁用</span><br><span class="line">SeSystemtimePrivilege           更改系统时间															                  已禁用</span><br><span class="line">SeProfileSingleProcessPrivilege 配置文件单一进程 																          已禁用</span><br><span class="line">SeIncreaseBasePriorityPrivilege 提高计划优先级 																              已禁用</span><br><span class="line">SeCreatePagefilePrivilege       创建一个页面文件 															              已禁用</span><br><span class="line">SeBackupPrivilege               备份文件和目录           																  已禁用</span><br><span class="line">SeRestorePrivilege              还原文件和目录          															      已禁用</span><br><span class="line">SeShutdownPrivilege             关闭系统                 															      已禁用</span><br><span class="line">SeDebugPrivilege                调试程序，直接影响能够打开系统进程如winlogin.exe并调试 					                  已禁用</span><br><span class="line">SeSystemEnvironmentPrivilege    修改固件环境值          															      已禁用</span><br><span class="line">SeChangeNotifyPrivilege         绕过遍历检查  																              已启用</span><br><span class="line">SeRemoteShutdownPrivilege       从远程系统强制关机   																      已禁用</span><br><span class="line">SeUndockPrivilege               从扩展坞上取下计算机  																      已禁用</span><br><span class="line">SeManageVolumePrivilege         执行卷维护任务 																              已禁用</span><br><span class="line">SeImpersonatePrivilege          身份验证后模拟客户端，要想设置线程的模仿令牌，就要有该权限						          已启用</span><br><span class="line">SeCreateGlobalPrivilege         创建全局对象，这个特权直接影响到你可不可以创建一个有名字的全局事件、互斥量、内存区等。    已启用</span><br><span class="line">SeIncreaseWorkingSetPrivilege   增加进程工作集 																              已禁用</span><br><span class="line">SeTimeZonePrivilege             更改时区         																          已禁用</span><br><span class="line">SeCreateSymbolicLinkPrivilege   创建符号链接      																          已禁用</span><br><span class="line"></span><br><span class="line">-----------------------完整的Privilege列表------------------------------</span><br><span class="line">//每个特权的详细介绍可以查看深入解析Windows操作系统（第<span class="number">6</span>版）p529</span><br><span class="line">SeAssignPrimaryTokenPrivilege   </span><br><span class="line">SeAuditPrivilege</span><br><span class="line">SeBackupPrivilege</span><br><span class="line">SeChangeNotifyPrivilege</span><br><span class="line">SeCreateGlobalPrivilege</span><br><span class="line">SeCreatePagefilePrivilege</span><br><span class="line">SeCreatePermanentPrivilege</span><br><span class="line">SeCreateSymbolicLinkPrivilege</span><br><span class="line">SeCreateTokenPrivilege</span><br><span class="line">SeDebugPrivilege</span><br><span class="line">SeEnableDelegationPrivilege</span><br><span class="line">SeImpersonatePrivilege</span><br><span class="line">SeIncreaseBasePriorityPrivilege</span><br><span class="line">SeIncreaseQuotaPrivilege</span><br><span class="line">SeIncreaseWorkingSetPrivilege</span><br><span class="line">SeLoadDriverPrivilege</span><br><span class="line">SeLockMemoryPrivilege</span><br><span class="line">SeMachineAccountPrivilege</span><br><span class="line">SeManageVolumePrivilege</span><br><span class="line">SeProfileSingleProcessPrivilege</span><br><span class="line">SeRelabelPrivilege</span><br><span class="line">SeRemoteShutdownPrivilege</span><br><span class="line">SeRestorePrivilege</span><br><span class="line">SeSecurityPrivilege</span><br><span class="line">SeShutdownPrivilege</span><br><span class="line">SeSyncAgentPrivilege</span><br><span class="line">SeSystemEnvironmentPrivilege</span><br><span class="line">SeSystemProfilePrivilege</span><br><span class="line">SeSystemtimePrivilege</span><br><span class="line">SeTakeOwnershipPrivilege</span><br><span class="line">SeTcbPrivilege</span><br><span class="line">SeTimeZonePrivilege</span><br><span class="line">SeTrustedCredManAccessPrivilege</span><br><span class="line">SeUndockPrivilege</span><br><span class="line">SeUnsolicitedInputPrivilege</span><br></pre></td></tr></table></figure>
<p>其他用户的信息和上面类似，可以看到标准用户和经过权限提升的UAC用户信息的差别。用户名项中组信息和sid均相同，区别就是UAC用户是经过权限提升的，最终体现在权限上的不同如下：</p>
<ul>
<li>1.组信息项中主要是Integrity levels (IL)【进程完整性级别不同】。标准用户是Medium Mandatory Level，UAC用户是High Mandatory Level,它包括Untrust， Low， Medium， Hight， System等， 级别越低，权限也就越低。我们可以通过GetTokenInformation的TokenIntegrityLevel来进行查询。</li>
<li>2.体现在Privilege中的就是UAC用户拥有很多Privilege，比如最常用的SeDebugPrivilege 。</li>
</ul>
<p><strong>注释：</strong><br>进程完整性级别是为了保证不同标签的进程（TOKEN) 和对象（SACL)之间的访问安全，如果当前进程的TOKEN 是Low Mandatory Level， 它就不能修改具有Medium Mandatory Level的对象，即使我们对象的DACL赋予完全读写的权限。当每个进程打开对象， 我们会进行SACL和DACL检查，这个检查通过核心态函数<br>SeAccessCheck . 只有当前进程TOKEN的　完整性标签　高于或者等于　对象的完整性标，　我们才会进一步进行 DACL 检查。如果完整性标签验证通不过。 即使DACL给予再高权限都无济于事。<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb530716(v=vs.85" target="_blank" rel="external">各种特权的简单介绍可以看这里</a>.aspx)</p>
<h3 id="启用某个权限及编程需要注意的地方">启用某个权限及编程需要注意的地方</h3><p><strong>启用某个权限</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AdjustPrivilege.cpp : 定义控制台应用程序的入口点。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"stdafx.h"</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;locale.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printError</span><span class="params">( TCHAR* msg )</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	DWORD eNum;</span><br><span class="line">	TCHAR sysMsg[<span class="number">256</span>];</span><br><span class="line">	TCHAR* p;</span><br><span class="line"></span><br><span class="line">	eNum = GetLastError( );</span><br><span class="line">	FormatMessage( FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_IGNORE_INSERTS,</span><br><span class="line">		<span class="literal">NULL</span>, eNum,</span><br><span class="line">		MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), <span class="comment">// Default language   SUBLANG_DEFAULT SUBLANG_SYS_DEFAULT  SUBLANG_ENGLISH_US</span></span><br><span class="line">		sysMsg, <span class="number">256</span>, <span class="literal">NULL</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Trim the end of the line and terminate it with a null</span></span><br><span class="line">	p = sysMsg;</span><br><span class="line">	<span class="keyword">while</span>( ( *p &gt; <span class="number">31</span> ) || ( *p == <span class="number">9</span> ) )</span><br><span class="line">		++p;</span><br><span class="line">	<span class="keyword">do</span> &#123; *p-- = <span class="number">0</span>; &#125; <span class="keyword">while</span>( ( p &gt;= sysMsg ) &amp;&amp;</span><br><span class="line">		( ( *p == <span class="string">'.'</span> ) || ( *p &lt; <span class="number">33</span> ) ) );</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Solve _tprintf print chinese  Garbled</span></span><br><span class="line">	setlocale(LC_ALL,<span class="string">"chs"</span>);</span><br><span class="line">	<span class="comment">// Display the message</span></span><br><span class="line">	_tprintf( TEXT(<span class="string">"\n  WARNING: %s failed with error %d (%s)"</span>), msg, eNum, sysMsg );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//************************************</span></span><br><span class="line"><span class="comment">// Method:    SetPrivilege</span></span><br><span class="line"><span class="comment">// FullName:  SetPrivilege</span></span><br><span class="line"><span class="comment">// Access:    public </span></span><br><span class="line"><span class="comment">// Returns:   BOOL</span></span><br><span class="line"><span class="comment">// Qualifier:</span></span><br><span class="line"><span class="comment">// Parameter: HANDLE hToken           通过 OpenProcessToken返回得到</span></span><br><span class="line"><span class="comment">// Parameter: LPCTSTR lpszPrivilege   要启用或则禁用的特权</span></span><br><span class="line"><span class="comment">// Parameter: BOOL bEnablePrivilege   启用/禁用</span></span><br><span class="line"><span class="comment">//************************************</span></span><br><span class="line"><span class="function">BOOL <span class="title">SetPrivilege</span><span class="params">(</span><br><span class="line">				  HANDLE hToken,          <span class="comment">// access token handle</span></span><br><span class="line">				  LPCTSTR lpszPrivilege,  <span class="comment">// name of privilege to enable/disable</span></span><br><span class="line">				  BOOL bEnablePrivilege   <span class="comment">// to enable or disable privilege</span></span><br><span class="line">				  )</span> </span><br><span class="line"></span>&#123;</span><br><span class="line">	BOOL bRet=FALSE;</span><br><span class="line">	TOKEN_PRIVILEGES tp;</span><br><span class="line">	LUID luid;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span> </span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span><br><span class="line">		typedef struct _TOKEN_PRIVILEGES &#123;</span><br><span class="line">　　    DWORD PrivilegeCount;</span><br><span class="line">　　    LUID_AND_ATTRIBUTES Privileges[];</span><br><span class="line">　　    &#125; TOKEN_PRIVILEGES, *PTOKEN_PRIVILEGES;</span><br><span class="line"></span><br><span class="line">        typedef struct _LUID_AND_ATTRIBUTES &#123;</span><br><span class="line">　　    LUID Luid;</span><br><span class="line">　　    DWORD Attributes;</span><br><span class="line">　　    &#125; LUID_AND_ATTRIBUTES, *PLUID_AND_ATTRIBUTES</span><br><span class="line">		 */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//Get LUID,通过特权名称查找特权的LUID</span></span><br><span class="line">		<span class="keyword">if</span> ( !LookupPrivilegeValue(</span><br><span class="line">		     <span class="literal">NULL</span>,           <span class="comment">//IN  特权所在的系统名称，NULL表示本地系统</span></span><br><span class="line">		     lpszPrivilege,  <span class="comment">//IN  特权名称</span></span><br><span class="line">		     &amp;luid ) )       <span class="comment">//OUT 取得的LUID</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		tp.PrivilegeCount = <span class="number">1</span>;           <span class="comment">//数组元素的个数,即要操作的LUID的个数</span></span><br><span class="line">		tp.Privileges[<span class="number">0</span>].Luid = luid;</span><br><span class="line">		<span class="keyword">if</span> (bEnablePrivilege)</span><br><span class="line">			tp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED; <span class="comment">//操作的类型</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			tp.Privileges[<span class="number">0</span>].Attributes = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// Enable the privilege or disable all privileges.</span></span><br><span class="line">		AdjustTokenPrivileges(</span><br><span class="line">			hToken,                     <span class="comment">//IN 令牌句柄</span></span><br><span class="line">			FALSE,                      <span class="comment">//IN 是否禁用所有特权，如为TRUE，则忽略NewState参数即不调整</span></span><br><span class="line">			&amp;tp,                        <span class="comment">//IN 调整为NewState结构定义的特权</span></span><br><span class="line">			<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES),   <span class="comment">//IN PreviousState 参数的字节大小</span></span><br><span class="line">			 (PTOKEN_PRIVILEGES) <span class="literal">NULL</span>,  <span class="comment">//OUT_OPT 调整之前的TOKEN_PRIVILEGES结构体指针</span></span><br><span class="line">			 (PDWORD) <span class="literal">NULL</span>) ;           <span class="comment">//OUT_OPT 返回的结构体的长度</span></span><br><span class="line">		<span class="keyword">if</span> (GetLastError() != ERROR_SUCCESS)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		bRet=TRUE;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Print</span><span class="params">(LPCSTR desc, LUID luid)</span>  </span><br><span class="line"></span>&#123;  </span><br><span class="line">	LARGE_INTEGER* pli = (LARGE_INTEGER*)&amp;luid;  </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%s%u\n"</span>,desc,pli-&gt;QuadPart);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetTokenInf</span><span class="params">(HANDLE hToken)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	DWORD dwRetLen=<span class="number">0</span>;</span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	BOOL GetTokenInformation(</span><br><span class="line">	HANDLE TokenHandle,                            // handle to access token</span><br><span class="line">	TOKEN_INFORMATION_CLASS TokenInformationClass, // token type</span><br><span class="line">	LPVOID TokenInformation,                       // buffer</span><br><span class="line">	DWORD TokenInformationLength,                  // size of buffer</span><br><span class="line">	PDWORD ReturnLength                            // required buffer size);</span><br><span class="line">	*/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span> </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//1.TokenSource  惯用方式先获取大小，再分配获取具体信息</span></span><br><span class="line">		TOKEN_SOURCE Tsource=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">		<span class="keyword">if</span> (!GetTokenInformation(hToken,TokenSource,&amp;Tsource,<span class="keyword">sizeof</span>(TOKEN_SOURCE),&amp;dwRetLen))</span><br><span class="line">		&#123;</span><br><span class="line">			printError(TEXT(<span class="string">"GetTokenInformation  TokenSource"</span>));</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"\n\tTOKEN-&gt;TokenSource\n"</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"\t\tTokenSource-&gt;SourceName:%s\n"</span>,Tsource.SourceName);</span><br><span class="line">		Print(<span class="string">"\t\tTokenSource-&gt;SourceIdentifier:"</span>,Tsource.SourceIdentifier);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//2.TokenStatistics  TokenId  AuthenticationId</span></span><br><span class="line">		TOKEN_STATISTICS Tstatistic=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">		<span class="keyword">if</span>(!GetTokenInformation(hToken, TokenStatistics, &amp;Tstatistic, <span class="keyword">sizeof</span>(TOKEN_STATISTICS), &amp;dwRetLen))  </span><br><span class="line">		&#123;  </span><br><span class="line">			printError(TEXT(<span class="string">"GetTokenInformation Tstatistic"</span>));</span><br><span class="line">			<span class="keyword">continue</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		Print(<span class="string">"\tTOKEN-&gt;TokenId:"</span>,Tstatistic.TokenId);</span><br><span class="line">		Print(<span class="string">"\tTOKEN-&gt;AuthenticationId:"</span>,Tstatistic.AuthenticationId);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"\tTOKEN-&gt;ParentTokenId:######\n"</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"\tTOKEN-&gt;ExpirationTime:%u\n"</span>,Tstatistic.ExpirationTime.QuadPart);</span><br><span class="line">		<span class="comment">//未完待续</span></span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">	HANDLE hToken;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(OpenProcessToken(</span><br><span class="line">		GetCurrentProcess(),        <span class="comment">//IN  要修改访问权限的进程句柄</span></span><br><span class="line">		TOKEN_ADJUST_PRIVILEGES,    <span class="comment">//IN  指定你要进行的操作类型</span></span><br><span class="line">		&amp;hToken))                   <span class="comment">//OUT 返回的访问令牌指针</span></span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//获取Token信息</span></span><br><span class="line">		GetTokenInf(hToken);</span><br><span class="line">		<span class="comment">//Enable权限</span></span><br><span class="line">		<span class="keyword">if</span> (!SetPrivilege(hToken,SE_DEBUG_NAME,TRUE))</span><br><span class="line">		&#123;</span><br><span class="line">			printError(TEXT(<span class="string">"SetPrivilege"</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		printError(TEXT(<span class="string">"OpenProcessToken"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//other way  Native api声明</span></span><br><span class="line">	<span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(_stdcall *_RtlAdjustPrivilege)</span><span class="params">(</span><br><span class="line">		                                       ULONG    Privilege,     <span class="comment">//[In] Privilege index to change</span></span><br><span class="line">											   BOOLEAN  Enable,       <span class="comment">// [In] If TRUE, then enable the privilege otherwise disable. </span></span><br><span class="line">											   BOOLEAN  CurrentThread,<span class="comment">// [In] If TRUE, then enable in calling thread, otherwise process.</span></span><br><span class="line">											   PBOOLEAN Enabled       <span class="comment">// [Out] Whether privilege was previously enabled or disabled. </span></span><br><span class="line">											 )</span></span>;</span><br><span class="line">	<span class="keyword">do</span> </span><br><span class="line">	&#123;</span><br><span class="line">		BOOLEAN bBefore;</span><br><span class="line">        <span class="preprocessor">#<span class="keyword">define</span>  MYSE_DEBUG_NAME <span class="number">0x14</span>   <span class="comment">//这里获得的其实就是SE_DEBUG_NAME LUID 可以通过LookupPrivilegeValue获得</span></span></span><br><span class="line">		<span class="keyword">int</span> nRet;</span><br><span class="line">		HMODULE hmodNtdll=LoadLibraryA(<span class="string">"ntdll.dll"</span>);</span><br><span class="line">		<span class="keyword">if</span> (!hmodNtdll)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		_RtlAdjustPrivilege pfnRtlAdjustPrivilege=(_RtlAdjustPrivilege)GetProcAddress(hmodNtdll,<span class="string">"RtlAdjustPrivilege"</span>);</span><br><span class="line">		<span class="keyword">if</span> (!pfnRtlAdjustPrivilege)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		nRet=pfnRtlAdjustPrivilege(MYSE_DEBUG_NAME,TRUE,TRUE,&amp;bBefore);</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意这段代码只是将某个Privilege启用，只有原来是Disable的权限才可以提成Enable，如果原来就没有这个权限，是提不上去的。所以在vista以后的系统中，当以标准用户运行时将会启用失败ERROR_NOT_ALL_ASSIGNED，因为标准用户根本就没有SE_DEBUG_NAME，当以UAC用户运行时没问题。所以我们在其他blog中看到的很多老代码中会使用类似的代码在xp下都会运行成功，但是在win7上就会运行失败并且很多代码没有对AdjustTokenPrivileges执行结果做出正确的判断导致我们会发现每个函数都执行成功但是最终功能没有执行成功。因此当我们使用open*函数返回错误5拒绝访问时，可能的错误就可能为进程完整性级别不够（UAC）、需要enable某个特权。如果觉得Enable一个权限比较麻烦也可以使用Native Api RtlAdjustPrivilege<a href="http://pengranxiang.iteye.com/blog/771038" target="_blank" rel="external">具体使用方法</a></p>
<p><strong>编程需要注意的地方</strong></p>
<ul>
<li>1.最小权限法则，之前写代码的时候想都不想就是ALL_ACCESS权限导致在标准用户下程序运行出错，当我们仅仅查询一个进程信息时只使用PROCESS_QUERY_INFORMATION|PROCESS_VM_READ权限就可以了,<a href="https://msdn.microsoft.com/en-us/library/ms684880" target="_blank" rel="external">关于Windows权限的详细信息</a></li>
<li>2.Manifest文件，使用好manifest文件这个在<a href="http://llly.co/tech/aboutVisual_Studio/" target="_blank" rel="external">Visual Studio使用备注</a>有介绍，asInvoker：默认选项，新的进程将简单地继承其父进程的访问令牌<br>highestAvailable：应用程序会选择该用户允许范围内尽可能高的权限。对于标准用户来说，该选项与asInvoker一样，而对于管理员来说，这就意味着请求Admin令牌。<br>requireAdministrator：应用程序需要Admin令牌。运行该程序时，标准用户将要输入管理员的用户名和密码，而管理员则要在弹出的确认对话框中进行确认。</li>
<li>3.明确自己的程序运行时的用户，是用户还是system或则说是session 0还是其他session。因为不同的用户的环境变量这些是不同的得到的路径是有差别的，这个可以参考<a href="http://blog.csdn.net/yockie/article/details/46446047" target="_blank" rel="external">System权限下进程遇到的问题以及如何降权启动进程</a>，注意认真看这篇文章的参考文章。</li>
<li><p>4.创建进程的API函数是CreateProcess，CreateProcess函数所创建的进程使用的访问令牌是当前登录用户的访问令牌。 此外还可以指定进程的用户。使用CreateProcessAsUser和CreateProcessWithTokenW等API函数，在创建前需要先得到用户的令牌，可以使用LogonUser登录用户（是否可以同时登录多个用户受操作系统版本限制），LogonUser函数用返回用户的令牌。 如果需要得到进程和线程的访问令牌，可以使用OpenProcessToken、OpenThreadToken等函数。获取令牌中的信息可以使用API函数GetTokenInformation。如果需要修改权限，可以使用AdjustTokenPrivileges等函数。</p>
</li>
<li><p><strong>5.其他需要注意的地方。。。。。暂时还没有后面再补</strong></p>
</li>
</ul>
<h2 id="令牌TOKEN和安全描述符SD">令牌TOKEN和安全描述符SD</h2><h3 id="令牌Token：">令牌Token：</h3><p>包含特权列表，是一个内核对象，存在于访问主体中。用于表示进程和线程上下文（貌似只有进程和线程拥有Token。进程必须拥有一个Token且为主令牌，可以从父进程处继承，也可以是后来设置的，使用NtSetInformationProcess，Class=ProcessAccessToken。线程可以拥有一个模仿令牌，不是必须的。）。包含特权和一些标识，成功登陆系统的用户，将由系统分配一个访问令牌，该用户创建的所有进程继承该令牌(其中包含此登录会话的安全信息)。Token可以分为两种：主Token和模拟Token。主Token是进程默认Token，模拟Token往往是线程为了执行某些任务模拟其他线程的Token，得到某些权限。</p>
<ul>
<li>access token主要包含这些信息：<br>   1.用户账户的Sid；<br>   2.用户所属组的Sid；<br>   3.登陆Sid标识当前登陆会话；<br>   4.用户和用户组特权列表；<br>   5.用户创建的进程的默认DACL；<br>   6.access token类型和来源；<br>   7.其他信息；</li>
<li>获取一个进程的令牌：通过API函数OpenProcessToken取得进程令牌BOOL WINAPI OpenProcessToken(<br>in HANDLE ProcessHandle, //进程句柄。通过GetCurrentProcess函数取得当前进程句柄<br>in DWORD DesiredAccess, //要对令牌进行何种操作。如TOKEN_ADJUST_PRIVILEGES用于调整权限<br>out PHANDLE TokenHandle //进程令牌句柄<br>);</li>
<li>与Token相关的结构体：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line">//在wrk中找到的定义</span><br><span class="line">typedef struct _TOKEN &#123;</span><br><span class="line">    TOKEN_SOURCE TokenSource;                           // Ro: 16-Bytes 用来分辨TOKEN来源，测试本地系统的是USER32【不是很明白】</span><br><span class="line"></span><br><span class="line">    LUID TokenId;                                       // Ro: 8-Bytes  标识此Token的LUID</span><br><span class="line">    LUID AuthenticationId;                              // Ro: 8-Bytes  系统登录的Logon Session id</span><br><span class="line">    LUID ParentTokenId;                                 // Ro: 8-Bytes  </span><br><span class="line">    LARGE_INTEGER ExpirationTime;                       // Ro: 8-Bytes  指示该令牌到期时间</span><br><span class="line">    PERESOURCE TokenLock;                               // Ro:</span><br><span class="line"></span><br><span class="line">    SEP_AUDIT_POLICY AuditPolicy;                       // RW: 8 bytes</span><br><span class="line"></span><br><span class="line">    // Each time the security information in a token is changed, thefollowing ID is changed.  Fields that cause this field to be</span><br><span class="line">    // updated are marked as (Mod) in their comment field.</span><br><span class="line"></span><br><span class="line">    LUID ModifiedId;                                    // Wr: 8-Bytes 标志令牌的每次修改，当token改变此值改变。可以作为安全上下文改变的标志</span><br><span class="line"></span><br><span class="line">    ULONG SessionId;                                    // Wr: 4-bytes  会话id,可以通过GetTokenInformation,将第二个参数指定成TokenSessionId来</span><br><span class="line">                                                                        查询,也可以通过 API ProcessIDToSessionID来获取</span><br><span class="line">    ULONG UserAndGroupCount;                            // Ro: 4-Bytes  </span><br><span class="line">    ULONG RestrictedSidCount;                           // Ro: 4-Bytes  </span><br><span class="line">    ULONG PrivilegeCount;                               // Ro: 4-Bytes  Privilege数量即拥有的Privilege有多少个  </span><br><span class="line">    ULONG VariableLength;                               // Ro: 4-Bytes</span><br><span class="line">    ULONG DynamicCharged;                               // Ro: 4-Bytes</span><br><span class="line"></span><br><span class="line">    ULONG DynamicAvailable;                             // Wr: 4-Bytes (Mod)</span><br><span class="line">    ULONG DefaultOwnerIndex;                            // Wr: 4-Bytes (Mod)</span><br><span class="line">    PSID_AND_ATTRIBUTES UserAndGroups;                  // Wr: 4-Bytes (Mod) 用户和组列表，GetTokenInformation, 将第二个参数指定成TokenInformationClass</span><br><span class="line">    PSID_AND_ATTRIBUTES RestrictedSids;                 // Ro: 4-Bytes       </span><br><span class="line">    PSID PrimaryGroup;                                  // Wr: 4-Bytes (Mod)</span><br><span class="line">    PLUID_AND_ATTRIBUTES Privileges;                    // Wr: 4-Bytes (Mod) Privilege列表，包含拥有的Privilege 的luid和Enable状态 </span><br><span class="line">    PULONG DynamicPart;                                 // Wr: 4-Bytes (Mod)</span><br><span class="line">    PACL DefaultDacl;                                   // Wr: 4-Bytes (Mod)</span><br><span class="line"></span><br><span class="line">    TOKEN_TYPE TokenType;                               // Ro: 1-Byte        标志该令牌是主令牌（1）还是模仿令牌</span><br><span class="line">    SECURITY_IMPERSONATION_LEVEL ImpersonationLevel;    // Ro: 1-Byte        当Token是模仿令牌时标志 Impersonation is the ability of a process </span><br><span class="line">                                                                             to take on the security attributes of another process.</span><br><span class="line"></span><br><span class="line">    UCHAR TokenFlags;                                   // Rw: 4-Bytes</span><br><span class="line">    BOOLEAN TokenInUse;                                 // Wr: 1-Byte</span><br><span class="line"></span><br><span class="line">    PSECURITY_TOKEN_PROXY_DATA ProxyData;               // Ro: 4-Bytes</span><br><span class="line">    PSECURITY_TOKEN_AUDIT_DATA AuditData;               // Ro: 4-Bytes</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    // Pointer to the referenced logon session. Protected by the token lock and only valid when TOKEN_SESSION_NOT_REFERENCED is clear.</span><br><span class="line">    PSEP_LOGON_SESSION_REFERENCES LogonSession;         // Rw: Ptr</span><br><span class="line"></span><br><span class="line">    // Originating information for allowing certain impersonation operations later</span><br><span class="line">    LUID OriginatingLogonSession ;                      // Rw: 8 bytes (set by LSA)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // This marks the beginning of the variable part of the token.It must follow all other fields in the token.</span><br><span class="line">    ULONG VariablePart;                                 // Wr: 4-Bytes (Mod)</span><br><span class="line"></span><br><span class="line">&#125; TOKEN, * PTOKEN;</span><br><span class="line"></span><br><span class="line">//用作唯一标志一个用户或组,每次当我们创建一个用户或一个组的时候，系统会分配给改用户或组一个唯一SID，当你重新安装系统后，</span><br><span class="line">//也会得到一个唯一的SID。SID是唯一的，不随用户的删除而分配到另外的用户使用。请记住，SID永远都是唯一的SIF是由计算机名、</span><br><span class="line">//当前时间、当前用户态线程的CPU耗费时间的总和三个参数决定以保证它的唯一性。</span><br><span class="line">typedef struct _SID_AND_ATTRIBUTES &#123;</span><br><span class="line">    PSID Sid;                         </span><br><span class="line">    ULONG Attributes;</span><br><span class="line">    &#125; SID_AND_ATTRIBUTES, * PSID_AND_ATTRIBUTES;</span><br><span class="line"></span><br><span class="line"> typedef struct _SID &#123;</span><br><span class="line">   UCHAR Revision;</span><br><span class="line">   UCHAR SubAuthorityCount;</span><br><span class="line">   SID_IDENTIFIER_AUTHORITY IdentifierAuthority;</span><br><span class="line">   ULONG SubAuthority[ANYSIZE_ARRAY];</span><br><span class="line">&#125; SID, *PISID;</span><br><span class="line"></span><br><span class="line">typedef struct _LUID_AND_ATTRIBUTES &#123;</span><br><span class="line">    LUID Luid;</span><br><span class="line">    ULONG Attributes;</span><br><span class="line">    &#125; LUID_AND_ATTRIBUTES, * PLUID_AND_ATTRIBUTES;</span><br><span class="line"></span><br><span class="line">typedef struct _ACL &#123;</span><br><span class="line">    UCHAR AclRevision;</span><br><span class="line">    UCHAR Sbz1;</span><br><span class="line">    USHORT AclSize;</span><br><span class="line">    USHORT AceCount;</span><br><span class="line">    USHORT Sbz2;</span><br><span class="line">&#125; ACL;</span><br><span class="line">typedef ACL *PACL;</span><br><span class="line"></span><br><span class="line">//查看exploprer.exe的token信息</span><br><span class="line">kd&gt; !process 0 1 explorer.exe</span><br><span class="line">PROCESS fffffa801b576b30</span><br><span class="line">    SessionId: 1  Cid: 0608    Peb: 7fffffdb000  ParentCid: 05e4</span><br><span class="line">    DirBase: 52384000  ObjectTable: fffff8a00097bf90  HandleCount: 659.</span><br><span class="line">    Image: explorer.exe</span><br><span class="line">    VadRoot fffffa801aa54170 Vads 380 Clone 0 Private 3163. Modified 320. Locked 0.</span><br><span class="line">    DeviceMap fffff8a000e30e00</span><br><span class="line">    Token                             fffff8a001780a90</span><br><span class="line">    ElapsedTime                       00:36:11.903</span><br><span class="line">    UserTime                          00:00:00.109</span><br><span class="line">    KernelTime                        00:00:00.249</span><br><span class="line">    QuotaPoolUsage[PagedPool]         0</span><br><span class="line">    QuotaPoolUsage[NonPagedPool]      0</span><br><span class="line">    Working Set Sizes (now,min,max)  (10818, 50, 345) (43272KB, 200KB, 1380KB)</span><br><span class="line">    PeakWorkingSetSize                11128</span><br><span class="line">    VirtualSize                       240 Mb</span><br><span class="line">    PeakVirtualSize                   270 Mb</span><br><span class="line">    PageFaultCount                    24534</span><br><span class="line">    MemoryPriority                    BACKGROUND</span><br><span class="line">    BasePriority                      8</span><br><span class="line">    CommitCharge                      5182</span><br><span class="line"></span><br><span class="line">kd&gt; !token fffff8a001780a90</span><br><span class="line">_TOKEN fffff8a001780a90</span><br><span class="line">TS Session ID: 0x1</span><br><span class="line">User: S-1-5-21-3849441531-517105982-2617860776-1000</span><br><span class="line">Groups: </span><br><span class="line"> 00 S-1-5-21-3849441531-517105982-2617860776-513</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 01 S-1-1-0</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 02 S-1-5-32-544</span><br><span class="line">    Attributes - Mandatory Default Enabled Owner </span><br><span class="line"> 03 S-1-5-32-545</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 04 S-1-5-4</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 05 S-1-2-1</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 06 S-1-5-11</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 07 S-1-5-15</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 08 S-1-5-5-0-85452</span><br><span class="line">    Attributes - Mandatory Default Enabled LogonId </span><br><span class="line"> 09 S-1-2-0</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 10 S-1-5-64-10</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 11 S-1-16-12288</span><br><span class="line">    Attributes - GroupIntegrity GroupIntegrityEnabled </span><br><span class="line">Primary Group: S-1-5-21-3849441531-517105982-2617860776-513</span><br><span class="line">Privs: </span><br><span class="line"> 05 0x000000005 SeIncreaseQuotaPrivilege          Attributes - </span><br><span class="line"> 08 0x000000008 SeSecurityPrivilege               Attributes - </span><br><span class="line"> 09 0x000000009 SeTakeOwnershipPrivilege          Attributes - </span><br><span class="line"> 10 0x00000000a SeLoadDriverPrivilege             Attributes - </span><br><span class="line"> 11 0x00000000b SeSystemProfilePrivilege          Attributes - </span><br><span class="line"> 12 0x00000000c SeSystemtimePrivilege             Attributes - </span><br><span class="line"> 13 0x00000000d SeProfileSingleProcessPrivilege   Attributes - </span><br><span class="line"> 14 0x00000000e SeIncreaseBasePriorityPrivilege   Attributes - </span><br><span class="line"> 15 0x00000000f SeCreatePagefilePrivilege         Attributes - </span><br><span class="line"> 17 0x000000011 SeBackupPrivilege                 Attributes - </span><br><span class="line"> 18 0x000000012 SeRestorePrivilege                Attributes - </span><br><span class="line"> 19 0x000000013 SeShutdownPrivilege               Attributes - </span><br><span class="line"> 20 0x000000014 SeDebugPrivilege                  Attributes - </span><br><span class="line"> 22 0x000000016 SeSystemEnvironmentPrivilege      Attributes - </span><br><span class="line"> 23 0x000000017 SeChangeNotifyPrivilege           Attributes - Enabled Default </span><br><span class="line"> 24 0x000000018 SeRemoteShutdownPrivilege         Attributes - </span><br><span class="line"> 25 0x000000019 SeUndockPrivilege                 Attributes - </span><br><span class="line"> 28 0x00000001c SeManageVolumePrivilege           Attributes - </span><br><span class="line"> 29 0x00000001d SeImpersonatePrivilege            Attributes - Enabled Default </span><br><span class="line"> 30 0x00000001e SeCreateGlobalPrivilege           Attributes - Enabled Default </span><br><span class="line"> 33 0x000000021 SeIncreaseWorkingSetPrivilege     Attributes - </span><br><span class="line"> 34 0x000000022 SeTimeZonePrivilege               Attributes - </span><br><span class="line"> 35 0x000000023 SeCreateSymbolicLinkPrivilege     Attributes - </span><br><span class="line">Authentication ID:         (0,14e51)</span><br><span class="line">Impersonation Level:       Anonymous</span><br><span class="line">TokenType:                 Primary</span><br><span class="line">Source: User32             TokenFlags: 0x2000 ( Token in use )</span><br><span class="line">Token ID: 1a469            ParentToken ID: 0</span><br><span class="line">Modified ID:               (0, 1a41a2)</span><br><span class="line">RestrictedSidCount: 0      RestrictedSids: 0000000000000000</span><br><span class="line">OriginatingLogonSession: 3e7</span><br></pre></td></tr></table></figure>
<ul>
<li>Token编程获取<br>具体代码，<a href="http://blog.csdn.net/xbgprogrammer/article/details/16818973" target="_blank" rel="external">参考1</a>,<a href="http://www.douban.com/note/364278668/" target="_blank" rel="external">参考2</a><br><a href="http://www.freebuf.com/articles/4546.html" target="_blank" rel="external">参考3</a><br><strong>Token注释：</strong><br>Access Token：是一个包含了登陆会话安全信息的 Windows 软件对象，用于指名一个用户以及他所在组以及相应的特权。<br>UAC Token：定义了Windows Vista 用户在UAC支持开启的时候的默认交互式登陆特权。一个 UAC Token 定义了最小的运行特权。<br>Full Token：给账户提供了最大的经过授权的特权。Full Token 实际上是由该用户隶属于的用户组决定的。</li>
</ul>
<h3 id="安全描述符SD:">安全描述符SD:</h3><p>安全描述符(sd)是访问控制模型的灵魂。所有的对象都拥有安全描述符，一般是在访问客体中器作用。包括Token内核对象,在对象上查看其属性。如文件，点击右键选择“属性”，找到“安全”选项卡，点击“高级”按钮。弹出的对话筐中，“权限”选项卡就是DACL，”审核”选项卡是SACL，“所有者”是Owner、Group。<br>Windows系统几乎所有的对象都有安全属性，包括文件、文件夹、注册表、线程同步对象、进程间通信对象、网络共享等，进程和线程也可以是其他进程的操作对象，所以进程和线程也是安全对象。在创建对象时都可以指定对象的安全属性，比如CreateFile、CreatePipe、CreateProcess、RegCreateKeyEx和RegSaveKeyEx等，SECURITY_ATTRIBUTES结构用于指定对象的安全属性。GetNamedSecurityInfo、GetSecurityInfo、 SetSecurityInfo、 SetKernelObjectSecurity、SetNamedSecurityInfo等API函数可以获取和设置对象的安全属性。对象的安全属性是以安全描述符(Security Descriptor)的形式存在的，安全描述符中包括了访问控制列表。<br>DACL是访问控制的关键,DACL中包括一个访问控制入口(AccessControl Entries，ACE)列表。ACE表明了用户（通过用户SID或用户组SID）是否能进行操作以及能进行哪种操作。在进行访问控制检测时，会依次检测DACL中的ACE，直到被允许或被拒绝</p>
<ul>
<li>Security Descriptor主要包含这些信息：<br>   1.对象所有者Sid；<br>   2.对象所有者组的Sid；<br>   3.选择访问控制列表DACL<br>   4.系统访问控制列表SACL<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wrk定义</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _SECURITY_DESCRIPTOR &#123;</span><br><span class="line">   UCHAR Revision;</span><br><span class="line">   UCHAR Sbz1;</span><br><span class="line">   SECURITY_DESCRIPTOR_CONTROL Control;</span><br><span class="line">   PSID Owner;                           <span class="comment">//</span></span><br><span class="line">   PSID Group;</span><br><span class="line">   PACL Sacl;                           <span class="comment">//系统访问控制列表，是用来做审计用的，一般不用关心</span></span><br><span class="line">   PACL Dacl;                           <span class="comment">//自主访问控制列表，记录了哪些用户可以(/不可以)以何种方式访问该对象</span></span><br><span class="line"></span><br><span class="line">   &#125; SECURITY_DESCRIPTOR, *PISECURITY_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">typedef</span> USHORT SECURITY_DESCRIPTOR_CONTROL, *PSECURITY_DESCRIPTOR_CONTROL;</span><br><span class="line"></span><br><span class="line"><span class="comment">//安全标志符</span></span><br><span class="line"> <span class="keyword">typedef</span> <span class="keyword">struct</span> _SID &#123;</span><br><span class="line">   UCHAR Revision;</span><br><span class="line">   UCHAR SubAuthorityCount;</span><br><span class="line">   SID_IDENTIFIER_AUTHORITY IdentifierAuthority;</span><br><span class="line">   ULONG SubAuthority[ANYSIZE_ARRAY];</span><br><span class="line">&#125; SID, *PISID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _SID_IDENTIFIER_AUTHORITY &#123;</span><br><span class="line">    UCHAR Value[<span class="number">6</span>];</span><br><span class="line">&#125; SID_IDENTIFIER_AUTHORITY, *PSID_IDENTIFIER_AUTHORITY;</span><br><span class="line"></span><br><span class="line"><span class="comment">//每一条ace构成条访问规则</span></span><br><span class="line"> <span class="keyword">typedef</span> <span class="keyword">struct</span> _ACL &#123;</span><br><span class="line">    UCHAR AclRevision;</span><br><span class="line">    UCHAR Sbz1;</span><br><span class="line">    USHORT AclSize;</span><br><span class="line">    USHORT AceCount;</span><br><span class="line">    USHORT Sbz2;</span><br><span class="line">&#125; ACL;</span><br><span class="line"><span class="keyword">typedef</span> ACL *PACL;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="安全描述符SD的获取">安全描述符SD的获取</h4><p>Windows提供了一系列的安全信息的存取，控制函数，如 GetNamedSecurityInfo, SetNamedSecurityInfo，GetSecurityInfo, SetSecurityInfo等。<a href="http://blog.csdn.net/xbgprogrammer/article/details/16818973" target="_blank" rel="external">详细信息</a></p>
<div align="center"><br><img src="/img/SD.png" width="776" height="416" alt="安全描述符SD" align="center"><br></div>

<h4 id="安全对象访问模型">安全对象访问模型</h4><p>当打开一个对象时，会从线程[访问者]所拥有的令牌中(如果存在模仿令牌则使用模仿令牌，否则使用主令牌)获取用户名和用户所在组列表，与对象[被访问者]的安全描述符中的DACL比较，这个时候会发生如下情况之一：</p>
<ul>
<li>对象的DACL==Null，则线程拥有完全的访问权限。</li>
<li>对象的DACL不为Null，但是AceCount ==0（ACE,访问控制项），则拒绝任何线程访问。</li>
<li>遍历DACL，找到跟令牌中用户或组一致的Ace，如果该Ace指明没有拥有制定的访问权限，则直接退出安全检查函数，并拒绝该线程访问。</li>
<li>遍历DACL，没找到跟令牌中用户或组一致的Ace，并拒绝该线程访问。</li>
<li>遍历DACL，找到跟令牌中用户或组一致的Ace，如果该Ace指明拥有制定的访问权限，则直接退出安全检查函数，并允许该线程访问。<br><a href="http://bbs.pediy.com/showthread.php?t=173381" target="_blank" rel="external">详细实例</a>,看这篇文章安全描述符部分</li>
</ul>
<h3 id="关于令牌TOKEN和安全描述符SD总结：">关于令牌TOKEN和安全描述符SD总结：</h3><p>1.进程及线程拥有TOKEN，其中主要包含两方面内容SID和特权Privilege。当一个进程[访问者]访问安全对象[被访问者]时，系统会根据被访问者的ACL说明那些用户(SID)能访问该安全对象，那些不能。而Privilege在访问某个具体的安全对象时并没有作用，Privilege是表示进程是否能够进行特定的系统操作，如关闭系统、修改系统时间、加载设备驱动等。</p>
<p>2.在Vista之后的系统，除了遵守传统的安全控制机制外[安全子系统把进程的访问令牌TOKEN和资源SD的访问控制列表进行匹配比较，以确认该进程是否具有访问该资源的权限]，还必须检查进程和资源对象的完整性级别，完整性级别低的进程，不能写入完整性级别高的资源对象。</p>
<h2 id="向TOKEN中添加特权">向TOKEN中添加特权</h2><p><a href="http://blog.csdn.net/yockie/article/details/17029293" target="_blank" rel="external">用户权限设置和进程权限提升</a></p>
<h2 id="后记更新">后记更新</h2><p><em>2016-01-08 这篇对Windows访问控制分析很不错</em><br><a href="http://drops.wooyun.org/tips/11803" target="_blank" rel="external">浅析Windows的访问权限检查机制</a></p>

      
    </div>
    <footer>
      

        
          <div class="alignleft post-nav">
            <em>上一篇: </em><a href="/2015/08/20/Windows/windows-Security-Mechanism/">Windows安全机制学习笔记</a>
          </div>
        
        
          <div class="alignright post-nav">
            <em>下一篇: </em><a href="/2015/08/14/Life/chongqing/">重庆印象</a>
          </div>
          <div class="clearfix"></div>
        

        
          <div class="copyright">
            
              <span class="claim">转载请注明youngroe.com</span>
            
            
              <span class="from-link">
                <em>本文链接地址:</em>
                <a href="/2015/08/14/Windows/Windows-Permissions-Privilege/">
                  http://www.youngroe.com/2015/08/14/Windows/Windows-Permissions-Privilege/
                </a>
              </span>
            
          </div>
        
        
  
  <div class="categories">
    <a href="/categories/Windows/">Windows</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Windows/">Windows</a>, <a href="/tags/内核结构/">内核结构</a>, <a href="/tags/权限/">权限</a>
  </div>

        
          <! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           ↑<br>
           欣赏此文？求鼓励，求支持！
        </span>
        <br>
      </div>  
    <div id="donate_guide" class="donate_bar center hidden" >
        <!-- 方式一： 
            ![](/img/Alipay.jpg)
            ![](/img/WeChatpay.jpg)
        -->
        <!-- 方式二；
            step1：在_config.yml中添加配置
                Alipay: /img/Alipay.jpg
                WeChatpay: /img/WeChatpay.jpg
            step2：此处两张图片的路径分别设置为如下
                <img src="undefined"
                <img src="undefined"
        -->
        <!-- 支付宝打赏图案 -->
        <img src="/img/Alipay.png" alt="支付宝打赏">
        <!-- 微信打赏图案 -->
        <img src="/img/WeChatpay.png" alt="微信打赏">
    </div>
    <script type="text/javascript">
        document.getElementById('btn_donate').onclick = function(){
            $('#donate_board').addClass('hidden');
            $('#donate_guide').removeClass('hidden');
        }
    </script>
</div>
<! -- 添加捐赠图标 -->
        
        <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
  clientID: '503c39aa3fb2b8c1b734',
  clientSecret: '65d784ff7a95a9dbf4a4208c9e32166ca29654f2',
  repo: 'geemion.github.io',
  owner: 'geemion',
  admin: 'geemion',
  pagerDirection:'first',
  id: md5(window.location.pathname)
})

gitalk.render('gitalk-container')
</script>
      
      <div class="clearfix"></div>
    </footer>
  </div>
  <div id="container"></div>
</span>
</article>


<section id="comment">
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Cybersecurity/">Cybersecurity</a><small>1</small></li>
  
    <li><a href="/categories/Debug/">Debug</a><small>7</small></li>
  
    <li><a href="/categories/Kernel/">Kernel</a><small>4</small></li>
  
    <li><a href="/categories/Learning/">Learning</a><small>8</small></li>
  
    <li><a href="/categories/Life/">Life</a><small>5</small></li>
  
    <li><a href="/categories/Others/">Others</a><small>1</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>6</small></li>
  
    <li><a href="/categories/Vulnerabilities/">Vulnerabilities</a><small>0</small></li>
  
    <li><a href="/categories/Windows/">Windows</a><small>13</small></li>
  
    <li><a href="/categories/life/">life</a><small>0</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2020/08/02/uncategorized/dns_hijacking/"></a>
      </li>
    
      <li>
        <a href="/2019/07/01/Windows/delphi_reverse_summary/">Delphi程序逆向反汇编技巧小记</a>
      </li>
    
      <li>
        <a href="/2019/06/25/Kernel/kernel_enum_wfp_callout_function/">Windows内核重拾：如何枚举系统中Windows Filtering Platform (WFP)驱动中的callout函数</a>
      </li>
    
      <li>
        <a href="/2019/05/06/Kernel/windows-driver-testing-basics/">Windows内核重拾：Windows驱动测试基础：工具、功能和示例（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2019/04/06/Windows/how-to-reverse-engineer-software-windows-in-a-right-way/">如何正确的对Windows软件进行逆向工程（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2019/01/12/Windows/a_crash_lead_deadlock/">Windows平台下一个崩溃而导致的死锁分析</a>
      </li>
    
      <li>
        <a href="/2018/12/01/Windows/windows_client_dns_over_https/">Windows客户端如何透明使用DNS-over-HTTPS</a>
      </li>
    
      <li>
        <a href="/2018/10/06/Cybersecurity/ddos-protection-techniques/">现代DDoS对抗技术概述（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2018/09/18/Life/xian/">西安周末游</a>
      </li>
    
      <li>
        <a href="/2018/01/06/Kernel/WindowsKernel_DebugObject/">Windows内核重拾：DebugObject</a>
      </li>
    
      <li>
        <a href="/2017/10/23/Tools/IDA-Pro-ClassInformer-Tutorial/">IDA Pro ClassInformer使用指南（翻译）</a>
      </li>
    
      <li>
        <a href="/2017/05/23/Windows/Kernel Data and Filtering Support/">Kernel Data and Filtering Support for Windows Server 2008（翻译）</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/ASM/" style="font-size: 10px;">ASM</a> <a href="/tags/Boost/" style="font-size: 10px;">Boost</a> <a href="/tags/DDoS/" style="font-size: 10px;">DDoS</a> <a href="/tags/DNS-over-HTTPS/" style="font-size: 10px;">DNS-over-HTTPS</a> <a href="/tags/Delphi/" style="font-size: 10px;">Delphi</a> <a href="/tags/Dll劫持/" style="font-size: 10px;">Dll劫持</a> <a href="/tags/GCC-GDB/" style="font-size: 10px;">GCC&GDB</a> <a href="/tags/GetVersionEx/" style="font-size: 10px;">GetVersionEx</a> <a href="/tags/Http/" style="font-size: 10px;">Http</a> <a href="/tags/IDA-Pro/" style="font-size: 13.33px;">IDA Pro</a> <a href="/tags/Linux/" style="font-size: 16.67px;">Linux</a> <a href="/tags/MSDN/" style="font-size: 13.33px;">MSDN</a> <a href="/tags/Malware/" style="font-size: 13.33px;">Malware</a> <a href="/tags/MiniDumpWriteDump/" style="font-size: 10px;">MiniDumpWriteDump</a> <a href="/tags/PEB/" style="font-size: 10px;">PEB</a> <a href="/tags/Procmon/" style="font-size: 10px;">Procmon</a> <a href="/tags/Runtime-Error/" style="font-size: 10px;">Runtime Error</a> <a href="/tags/SEH/" style="font-size: 10px;">SEH</a> <a href="/tags/SysinternalsSuite/" style="font-size: 10px;">SysinternalsSuite</a> <a href="/tags/Tips/" style="font-size: 10px;">Tips</a> <a href="/tags/UAC/" style="font-size: 10px;">UAC</a> <a href="/tags/UAF漏洞/" style="font-size: 10px;">UAF漏洞</a> <a href="/tags/VC/" style="font-size: 10px;">VC</a> <a href="/tags/Visual-Studio/" style="font-size: 13.33px;">Visual Studio</a> <a href="/tags/Windbg/" style="font-size: 10px;">Windbg</a> <a href="/tags/Windows/" style="font-size: 20px;">Windows</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/getaddrinfo/" style="font-size: 10px;">getaddrinfo</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/libeay32/" style="font-size: 10px;">libeay32</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/ndk/" style="font-size: 10px;">ndk</a> <a href="/tags/sublime-text3/" style="font-size: 10px;">sublime text3</a> <a href="/tags/x64/" style="font-size: 10px;">x64</a> <a href="/tags/体验/" style="font-size: 10px;">体验</a> <a href="/tags/内核/" style="font-size: 13.33px;">内核</a> <a href="/tags/内核结构/" style="font-size: 16.67px;">内核结构</a> <a href="/tags/安全机制/" style="font-size: 10px;">安全机制</a> <a href="/tags/异常处理/" style="font-size: 10px;">异常处理</a> <a href="/tags/提权/" style="font-size: 10px;">提权</a> <a href="/tags/服务/" style="font-size: 10px;">服务</a> <a href="/tags/权限/" style="font-size: 13.33px;">权限</a> <a href="/tags/栈溢出漏洞/" style="font-size: 10px;">栈溢出漏洞</a> <a href="/tags/测试/" style="font-size: 10px;">测试</a> <a href="/tags/漏洞调试/" style="font-size: 13.33px;">漏洞调试</a> <a href="/tags/生活/" style="font-size: 16.67px;">生活</a> <a href="/tags/脱壳/" style="font-size: 10px;">脱壳</a> <a href="/tags/西安/" style="font-size: 10px;">西安</a> <a href="/tags/计划/" style="font-size: 10px;">计划</a> <a href="/tags/读书/" style="font-size: 10px;">读书</a> <a href="/tags/调试/" style="font-size: 16.67px;">调试</a> <a href="/tags/转换/" style="font-size: 10px;">转换</a> <a href="/tags/进程/" style="font-size: 10px;">进程</a> <a href="/tags/逆向/" style="font-size: 10px;">逆向</a> <a href="/tags/重庆/" style="font-size: 10px;">重庆</a> <a href="/tags/驱动/" style="font-size: 16.67px;">驱动</a>
  </div>
</div>


  <div class="widget tag">
<h3 class="title">Links</h3>
<ul class="entry">
<li><a href="http://blog.ourren.com/" title="Ourren">Ourren</a></li>
<li><a href="http://www.hyjal.net/" title="Hyjal">Hyjal</a></li>
<li><a href="http://www.jianshu.com/users/fa15f4e416ae/latest_articles" title="Daemonceltics">Daemonceltics</a></li>
<li><a href="http://papap.info/" title="isee">isee</a></li>
</ul>
</div>

  <script type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=putG&d=yoFnN6V-ovhL-H4e9_69LvkTiX4uX7rEYJ15yL3G1Wg"></script>
</aside>
    <div class="clearfix"></div>
  </div>
  <div id="go-pg-top"><i class="icon-arrow-up"></i></div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2020 Lyon
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/page.js"></script>

</body>

</html>