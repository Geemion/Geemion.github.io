<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Peb(Process Environment Block)简单学习及分析 | Lyon&#39;s blog</title>
  <meta name="author" content="Lyon">
  
  <meta name="description" content="Walk steps step by step">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Peb(Process Environment Block)简单学习及分析"/>
  <meta property="og:site_name" content="Lyon&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  #<link href="/favicon.ico" rel="icon">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Lyon&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="/js/jquery.min.js"></script>
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?1d807422614f63c8de98cdc3b546860c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
  <script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
    
</head>


<body>
  <!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0027_Simplified Chinese.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Lyon&#39;s blog</a></h1>
  <h2><a href="/">I hear and I forget.I see and I remember.I do and I understand.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/about">关于</a></li>
    
	<li> <a href="/atom.xml">RSS</a> </li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      
        <img src="http://www.youngroe.com/img/pebhedad.png">
      
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2015-08-01T13:38:01.000Z"><a href="/2015/08/01/Debug/peb-analysis/">2015-08-01</a></time>
      
      
  
    <h1 class="title">Peb(Process Environment Block)简单学习及分析</h1>
  

    </header>
	
<!-- Table of Contents -->

  <div id="toc" class="toc-article">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PEB结构初探"><span class="toc-number">1.</span> <span class="toc-text">PEB结构初探</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Peb应用程序代码"><span class="toc-number">2.</span> <span class="toc-text">Peb应用程序代码</span></a></li></ol>
  </div>


	
    <div class="entry">
      
        <p>参考资料：<br><a href="https://www.google.com.hk/webhp?hl=zh-CN&amp;sourceid=cnhp&amp;gws_rd=ssl#newwindow=1&amp;safe=strict&amp;hl=zh-CN&amp;q=peb+site:pediy.com" target="_blank" rel="external">Google peb site:pediy.com</a><br><a href="http://bbs.pediy.com/showthread.php?t=52398" target="_blank" rel="external">PEB结构—-枚举用户模块列表</a><br><a href="http://bbs.pediy.com/showthread.php?t=69730" target="_blank" rel="external">修改已加载DLL的模块名和路径</a></p>
<h2 id="PEB结构初探">PEB结构初探</h2><p>windows系统中通过各种结构来管理各个对象，关于进程线程的PEB、TEB、EPROCESS等，这几个结构的关系如下图</p>
<div align="center"><br><img src="/img/关系.png" width="400" height="400" alt="PEB、TEB、EPROCESS结构在系统结构中关系" align="center"><br></div><br>而PEB(Process Environment Block)——进程环境块使用较多，并且我们可以找到很多关于PEB的资料并且用处也很大，它包含了映像加载器、堆管理器和其他的windows系统DLL所需要的信息，因为它们需要在用户模式下修改PEB中的信息，所以必须位于用户空间。PEB存放进程信息，每个进程都有自己的 PEB 信息。准确的 PEB 地址应从系统的 EPROCESS 结构的 1b0H 偏移处获得，但由于 EPROCESS在进程的核心内存区，所以程序不能直接访问。但是由上面的关系图可以发现TEB也指向PEB结构同时位于用户空间并且可以很方便的获得，可以通过CPU的FS寄存器来访问TEB，一般存储在[FS:0]，在TEB结构偏移30H处可以获得PEB位置<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">mov eax,fs:[<span class="number">0x30</span>]</span><br><span class="line">mov PEB,eax</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>除此之外还可以通过以下方式获得PEB结构<br><br>- 在内核中我们可以先PsGetCurrentProcess得到当前进程的EPROCESS，然后通过它的成员域PEB访问到当前进程<br>- 在内核中，我们可以通过KPRCB获得当前线程的ETHREAD，然后通过它的成员域来访问当TEB，然后再通过TEB的成员域来访问PEB<br><a id="more"></a><br>## PEB结构体<br>### _PEB<br><img src="/img/pebstruct.png" alt="PEB结构体"><br><br>上图是PEB结构各个元素关系图，可以对PEB结构有个初步认识同时也可以看到这个结构较为复杂成员较多。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">MSDN文档中结构体不是很详细，所以PEB结构现在也属于一个未公开结构体。</span><br><span class="line"><span class="number">32</span>位系统</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _PEB &#123;</span><br><span class="line">  BYTE                          Reserved1[<span class="number">2</span>];</span><br><span class="line">  BYTE                          BeingDebugged; 标识当前进程是否被调试，在反调试</span><br><span class="line">  BYTE                          Reserved2[<span class="number">1</span>];</span><br><span class="line">  PVOID                         Reserved3[<span class="number">2</span>];</span><br><span class="line">  PPEB_LDR_DATA                 Ldr; </span><br><span class="line">  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters;</span><br><span class="line">  BYTE                          Reserved4[<span class="number">104</span>];</span><br><span class="line">  PVOID                         Reserved5[<span class="number">52</span>];</span><br><span class="line">  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;</span><br><span class="line">  BYTE                          Reserved6[<span class="number">128</span>];</span><br><span class="line">  PVOID                         Reserved7[<span class="number">1</span>];</span><br><span class="line">  ULONG                         SessionId;</span><br><span class="line">&#125; PEB, *PPEB;</span><br><span class="line"><span class="number">64</span>位系统</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _PEB &#123;</span><br><span class="line">    BYTE Reserved1[<span class="number">2</span>];</span><br><span class="line">    BYTE BeingDebugged;</span><br><span class="line">    BYTE Reserved2[<span class="number">21</span>];</span><br><span class="line">    PPEB_LDR_DATA LoaderData;</span><br><span class="line">    PRTL_USER_PROCESS_PARAMETERS ProcessParameters;</span><br><span class="line">    BYTE Reserved3[<span class="number">520</span>];</span><br><span class="line">    PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;</span><br><span class="line">    BYTE Reserved4[<span class="number">136</span>];</span><br><span class="line">    ULONG SessionId;</span><br><span class="line">&#125; PEB;</span><br><span class="line">根据reactos来的结构定义</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _PEB &#123;</span><br><span class="line">+<span class="number">0x000</span> BOOLEAN InheritedAddressSpace;</span><br><span class="line">+<span class="number">0x001</span> BOOLEAN ReadImageFileExecOptions;</span><br><span class="line">+<span class="number">0x002</span> BOOLEAN BeingDebugged; 			         标志当前进程是否被调试</span><br><span class="line">+<span class="number">0x003</span> BOOLEAN Spare;</span><br><span class="line">+<span class="number">0x004</span> HANDLE Mutant;</span><br><span class="line">+<span class="number">0x008</span> PVOID ImageBaseAddress; 		             进程的映像基地址，exe <span class="number">0x400000</span>,dll <span class="number">0x1000000</span></span><br><span class="line">+<span class="number">0x00c</span> PPEB_LDR_DATA LoaderData; 		         由PE Loader填充，包含很多pe中包含的信息，用来枚举用户加载的模块</span><br><span class="line">+<span class="number">0x010</span> PRTL_USER_PROCESS_PARAMETERS ProcessParameters; 指向  RTL_USER_PROCESS_PARAMETERS 的指针，RTL_USER_PROCESS_PARAMETERS 中是一些进程的参数。</span><br><span class="line">+<span class="number">0x014</span> PVOID SubSystemData;</span><br><span class="line">PVOID ProcessHeap;  			                 指向进程堆首地址，每个程序新建时默认堆使用</span><br><span class="line">PVOID FastPebLock;  			                 存放的是PEBLOCKROUTINE这个例程函数需要用到的参数。</span><br><span class="line">PPEBLOCKROUTINE FastPebLockRoutine;              PEB加锁/解锁回调例程</span><br><span class="line">PPEBLOCKROUTINE FastPebUnlockRoutine;</span><br><span class="line">ULONG EnvironmentUpdateCount; 	                 进程的环境变量更改的次数</span><br><span class="line">PPVOID KernelCallbackTable;		                 从内核“回调”用户空间的函数</span><br><span class="line">PVOID EventLogSection;</span><br><span class="line">PVOID EventLog;</span><br><span class="line">PPEB_FREE_BLOCK FreeList;</span><br><span class="line">ULONG TlsExpansionCounter; </span><br><span class="line">PVOID TlsBitmap;                                 域代表TLS位图</span><br><span class="line">ULONG TlsBitmapBits[<span class="number">0x2</span>];</span><br><span class="line">PVOID ReadOnlySharedMemoryBase;</span><br><span class="line">PVOID ReadOnlySharedMemoryHeap;</span><br><span class="line">PPVOID ReadOnlyStaticServerData;</span><br><span class="line">PVOID AnsiCodePageData;</span><br><span class="line">PVOID OemCodePageData;</span><br><span class="line">PVOID UnicodeCaseTableData;</span><br><span class="line">ULONG NumberOfProcessors;</span><br><span class="line">ULONG NtGlobalFlag;</span><br><span class="line">BYTE Spare2[<span class="number">0x4</span>];</span><br><span class="line">LARGE_INTEGER CriticalSectionTimeout;</span><br><span class="line">ULONG HeapSegmentReserve;                       进程在新建堆的时候默认申请的虚拟内存大小</span><br><span class="line">ULONG HeapSegmentCommit;</span><br><span class="line">ULONG HeapDeCommitTotalFreeThreshold;</span><br><span class="line">ULONG HeapDeCommitFreeBlockThreshold;</span><br><span class="line">ULONG NumberOfHeaps;                            当前进程的堆数目,这个数目对应着!heap命令的堆显示个数</span><br><span class="line">ULONG MaximumNumberOfHeaps;                     进程所能运行的最大堆数目,若堆数目超过这个值估计HeapCreate就失败了吧</span><br><span class="line">PPVOID *ProcessHeaps;                           存储堆句柄的数组,这里我们可以得到进程的所有堆句柄</span><br><span class="line">PVOID GdiSharedHandleTable;</span><br><span class="line">PVOID ProcessStarterHelper;</span><br><span class="line">PVOID GdiDCAttributeList;</span><br><span class="line">PVOID LoaderLock;</span><br><span class="line">ULONG OSMajorVersion;</span><br><span class="line">ULONG OSMinorVersion;</span><br><span class="line">ULONG OSBuildNumber;</span><br><span class="line">ULONG OSPlatformId;</span><br><span class="line">ULONG ImageSubSystem;</span><br><span class="line">ULONG ImageSubSystemMajorVersion;</span><br><span class="line">ULONG ImageSubSystemMinorVersion;</span><br><span class="line">ULONG GdiHandleBuffer[<span class="number">0x22</span>];</span><br><span class="line">ULONG PostProcessInitRoutine;</span><br><span class="line">ULONG TlsExpansionBitmap;</span><br><span class="line">BYTE TlsExpansionBitmapBits[<span class="number">0x80</span>];</span><br><span class="line">ULONG SessionId;</span><br><span class="line">&#125; PEB, *PPEB;</span><br></pre></td></tr></table></figure><br><br>由上面结构体中可以发现PEB结构成员众多且还属于未公开结构体，但是微软也公开了一些结构。其中PPEB_LDR_DATA是本篇主要讨论的<br>### PPEB_LDR_DATA<br><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa813708(v=vs.85" target="_blank" rel="external">msdn</a>.aspx)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _PEB_LDR_DATA &#123;</span><br><span class="line">  BYTE       Reserved1[<span class="number">8</span>];</span><br><span class="line">  PVOID      Reserved2[<span class="number">3</span>];</span><br><span class="line">  LIST_ENTRY InMemoryOrderModuleList;</span><br><span class="line">&#125; PEB_LDR_DATA, *PPEB_LDR_DATA;</span><br><span class="line"></span><br><span class="line">ReactOS</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _PEB_LDR_DATA &#123;</span><br><span class="line">    ULONG      Length;           结构体大小</span><br><span class="line">    BOOLEAN    Initialized;      指示当前进程被初始化过了</span><br><span class="line">    PVOID      SsHandle;</span><br><span class="line">    LIST_ENTRY InLoadOrderModuleList;   按照加载顺序</span><br><span class="line">    LIST_ENTRY InMemoryOrderModuleList; 内存顺序</span><br><span class="line">    LIST_ENTRY InInitializationOrderModuleList; 初始化顺序</span><br><span class="line">&#125; PEB_LDR_DATA, *PPEB_LDR_DATA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _LIST_ENTRY &#123;</span><br><span class="line">   <span class="keyword">struct</span> _LIST_ENTRY *Flink;</span><br><span class="line">   <span class="keyword">struct</span> _LIST_ENTRY *Blink;</span><br><span class="line"></span><br><span class="line">&#125; LIST_ENTRY, *PLIST_ENTRY, *RESTRICTED_POINTER PRLIST_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _LDR_MODULE &#123;</span><br><span class="line">    LIST_ENTRY InLoadOrderModuleList;</span><br><span class="line">    LIST_ENTRY InMemoryOrderModuleList;</span><br><span class="line">    LIST_ENTRY InInitializationOrderModuleList;</span><br><span class="line">    PVOID BaseAddress;</span><br><span class="line">    PVOID EntryPoint;</span><br><span class="line">    ULONG SizeOfImage;</span><br><span class="line">    UNICODE_STRING FullDllName;    模块全路径</span><br><span class="line">    UNICODE_STRING BaseDllName;	   模块名称</span><br><span class="line">    ULONG Flags;</span><br><span class="line">    SHORT LoadCount;</span><br><span class="line">    SHORT TlsIndex;</span><br><span class="line">    LIST_ENTRY HashTableEntry;</span><br><span class="line">    ULONG TimeDateStamp;</span><br><span class="line">&#125; LDR_MODULE, *PLDR_MODULE;</span><br></pre></td></tr></table></figure><br><br><div align="center"><br><img src="/img/pebhedad.png" alt="从PEB到Ldr_module" align="center"><br></div>

<p>上图展示了从PEB—–&gt;PEB_LDR_DATA——&gt;LDR_MODULE的过程，LDR_MODULE中容纳的是进程中各个dll的信息最后通过LIST_ENTRY形成双向链表将各个dll信息连接起来。我们就可以通过上面的方式找到各个dll模块然后将信息打印出来，形成自己的模块遍历程序。<br>同时我们也可以通过修改或则删除某些dll模块信息达到隐藏dll目的。</p>
<h2 id="Peb应用程序代码">Peb应用程序代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AboutPeb.h</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span> _ABOUT_PEB_</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> _ABOUT_PEB_</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _MYPEB_LDR_DATA</span><br><span class="line">&#123;</span><br><span class="line">	ULONG Length;</span><br><span class="line">	BOOLEAN Initialized;</span><br><span class="line">	PVOID SsHandle;</span><br><span class="line">	LIST_ENTRY InLoadOrderModuleList;</span><br><span class="line">	LIST_ENTRY InMemoryOrderModuleList;</span><br><span class="line">	LIST_ENTRY InInitializationOrderModuleList;</span><br><span class="line">&#125;MYPEB_LDR_DATA,*PMYPEB_LDR_DATA;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _MYLDR_DATA_TABLE_ENTRY</span><br><span class="line">&#123;</span><br><span class="line">	LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">	LIST_ENTRY InMemoryOrderModuleList;</span><br><span class="line">	LIST_ENTRY InInitializationOrderModuleList;</span><br><span class="line">	PVOID DllBase;</span><br><span class="line">	PVOID EntryPoint;</span><br><span class="line">	ULONG SizeOfImage;</span><br><span class="line">	UNICODE_STRING FullDllName;</span><br><span class="line">	UNICODE_STRING BaseDllName;</span><br><span class="line">	ULONG Flags;</span><br><span class="line">	WORD LoadCount;</span><br><span class="line">	WORD TlsIndex;</span><br><span class="line">	<span class="keyword">union</span></span><br><span class="line">	&#123;</span><br><span class="line">		LIST_ENTRY HashLinks;</span><br><span class="line">		<span class="keyword">struct</span></span><br><span class="line">		&#123;</span><br><span class="line">			PVOID SectionPointer;</span><br><span class="line">			ULONG CheckSum;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">union</span></span><br><span class="line">	&#123;</span><br><span class="line">		ULONG TimeDateStamp;</span><br><span class="line">		PVOID LoadedImports;</span><br><span class="line">	&#125;;</span><br><span class="line">	_ACTIVATION_CONTEXT * EntryPointActivationContext;</span><br><span class="line">	PVOID PatchInformation;</span><br><span class="line">	LIST_ENTRY ForwarderLinks;</span><br><span class="line">	LIST_ENTRY ServiceTagLinks;</span><br><span class="line">	LIST_ENTRY StaticLinks;</span><br><span class="line">&#125; MYLDR_DATA_TABLE_ENTRY, *PMYLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _LDR_MODULE</span><br><span class="line">&#123;</span><br><span class="line">	LIST_ENTRY          InLoadOrderModuleList;</span><br><span class="line">	LIST_ENTRY          InMemoryOrderModuleList;  </span><br><span class="line">	LIST_ENTRY          InInitializationOrderModuleList; </span><br><span class="line">	<span class="keyword">void</span>*               BaseAddress;  </span><br><span class="line">	<span class="keyword">void</span>*               EntryPoint;   </span><br><span class="line">	ULONG               SizeOfImage;</span><br><span class="line">	UNICODE_STRING		FullDllName;</span><br><span class="line">	UNICODE_STRING      BaseDllName;</span><br><span class="line">	ULONG               Flags;</span><br><span class="line">	SHORT               LoadCount;</span><br><span class="line">	SHORT               TlsIndex;</span><br><span class="line">	HANDLE              SectionHandle;</span><br><span class="line">	ULONG               CheckSum;</span><br><span class="line">	ULONG               TimeDateStamp;</span><br><span class="line">&#125; LDR_MODULE, *PLDR_MODULE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">	DWORD InLoadNext;</span><br><span class="line">	DWORD InLoadPrev;</span><br><span class="line"></span><br><span class="line">	DWORD InMemNext;</span><br><span class="line">	DWORD InMemPrev;</span><br><span class="line"></span><br><span class="line">	DWORD InInitNext;</span><br><span class="line">	DWORD InInitPrev;</span><br><span class="line"></span><br><span class="line">	DWORD ImageBase;          <span class="comment">//模块基地址</span></span><br><span class="line"></span><br><span class="line">	PVOID EntryPoint;</span><br><span class="line"></span><br><span class="line">	ULONG SizeOfImage;</span><br><span class="line"></span><br><span class="line">	UNICODE_STRING FullDllName;</span><br><span class="line"></span><br><span class="line">	UNICODE_STRING BaseDllName;</span><br><span class="line">&#125; PEB_LIST_ENTRY, *PPEB_LIST_ENTRY;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//声明一些函数</span></span><br><span class="line"></span><br><span class="line"><span class="function">PEB_LIST_ENTRY *<span class="title">GetPEBAdd</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ListDllModByPeb</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">ModifyDllInfoByPeb</span><span class="params">(HMODULE hMod,PWSTR pFakename,PWSTR pFakePath)</span></span>;</span><br><span class="line"><span class="comment">//dll模块的隐藏  Toolhelp---&gt;InLoadOrderModuleList psapi---&gt;InMemoryOrderModuleList       http://bbs.pediy.com/showthread.php?t=59932</span></span><br><span class="line"><span class="comment">//win7  [psapi]EnumProcessModules--&gt;[KERNEL32.dll]K32EnumProcessModules(x,x,x,x)---&gt;EnumProcessModulesInternal-----&gt;NtQueryInformationProcess[BOOL GetPebbyNativeApi(DWORD dwPid)基本类似]</span></span><br><span class="line"><span class="function">BOOL <span class="title">HiddeDllByRemovePebList</span><span class="params">(HMODULE hMod)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">HidebyPeb</span><span class="params">(HANDLE hprocess,HMODULE hmodhid)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//http://www.cnblogs.com/boyxiao/archive/2011/02/27/1966383.html</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ListProcessByApi</span><span class="params">(DWORD dwPid)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//IsDebugerPresent peb反调试 学习 http://www.cnblogs.com/this-543273659/archive/2013/03/04/2943380.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//peb 另外一种获取方式 NtQueryInformationProcess   [PEB]获取进程完整路径探索</span></span><br><span class="line"><span class="function">BOOL <span class="title">GetPebbyNativeApi</span><span class="params">(DWORD dwPid)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过peb写通用 shellcode  WinXP/Win7/Win8通用shellcode_Dream  http://www.freebuf.com/articles/system/58920.html  http://blog.csdn.net/wowolook/article/details/8747586</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//反peb隐藏  通过VirtualQueryEx函数列举出进程内虚拟内存的段，然后根据PE结构和内存属性来定位Image文件的映像基地址</span></span><br><span class="line"><span class="comment">//http://www.blogfshare.com/enumprocess-by-search.html   http://www.blogfshare.com/activeprocesslinks-dkom.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//调试ldr链接  http://bbs.pediy.com/showthread.php?t=149527   http://blog.csdn.net/hgy413/article/details/8490918  http://bbs.pediy.com/showthread.php?t=175833</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//高级玩法  https://github.com/David-Reguera-Garcia-Dreg/phook</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>—————————–代码———————————–<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AboutPeb.cpp : 定义控制台应用程序的入口点。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"StdAfx.h"</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"AboutPeb.h"</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;TlHelp32.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bugW</span><span class="params">( LPWSTR format, ... )</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	va_list args;</span><br><span class="line">	va_start(args, format);</span><br><span class="line">	WCHAR wszMsg[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	wvsprintfW(wszMsg, format, args);</span><br><span class="line">	va_end(args);</span><br><span class="line"></span><br><span class="line">	OutputDebugStringW(wszMsg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">PEB_LIST_ENTRY *<span class="title">GetPEBAdd</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	DWORD Loaded_Head;</span><br><span class="line">	DWORD **pPEB;</span><br><span class="line">	DWORD *Ldr;</span><br><span class="line"></span><br><span class="line">	__asm &#123;</span><br><span class="line">		MOV EAX,<span class="number">30</span>h</span><br><span class="line">			MOV EAX,DWORD PTR FS:[EAX]  <span class="comment">//获得peb首地址 PEB = FS:0x30</span></span><br><span class="line">		ADD EAX, <span class="number">08</span>h                <span class="comment">//保存模块基址 Imagebaseaddress</span></span><br><span class="line">			MOV SS:[pPEB], EAX</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Ldr = *(pPEB + <span class="number">1</span>);</span><br><span class="line">	Loaded_Head = *(Ldr + <span class="number">3</span>);</span><br><span class="line">	<span class="keyword">return</span> (PEB_LIST_ENTRY *)Loaded_Head;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ListDllModByPeb</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	MYPEB_LDR_DATA *pPEBLDR;</span><br><span class="line">	LDR_MODULE *pLdrMod;</span><br><span class="line">	LIST_ENTRY *pListEntry,*pStart;</span><br><span class="line"></span><br><span class="line">	_asm</span><br><span class="line">	&#123;</span><br><span class="line">		mov eax,fs:[<span class="number">0x30</span>] <span class="comment">//TEB-&gt;PEB</span></span><br><span class="line">		mov eax,[eax+<span class="number">0xC</span>] <span class="comment">//PEB-&gt;Ldr</span></span><br><span class="line">		mov pPEBLDR,eax</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//通过InLoadOrderModuleList遍历</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"\n\t-----InLoadOrderModuleList-----\n"</span>);</span><br><span class="line">	pStart=pListEntry=(LIST_ENTRY*)(PUCHAR)&amp;(pPEBLDR-&gt;InLoadOrderModuleList);<span class="comment">//0x773a8b4c</span></span><br><span class="line">	pListEntry=pListEntry-&gt;Flink;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;pListEntry!=pStart;pListEntry=pListEntry-&gt;Flink)</span><br><span class="line">	&#123;</span><br><span class="line">		++i;</span><br><span class="line">		pLdrMod=(LDR_MODULE*)(pListEntry);<span class="comment">//0x773a8b40</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d:名称:%010ws,基地址:0x%010x,模块大小:%010x\n模块路径:%ws\n\n"</span>,</span><br><span class="line">			i,pLdrMod-&gt;BaseDllName.Buffer,pLdrMod-&gt;BaseAddress,</span><br><span class="line">			pLdrMod-&gt;SizeOfImage,pLdrMod-&gt;FullDllName.Buffer);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">////通过InLoadOrderModuleList遍历</span></span><br><span class="line">	<span class="comment">//printf("\n\t-----InMemoryOrderModuleList-----\n");</span></span><br><span class="line">	<span class="comment">//pStart=pListEntry=(LIST_ENTRY*)(PUCHAR)&amp;(pPEBLDR-&gt;InMemoryOrderModuleList);//0x773a8b4c</span></span><br><span class="line">	<span class="comment">//pListEntry=pListEntry-&gt;Flink;</span></span><br><span class="line">	<span class="comment">//for (int i=0;pListEntry!=pStart;pListEntry=pListEntry-&gt;Flink)</span></span><br><span class="line">	<span class="comment">//&#123;</span></span><br><span class="line">	<span class="comment">//	++i;</span></span><br><span class="line">	<span class="comment">//	pLdrMod=(LDR_MODULE*)(pListEntry-sizeof(LIST_ENTRY));</span></span><br><span class="line">	<span class="comment">//	printf("%d:名称:%010ws,基地址:0x%010x,模块大小:%010x\n模块路径:%ws\n\n",</span></span><br><span class="line">	<span class="comment">//		i,pLdrMod-&gt;BaseDllName.Buffer,pLdrMod-&gt;BaseAddress,</span></span><br><span class="line">	<span class="comment">//		pLdrMod-&gt;SizeOfImage,pLdrMod-&gt;FullDllName.Buffer);</span></span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">ModifyDllInfoByPeb</span><span class="params">(HMODULE hMod,PWSTR pFakename,PWSTR pFakePath)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	MYPEB_LDR_DATA *pPEBLDR;</span><br><span class="line">	LDR_MODULE *pLdrMod;</span><br><span class="line">	LIST_ENTRY *pListEntry,*pStart;</span><br><span class="line">	DWORD dwKernelBase;</span><br><span class="line">	PWSTR fakemodulename=pFakename;</span><br><span class="line">	PWSTR fakemodulepath=pFakePath;</span><br><span class="line">	BOOL bRet=FALSE;</span><br><span class="line">	_asm</span><br><span class="line">	&#123;</span><br><span class="line">		mov eax,fs:[<span class="number">0x30</span>] <span class="comment">//TEB-&gt;PEB</span></span><br><span class="line">		mov eax,[eax+<span class="number">0xC</span>] <span class="comment">//PEB-&gt;Ldr</span></span><br><span class="line">		mov pPEBLDR,eax</span><br><span class="line">	&#125;</span><br><span class="line">	dwKernelBase=(DWORD)hMod;</span><br><span class="line">	pStart=pListEntry=(LIST_ENTRY*)(PUCHAR)&amp;(pPEBLDR-&gt;InLoadOrderModuleList);</span><br><span class="line">	<span class="keyword">do</span> </span><br><span class="line">	&#123;</span><br><span class="line">		pListEntry=pListEntry-&gt;Flink;</span><br><span class="line">		pLdrMod=(LDR_MODULE*)(pListEntry);</span><br><span class="line">		<span class="keyword">if</span> ((DWORD)pLdrMod-&gt;BaseAddress==dwKernelBase)</span><br><span class="line">		&#123;</span><br><span class="line">			lstrcpyW(pLdrMod-&gt;BaseDllName.Buffer,fakemodulename);</span><br><span class="line">			lstrcpyW(pLdrMod-&gt;FullDllName.Buffer,fakemodulepath);</span><br><span class="line">			bRet=TRUE;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">while</span>(pListEntry!=pStart);</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">HiddeDllByRemovePebList</span><span class="params">(HMODULE hMod)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	PEB_LIST_ENTRY *Depends_List, *List_Head;</span><br><span class="line">	PEB_LIST_ENTRY *prev, *next;</span><br><span class="line">	<span class="keyword">bool</span> bRet=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	Depends_List = List_Head = GetPEBAdd();</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (Depends_List-&gt;ImageBase == (DWORD)hMod) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//1</span></span><br><span class="line">			prev = (PEB_LIST_ENTRY *) Depends_List-&gt;InLoadPrev;</span><br><span class="line">			next = (PEB_LIST_ENTRY *) Depends_List-&gt;InLoadNext;</span><br><span class="line">			<span class="keyword">if</span> (prev)</span><br><span class="line">				prev-&gt;InLoadNext = (DWORD)next;</span><br><span class="line">			<span class="keyword">if</span> (next)</span><br><span class="line">				next-&gt;InLoadPrev = (DWORD)prev;</span><br><span class="line"></span><br><span class="line">			prev = (PEB_LIST_ENTRY *) (Depends_List-&gt;InMemPrev - <span class="number">8</span>);</span><br><span class="line">			next = (PEB_LIST_ENTRY *) (Depends_List-&gt;InMemNext - <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//2</span></span><br><span class="line">			<span class="keyword">if</span> (Depends_List-&gt;InMemPrev) &#123;</span><br><span class="line">				<span class="keyword">if</span> (Depends_List-&gt;InMemNext)</span><br><span class="line">					prev-&gt;InMemNext = ((DWORD)next) + <span class="number">8</span>;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					prev-&gt;InMemNext = <span class="literal">NULL</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (Depends_List-&gt;InMemNext) &#123;</span><br><span class="line">				<span class="keyword">if</span> (Depends_List-&gt;InMemPrev)</span><br><span class="line">					next-&gt;InMemPrev = ((DWORD)prev) + <span class="number">8</span>;</span><br><span class="line">				<span class="keyword">else</span> </span><br><span class="line">					next-&gt;InMemPrev = <span class="literal">NULL</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//3</span></span><br><span class="line">			prev = (PEB_LIST_ENTRY *) (Depends_List-&gt;InInitPrev - <span class="number">16</span>);</span><br><span class="line">			next = (PEB_LIST_ENTRY *) (Depends_List-&gt;InInitNext - <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (Depends_List-&gt;InInitPrev) &#123;</span><br><span class="line">				<span class="keyword">if</span> (Depends_List-&gt;InInitNext)</span><br><span class="line">					prev-&gt;InInitNext = ((DWORD)next) + <span class="number">16</span>;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					prev-&gt;InInitNext = <span class="literal">NULL</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (Depends_List-&gt;InInitNext) &#123;</span><br><span class="line">				<span class="keyword">if</span> (Depends_List-&gt;InInitPrev)</span><br><span class="line">					next-&gt;InInitPrev = ((DWORD)prev) + <span class="number">16</span>;</span><br><span class="line">				<span class="keyword">else</span> </span><br><span class="line">					next-&gt;InInitPrev = <span class="literal">NULL</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			bRet=<span class="literal">true</span>;</span><br><span class="line">			<span class="keyword">break</span>;			</span><br><span class="line">		&#125;</span><br><span class="line">		Depends_List = (PEB_LIST_ENTRY *)Depends_List-&gt;InLoadNext;</span><br><span class="line">	&#125; <span class="keyword">while</span>(List_Head != Depends_List); </span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">HidebyPeb</span><span class="params">(HANDLE hprocess,HMODULE hmodhid)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	HMODULE hMod = GetModuleHandle( _T( <span class="string">"ntdll.dll"</span>));</span><br><span class="line">	HMODULE hModMyself = hmodhid;<span class="comment">//GetModuleHandle( _T("dll.dll"));</span></span><br><span class="line">	LONG (WINAPI *pfnNtQueryInformationProcess)(HANDLE,PROCESSINFOCLASS,PVOID,ULONG,PULONG);</span><br><span class="line">	pfnNtQueryInformationProcess= (LONG (WINAPI *)(HANDLE,PROCESSINFOCLASS,PVOID,ULONG,PULONG))GetProcAddress( hMod, <span class="string">"NtQueryInformationProcess"</span>);</span><br><span class="line"></span><br><span class="line">	PROCESS_BASIC_INFORMATION stInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	DWORD dwRetnLen = <span class="number">0</span>;</span><br><span class="line">	DWORD dw = pfnNtQueryInformationProcess( hprocess, ProcessBasicInformation, &amp;stInfo, <span class="keyword">sizeof</span>(stInfo), &amp;dwRetnLen);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获得peb的指针</span></span><br><span class="line">	PPEB pPeb = stInfo.PebBaseAddress;</span><br><span class="line">	PLIST_ENTRY ListHead, Current;</span><br><span class="line">	PMYLDR_DATA_TABLE_ENTRY pstEntry = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//完整定义 http://bbs.pediy.com/showthread.php?t=149527</span></span><br><span class="line">	ListHead = &amp;(PMYPEB_LDR_DATA(stInfo.PebBaseAddress-&gt;Ldr)-&gt;InLoadOrderModuleList);</span><br><span class="line">	Current = ListHead-&gt;Flink;</span><br><span class="line">	<span class="keyword">while</span> ( Current != ListHead)</span><br><span class="line">	&#123;   <span class="comment">//修改系统的  取得内存中任何结构体的首地址（结构体中某个成员（field）的地址，结构体的类型type，要得到地址那个成员的名字field）</span></span><br><span class="line">		pstEntry = CONTAINING_RECORD( Current, MYLDR_DATA_TABLE_ENTRY, InLoadOrderLinks);</span><br><span class="line">		<span class="comment">//OutputDebugStringW( L"Module:%s, base:0x%X\r\n", pstEntry-&gt;FullDllName.Buffer, pstEntry-&gt;EntryPoint);</span></span><br><span class="line">		<span class="keyword">if</span> ( pstEntry-&gt;DllBase == hModMyself)</span><br><span class="line">		&#123;</span><br><span class="line">			pstEntry-&gt;InLoadOrderLinks.Flink-&gt;Blink = pstEntry-&gt;InLoadOrderLinks.Blink;</span><br><span class="line">			pstEntry-&gt;InLoadOrderLinks.Blink-&gt;Flink = pstEntry-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">			OutputDebugString( _T( <span class="string">"Hide injected dll."</span>));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Current = pstEntry-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ListHead = &amp;( stInfo.PebBaseAddress-&gt;Ldr-&gt;InMemoryOrderModuleList);</span><br><span class="line">	Current = ListHead-&gt;Flink;</span><br><span class="line">	<span class="keyword">while</span> ( Current != ListHead)</span><br><span class="line">	&#123;</span><br><span class="line">		pstEntry = CONTAINING_RECORD( Current, MYLDR_DATA_TABLE_ENTRY, InMemoryOrderModuleList);</span><br><span class="line">		bugW( <span class="string">L"Module:%s, base:0x%X\r\n"</span>, pstEntry-&gt;FullDllName.Buffer, pstEntry-&gt;EntryPoint);</span><br><span class="line">		<span class="keyword">if</span> ( pstEntry-&gt;DllBase == hModMyself)</span><br><span class="line">		&#123;</span><br><span class="line">			pstEntry-&gt;InMemoryOrderModuleList.Flink-&gt;Blink = pstEntry-&gt;InMemoryOrderModuleList.Blink;</span><br><span class="line">			pstEntry-&gt;InMemoryOrderModuleList.Blink-&gt;Flink = pstEntry-&gt;InMemoryOrderModuleList.Flink;</span><br><span class="line">			OutputDebugString( _T( <span class="string">"Hide injected dll."</span>));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Current = pstEntry-&gt;InMemoryOrderModuleList.Flink;</span><br><span class="line">	&#125;</span><br><span class="line">	OutputDebugStringW( <span class="string">L"\r\n"</span>);</span><br><span class="line"></span><br><span class="line">	ListHead = &amp;(PMYPEB_LDR_DATA(stInfo.PebBaseAddress-&gt;Ldr)-&gt;InInitializationOrderModuleList);</span><br><span class="line">	Current = ListHead-&gt;Flink;</span><br><span class="line">	<span class="keyword">while</span> ( Current != ListHead)</span><br><span class="line">	&#123;</span><br><span class="line">		pstEntry = CONTAINING_RECORD( Current, MYLDR_DATA_TABLE_ENTRY, InInitializationOrderModuleList);</span><br><span class="line">		bugW( <span class="string">L"Module:%s, base:0x%X\r\n"</span>, pstEntry-&gt;FullDllName.Buffer, pstEntry-&gt;EntryPoint);</span><br><span class="line">		<span class="keyword">if</span> ( pstEntry-&gt;DllBase == hModMyself)</span><br><span class="line">		&#123;</span><br><span class="line">			pstEntry-&gt;InInitializationOrderModuleList.Flink-&gt;Blink = pstEntry-&gt;InInitializationOrderModuleList.Blink;</span><br><span class="line">			pstEntry-&gt;InInitializationOrderModuleList.Blink-&gt;Flink = pstEntry-&gt;InInitializationOrderModuleList.Flink;</span><br><span class="line">			OutputDebugString( _T( <span class="string">"Hide injected dll."</span>));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Current = pstEntry-&gt;InInitializationOrderModuleList.Flink;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//OutputDebugString( _T("Out HideMyself\r\n"));</span></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//EnumProcessModulesInternal 类似</span></span><br><span class="line"><span class="function">BOOL <span class="title">GetPebbyNativeApi</span><span class="params">(DWORD dwPid)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	BOOL bRet=FALSE;</span><br><span class="line"></span><br><span class="line">	DWORD dwParentPid=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	PROCESS_BASIC_INFORMATION pi;</span><br><span class="line">	ZeroMemory(&amp;pi,<span class="keyword">sizeof</span>(pi));</span><br><span class="line"></span><br><span class="line">	DWORD LoaderData=<span class="number">0</span>;</span><br><span class="line">	DWORD InMemoryOrderModuleList=<span class="number">0</span>;</span><br><span class="line">	UNICODE_STRING usImagePath;</span><br><span class="line">	WCHAR ImagePath[MAX_PATH]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	usImagePath.MaximumLength=MAX_PATH;</span><br><span class="line">	HANDLE hProcess=<span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//定义函数指针 Winternl.h 中有定义这里动态获取</span></span><br><span class="line">	LONG (WINAPI *PNtQueryinfomationProcess)(HANDLE,PROCESSINFOCLASS,</span><br><span class="line">		PVOID,ULONG,PULONG);</span><br><span class="line">	<span class="keyword">do</span> </span><br><span class="line">	&#123;</span><br><span class="line">		hProcess=OpenProcess(PROCESS_QUERY_INFORMATION|PROCESS_VM_READ,FALSE,dwPid);</span><br><span class="line">		<span class="keyword">if</span> (hProcess==<span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"open process errno:%d"</span>,GetLastError());</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//获取函数地址</span></span><br><span class="line">		PNtQueryinfomationProcess=(LONG (WINAPI *)(HANDLE,PROCESSINFOCLASS,</span><br><span class="line">			PVOID,ULONG,PULONG))GetProcAddress(GetModuleHandleA(<span class="string">"ntdll.dll"</span>),<span class="string">"NtQueryInformationProcess"</span>);</span><br><span class="line">		<span class="keyword">if</span> (PNtQueryinfomationProcess==<span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (PNtQueryinfomationProcess(hProcess,ProcessBasicInformation,&amp;pi,</span><br><span class="line">			<span class="keyword">sizeof</span>(pi),<span class="literal">NULL</span>)==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//读取LoaderData</span></span><br><span class="line">			<span class="keyword">if</span> (!ReadProcessMemory(hProcess,(PVOID*)((DWORD)pi.PebBaseAddress</span><br><span class="line">				+<span class="number">0xc</span>),&amp;LoaderData,<span class="keyword">sizeof</span>(DWORD),<span class="literal">NULL</span>))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			 <span class="comment">// 读取 InMemoryOrderModuleList</span></span><br><span class="line">			<span class="keyword">if</span> (!ReadProcessMemory(hProcess,(PVOID *)((DWORD)LoaderData+<span class="number">0x14</span>),</span><br><span class="line">				&amp;InMemoryOrderModuleList,<span class="keyword">sizeof</span>(DWORD),<span class="literal">NULL</span>))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">if</span> (!ReadProcessMemory(hProcess,(PVOID *)((DWORD)InMemoryOrderModuleList+<span class="number">0x1c</span>),</span><br><span class="line">				&amp;usImagePath,<span class="keyword">sizeof</span>(UNICODE_STRING),<span class="literal">NULL</span>))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="comment">// 读取真正的路径</span></span><br><span class="line">			<span class="keyword">if</span> (!ReadProcessMemory(hProcess,usImagePath.Buffer,&amp;ImagePath,</span><br><span class="line">				MAX_PATH,<span class="literal">NULL</span>))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bRet=TRUE;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//从PROCESS_BASIC_INFORMATION Reserved3是父进程pid 可以修改父进程pid试试  通过TlHelp32.h也能获取到父进程pid Process32FirstW(hSnapProcess, &amp;ProcessEntry); PROCESSENTRY32W</span></span><br><span class="line">		<span class="comment">//pi.Reserved3=000; 修改这个对大部分ark没用，其他地方肯定还有备份 利用监视某个进程的退出WaitForSingleObject(ParentHandle, INFINITE)</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"父进程pid:%u\n"</span>,(DWORD)pi.Reserved3);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"路径by InMemoryOrderModuleList\n%-10d%ws\n"</span>,dwPid,ImagePath);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	   <span class="comment">//CheckRemoteDebuggerPresent 功能相同</span></span><br><span class="line">	   <span class="built_in">printf</span>(<span class="string">"\n是否被调试by peb-&gt;BeingDebugged：%u\n"</span>,pi.PebBaseAddress-&gt;BeingDebugged);</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//printf("\n\t-------ProcessParameters-----\n");</span></span><br><span class="line">		PRTL_USER_PROCESS_PARAMETERS pParam=<span class="literal">NULL</span>;</span><br><span class="line">		pParam=pi.PebBaseAddress-&gt;ProcessParameters;</span><br><span class="line">		</span><br><span class="line">		WCHAR wszfakepath[MAX_PATH]=<span class="string">L"C:xxxx\\xxxx.exe"</span>;</span><br><span class="line">		lstrcpyW(pParam-&gt;ImagePathName.Buffer,wszfakepath);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"路径by ProcessParameters\n%-10d%ws\n"</span>,dwPid,pParam-&gt;ImagePathName.Buffer);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"命令行%ws\n"</span>,pParam-&gt;CommandLine.Buffer);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"errno\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hProcess)</span><br><span class="line">	&#123;</span><br><span class="line">		CloseHandle(hProcess);</span><br><span class="line">	&#125;</span><br><span class="line">	WCHAR wszmypath[MAX_PATH]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="comment">//win10即使断链了也能正常获取 其他系统不行  win10应该是通过ProcessParameters获得的</span></span><br><span class="line">	GetModuleFileNameW(GetModuleHandleA(<span class="string">"AboutPeb.exe"</span>),wszmypath,<span class="keyword">sizeof</span>(wszmypath));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"路径by GetModuleFileNameW\n%-10d%ws\n"</span>,dwPid,wszmypath);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ListProcessByApi</span><span class="params">(DWORD dwPid)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	BOOL bRet=FALSE;</span><br><span class="line">	<span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">	HANDLE hSnap=CreateToolhelp32Snapshot(TH32CS_SNAPMODULE,dwPid);</span><br><span class="line">	MODULEENTRY32W Module;</span><br><span class="line">	Module.dwSize=<span class="keyword">sizeof</span>(MODULEENTRY32W);</span><br><span class="line">	bRet=Module32FirstW(hSnap,&amp;Module);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"\n-----------CreateToolhelp32Snapshot----------\n\n"</span>);</span><br><span class="line">	<span class="keyword">while</span>(bRet)</span><br><span class="line">	&#123;   i++;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%2d:%-10ws:%ws\n"</span>,i,Module.szModule,Module.szExePath);</span><br><span class="line">		bRet=Module32NextW(hSnap,&amp;Module);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer>
      

        
          <div class="alignleft post-nav">
            <em>上一篇: </em><a href="/2015/08/02/Life/win10-Simpleexperience/">win10正式版简单体验</a>
          </div>
        
        
          <div class="alignright post-nav">
            <em>下一篇: </em><a href="/2015/07/15/Windows/windows-auto-elevated-binaries/">关于Windows自动提权autoElevate</a>
          </div>
          <div class="clearfix"></div>
        

        
          <div class="copyright">
            
              <span class="claim">转载请注明youngroe.com</span>
            
            
              <span class="from-link">
                <em>本文链接地址:</em>
                <a href="/2015/08/01/Debug/peb-analysis/">
                  http://www.youngroe.com/2015/08/01/Debug/peb-analysis/
                </a>
              </span>
            
          </div>
        
        
  
  <div class="categories">
    <a href="/categories/Debug/">Debug</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/PEB/">PEB</a>, <a href="/tags/Windows/">Windows</a>, <a href="/tags/内核结构/">内核结构</a>
  </div>

        
          <! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           ↑<br>
           欣赏此文？求鼓励，求支持！
        </span>
        <br>
      </div>  
    <div id="donate_guide" class="donate_bar center hidden" >
        <!-- 方式一： 
            ![](/img/Alipay.jpg)
            ![](/img/WeChatpay.jpg)
        -->
        <!-- 方式二；
            step1：在_config.yml中添加配置
                Alipay: /img/Alipay.jpg
                WeChatpay: /img/WeChatpay.jpg
            step2：此处两张图片的路径分别设置为如下
                <img src="undefined"
                <img src="undefined"
        -->
        <!-- 支付宝打赏图案 -->
        <img src="/img/Alipay.png" alt="支付宝打赏">
        <!-- 微信打赏图案 -->
        <img src="/img/WeChatpay.png" alt="微信打赏">
    </div>
    <script type="text/javascript">
        document.getElementById('btn_donate').onclick = function(){
            $('#donate_board').addClass('hidden');
            $('#donate_guide').removeClass('hidden');
        }
    </script>
</div>
<! -- 添加捐赠图标 -->
        
        <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
  clientID: '503c39aa3fb2b8c1b734',
  clientSecret: '65d784ff7a95a9dbf4a4208c9e32166ca29654f2',
  repo: 'geemion.github.io',
  owner: 'geemion',
  admin: 'geemion',
  pagerDirection:'first',
  id: md5(window.location.pathname)
})

gitalk.render('gitalk-container')
</script>
        <script data-ad-client="ca-pub-6317609007693835" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      
      <div class="clearfix"></div>
    </footer>
  </div>
  <div id="container"></div>
</span>
</article>


<section id="comment">
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Cybersecurity/">Cybersecurity</a><small>1</small></li>
  
    <li><a href="/categories/Debug/">Debug</a><small>7</small></li>
  
    <li><a href="/categories/Kernel/">Kernel</a><small>4</small></li>
  
    <li><a href="/categories/Learning/">Learning</a><small>8</small></li>
  
    <li><a href="/categories/Life/">Life</a><small>7</small></li>
  
    <li><a href="/categories/Others/">Others</a><small>1</small></li>
  
    <li><a href="/categories/Read-Notes/">Read Notes</a><small>7</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>6</small></li>
  
    <li><a href="/categories/Vulnerabilities/">Vulnerabilities</a><small>0</small></li>
  
    <li><a href="/categories/Windows/">Windows</a><small>14</small></li>
  
    <li><a href="/categories/life/">life</a><small>0</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2019/07/01/Windows/delphi_reverse_summary/">Delphi程序逆向反汇编技巧小记</a>
      </li>
    
      <li>
        <a href="/2019/06/25/Kernel/kernel_enum_wfp_callout_function/">Windows内核重拾：如何枚举系统中Windows Filtering Platform (WFP)驱动中的callout函数</a>
      </li>
    
      <li>
        <a href="/2019/05/06/Kernel/windows-driver-testing-basics/">Windows内核重拾：Windows驱动测试基础：工具、功能和示例（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2019/04/06/Windows/how-to-reverse-engineer-software-windows-in-a-right-way/">如何正确的对Windows软件进行逆向工程（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2019/01/12/Windows/a_crash_lead_deadlock/">Windows平台下一个崩溃而导致的死锁分析</a>
      </li>
    
      <li>
        <a href="/2018/12/01/Windows/windows_client_dns_over_https/">Windows客户端如何透明使用DNS-over-HTTPS</a>
      </li>
    
      <li>
        <a href="/2018/10/06/Cybersecurity/ddos-protection-techniques/">现代DDoS对抗技术概述（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2018/09/18/Life/xian/">西安周末游</a>
      </li>
    
      <li>
        <a href="/2018/01/06/Kernel/WindowsKernel_DebugObject/">Windows内核重拾：DebugObject</a>
      </li>
    
      <li>
        <a href="/2017/10/23/Tools/IDA-Pro-ClassInformer-Tutorial/">IDA Pro ClassInformer使用指南（翻译）</a>
      </li>
    
      <li>
        <a href="/2017/05/23/Windows/Kernel Data and Filtering Support/">Kernel Data and Filtering Support for Windows Server 2008（翻译）</a>
      </li>
    
      <li>
        <a href="/2017/05/17/Windows/Windows-x64-Shellcode/">Windows x64 Shellcode编写指南(翻译)</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/ASM/" style="font-size: 12.5px;">ASM</a> <a href="/tags/Boost/" style="font-size: 10px;">Boost</a> <a href="/tags/DDoS/" style="font-size: 10px;">DDoS</a> <a href="/tags/DNS-over-HTTPS/" style="font-size: 10px;">DNS-over-HTTPS</a> <a href="/tags/Delphi/" style="font-size: 10px;">Delphi</a> <a href="/tags/Dll劫持/" style="font-size: 10px;">Dll劫持</a> <a href="/tags/GCC-GDB/" style="font-size: 10px;">GCC&GDB</a> <a href="/tags/GetVersionEx/" style="font-size: 10px;">GetVersionEx</a> <a href="/tags/Http/" style="font-size: 10px;">Http</a> <a href="/tags/IDA-Pro/" style="font-size: 12.5px;">IDA Pro</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/MSDN/" style="font-size: 12.5px;">MSDN</a> <a href="/tags/Malware/" style="font-size: 12.5px;">Malware</a> <a href="/tags/MiniDumpWriteDump/" style="font-size: 10px;">MiniDumpWriteDump</a> <a href="/tags/PEB/" style="font-size: 10px;">PEB</a> <a href="/tags/Procmon/" style="font-size: 10px;">Procmon</a> <a href="/tags/Runtime-Error/" style="font-size: 10px;">Runtime Error</a> <a href="/tags/SEH/" style="font-size: 10px;">SEH</a> <a href="/tags/Shellcode/" style="font-size: 10px;">Shellcode</a> <a href="/tags/SysinternalsSuite/" style="font-size: 10px;">SysinternalsSuite</a> <a href="/tags/Tips/" style="font-size: 10px;">Tips</a> <a href="/tags/UAC/" style="font-size: 10px;">UAC</a> <a href="/tags/UAF漏洞/" style="font-size: 10px;">UAF漏洞</a> <a href="/tags/VC/" style="font-size: 10px;">VC</a> <a href="/tags/Visual-Studio/" style="font-size: 12.5px;">Visual Studio</a> <a href="/tags/Windbg/" style="font-size: 10px;">Windbg</a> <a href="/tags/Windows/" style="font-size: 20px;">Windows</a> <a href="/tags/Windows核心编程/" style="font-size: 17.5px;">Windows核心编程</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/getaddrinfo/" style="font-size: 10px;">getaddrinfo</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/libeay32/" style="font-size: 10px;">libeay32</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/ndk/" style="font-size: 10px;">ndk</a> <a href="/tags/sublime-text3/" style="font-size: 10px;">sublime text3</a> <a href="/tags/x64/" style="font-size: 12.5px;">x64</a> <a href="/tags/体验/" style="font-size: 10px;">体验</a> <a href="/tags/内核/" style="font-size: 12.5px;">内核</a> <a href="/tags/内核结构/" style="font-size: 15px;">内核结构</a> <a href="/tags/学习/" style="font-size: 10px;">学习</a> <a href="/tags/安全机制/" style="font-size: 10px;">安全机制</a> <a href="/tags/异常处理/" style="font-size: 10px;">异常处理</a> <a href="/tags/提权/" style="font-size: 10px;">提权</a> <a href="/tags/服务/" style="font-size: 10px;">服务</a> <a href="/tags/权限/" style="font-size: 12.5px;">权限</a> <a href="/tags/栈溢出漏洞/" style="font-size: 10px;">栈溢出漏洞</a> <a href="/tags/测试/" style="font-size: 10px;">测试</a> <a href="/tags/浮躁/" style="font-size: 10px;">浮躁</a> <a href="/tags/漏洞调试/" style="font-size: 12.5px;">漏洞调试</a> <a href="/tags/生活/" style="font-size: 15px;">生活</a> <a href="/tags/脱壳/" style="font-size: 10px;">脱壳</a> <a href="/tags/西安/" style="font-size: 10px;">西安</a> <a href="/tags/计划/" style="font-size: 10px;">计划</a> <a href="/tags/读书/" style="font-size: 10px;">读书</a> <a href="/tags/调试/" style="font-size: 15px;">调试</a> <a href="/tags/转换/" style="font-size: 10px;">转换</a> <a href="/tags/进程/" style="font-size: 10px;">进程</a> <a href="/tags/逆向/" style="font-size: 10px;">逆向</a> <a href="/tags/重庆/" style="font-size: 10px;">重庆</a> <a href="/tags/驱动/" style="font-size: 15px;">驱动</a>
  </div>
</div>


  <div class="widget tag">
<h3 class="title">Links</h3>
<ul class="entry">
<li><a href="http://blog.ourren.com/" title="Ourren">Ourren</a></li>
<li><a href="http://www.hyjal.net/" title="Hyjal">Hyjal</a></li>
<li><a href="http://www.jianshu.com/users/fa15f4e416ae/latest_articles" title="Daemonceltics">Daemonceltics</a></li>
<li><a href="http://papap.info/" title="isee">isee</a></li>
</ul>
</div>

  <script type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=putG&d=yoFnN6V-ovhL-H4e9_69LvkTiX4uX7rEYJ15yL3G1Wg"></script>
</aside>
    <div class="clearfix"></div>
  </div>
  <div id="go-pg-top"><i class="icon-arrow-up"></i></div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2020 Lyon
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/page.js"></script>

</body>

</html>