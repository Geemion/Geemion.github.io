<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Windows x64 Shellcode编写指南(翻译) | Lyon&#39;s blog</title>
  <meta name="author" content="Lyon">
  
  <meta name="description" content="Walk steps step by step">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Windows x64 Shellcode编写指南(翻译)"/>
  <meta property="og:site_name" content="Lyon&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  #<link href="/favicon.ico" rel="icon">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Lyon&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="/js/jquery.min.js"></script>
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?0fe72895c9bcfd0d09da12b5378b1b91";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</head>


<body>
  <!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0027_Simplified Chinese.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Lyon&#39;s blog</a></h1>
  <h2><a href="/">I hear and I forget.I see and I remember.I do and I understand.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/about">关于</a></li>
    
	<li> <a href="/atom.xml">RSS</a> </li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2017-05-17T02:48:03.000Z"><a href="/2017/05/17/Windows/Windows-x64-Shellcode/">2017-05-17</a></time>
      
      
  
    <h1 class="title">Windows x64 Shellcode编写指南(翻译)</h1>
  

    </header>
	
<!-- Table of Contents -->

  <div id="toc" class="toc-article">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#寄存器(Registers)"><span class="toc-number">2.</span> <span class="toc-text">寄存器(Registers)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#x86"><span class="toc-number">2.1.</span> <span class="toc-text">x86</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x64"><span class="toc-number">2.2.</span> <span class="toc-text">x64</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Clobber寄存器(Clobber_Registers)"><span class="toc-number">2.3.</span> <span class="toc-text">Clobber寄存器(Clobber Registers)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#调用约定(Calling_Convention)"><span class="toc-number">3.</span> <span class="toc-text">调用约定(Calling Convention)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#x86-1"><span class="toc-number">3.1.</span> <span class="toc-text">x86</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x64-1"><span class="toc-number">3.2.</span> <span class="toc-text">x64</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shellcode"><span class="toc-number">4.</span> <span class="toc-text">Shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#注释"><span class="toc-number">4.1.</span> <span class="toc-text">注释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开始"><span class="toc-number">4.2.</span> <span class="toc-text">开始</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1)-声明NASM指令"><span class="toc-number">4.2.1.</span> <span class="toc-text">1).声明NASM指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2)-设置堆栈"><span class="toc-number">4.2.2.</span> <span class="toc-text">2).设置堆栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3)-得到Kernel32的基地址"><span class="toc-number">4.2.3.</span> <span class="toc-text">3).得到Kernel32的基地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开始编写汇编代码"><span class="toc-number">4.2.4.</span> <span class="toc-text">开始编写汇编代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#后记"><span class="toc-number">5.</span> <span class="toc-text">后记</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#其他关于x64_Shellcode不错的文章(译文添加)"><span class="toc-number">6.</span> <span class="toc-text">其他关于x64 Shellcode不错的文章(译文添加)</span></a></li></ol>
  </div>


	
    <div class="entry">
      
        <h1 id="前言">前言</h1><p><em>对Topher Timzen关于x64 Windows平台下关于Shellcode的翻译，原文链接<a href="https://www.tophertimzen.com/blog/windowsx64Shellcode/" target="_blank" rel="external">Windows x64 Shellcode</a>，第一次翻译特别渣，推荐看原文</em></p>
<p>最近我重写了几个shellcode，将之前32位平台下实现的shellcode移植到64位平台。在向64位平台移植过程，我发现很难在网上找到相关资料，因此我将我的移植过程写成一篇博客（我的第一篇），希望能帮到像我一样需要移植64位shellcode的人。<br>网上已经有几篇教程介绍关于shellcode的相关基础知识了，因此我不会介绍这些。虽然我会介绍关于调用约定、register clobbering和寄存器相关知识，但是我不会讨论很多汇编基础知识。<br>请参考Skape的<a href="www.nologin.com/Downloads/Papers/win32-shellcode.pdf">Understanding Windows Shell code</a>等文章，或者资源<a href="http://www.projectshellcode.com/" target="_blank" rel="external">project-shellcode</a>进行深入学习(Understanding Windows Shell code原始链接失效，这里替换了，原始链接为<a href="http://repo.hackerzvoice.net/depot_madchat/windoz/vulns/win32-shellcode.pdf)。" target="_blank" rel="external">http://repo.hackerzvoice.net/depot_madchat/windoz/vulns/win32-shellcode.pdf)。</a><br>我将介绍32位汇编与64位汇编的差异，以及如何利用Windows系统中的结构体用于开发64位shellcode。我还将介绍我开发的2种漏洞利用辅助开发工具。<br>在开始之前需要说明的是我仍然在学习漏洞利用开发的初级阶段，为简单化，本文实验的系统为Window 7 x64版本。为简化叙述，x86指Win32平台，x64指Win64平台。<br><a id="more"></a></p>
<h1 id="寄存器(Registers)">寄存器(Registers)</h1><h2 id="x86">x86</h2><p>x86处理器中有8个32位的通用寄存器</p>
<ul>
<li>eax-累加器</li>
<li>ecx-计数寄存器</li>
<li>edx-数据寄存器</li>
<li>ebx-基地址寄存器</li>
<li>esp-堆栈指针</li>
<li>ebp-基址指针</li>
<li>esi-源索引寄存器</li>
<li>edi-目标索引寄存器</li>
<li>eip-指令寄存器<br>由于向后兼容原因，其中4个寄存器（eax,ebx,ecx,edx）可以拆分16位和8位寄存器</li>
<li>AX-EAX的低16位</li>
<li>AH-AX的高8位</li>
<li>AL-AX的低8位</li>
<li>BX-EBX的低16位</li>
<li>BH-EBX的高8位</li>
<li>BL-EBX的低8位<br>ECX和EDX也使用字母（C,D）和后缀（X,H或L）表示16位和8位寄存器。<h2 id="x64">x64</h2>64位处理器使用前缀“R”扩展上述8个寄存器，RAX,RCX,RDX等。需要注意的是x86平台下的寄存器表示方式仍然可用（eax,ax,al等）。<br>还引入了8个新的寄存器，r8、r9、r10、r11、r12、r13、r14和r15。这些寄存器也可以分为32位、16位和8位的版本。</li>
<li>r#=64位</li>
<li>r#d=低32位</li>
<li>r#w=低16位</li>
<li>r#b=8位<br>不幸的是，这些新的8位扩展寄存器不能够使用像eax中的低16位的高8位<h2 id="Clobber寄存器(Clobber_Registers)">Clobber寄存器(Clobber Registers)</h2>Clobber寄存器是一些可能在函数（如Windows API）中被覆盖修改的寄存器。在汇编代码中不应该使用这些寄存器，容易引发程序不稳定，但是如果明确知道在api函数中那些寄存器会别修改还是可以使用这些寄存器的。<br>在Win32 API中,EAX、ECX和EDX都是Clobber寄存器，在Win64 API中，除了RBP、RBX、RDI、RSI、R12、R13、R14和R15，其他的寄存器都是Clobber寄存器。<br>RAX和EAX分别用于x64和x86函数的返回值。<h1 id="调用约定(Calling_Convention)">调用约定(Calling Convention)</h1><h2 id="x86-1">x86</h2>Win32 API一般使用__stdcall调用约定，从右到左向堆栈上传递参数。<br>如调用函数有两个参数int x和int y的函数foo<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在堆栈上传递为<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push y</span><br><span class="line">push x</span><br></pre></td></tr></table></figure></p>
<h2 id="x64-1">x64</h2><p>Win64平台下函数调用约定不同，但与Win32平台下的__fastcall相似，均使用寄存器传参，前四个参数分别使用RCX、RDX、R8和R9传递，其他多余的参数使用堆栈传递。需要注意的是，使用寄存器传参时从右到左传递参数。<br>如，对Windows函数MessageBox的调用声明如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">MessageBox</span><span class="params">(</span><br><span class="line">_In_opt_  HWND hWnd,</span><br><span class="line">_In_opt_  LPCTSTR lpText,</span><br><span class="line">_In_opt_  LPCTSTR lpCaption,</span><br><span class="line">_In_      UINT uType</span><br><span class="line">)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>在Win64调用预定下，参数为:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">r9 = uType</span><br><span class="line">r8 = lpCaption</span><br><span class="line">rdx = lpText</span><br><span class="line">rcx = hWnd</span><br></pre></td></tr></table></figure></p>
<h1 id="Shellcode">Shellcode</h1><p>让我们开始吧<br>现在Win64下的Shellcode与Win32的关键区别我们已经知道了，开始我们的文章吧。<br>为显示运行Win64 shellcode，我将编写代码弹出MessageBox对话框。当shellcode最终完成后，我将使用我编写的工具将shellcode代码注入到calc进程中，验证shellcode能够在另一个进程中运行。</p>
<h2 id="注释">注释</h2><p>我将使用NASM编译汇编代码，使用Jeremy Gordon编写的golink链接程序。使用你最喜欢的文本编辑器编辑汇编代码，我使用Windows平台下的Notepad++,然后开始编写代码。</p>
<h2 id="开始">开始</h2><h3 id="1)-声明NASM指令">1).声明NASM指令</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bits <span class="number">64</span> </span><br><span class="line">section .text</span><br><span class="line">global start</span><br></pre></td></tr></table></figure>
<h3 id="2)-设置堆栈">2).设置堆栈</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start: </span><br><span class="line">	<span class="sub"><span class="keyword">sub</span> rsp, 28h                ;</span>reserve stack space <span class="keyword">for</span> called functions</span><br><span class="line">	<span class="keyword">and</span> rsp, 0fffffffffffffff0h ;make sure stack <span class="number">16</span>-byte aligned</span><br></pre></td></tr></table></figure>
<h3 id="3)-得到Kernel32的基地址">3).得到Kernel32的基地址</h3><p>Win64与Win32平台的PEB结构位置是不同的，在Win32中，PEB为[fs:30h]指向的地址，而在Win64为[gs:60h]<br>虽然PEB结构发生了巨大变化，但是我们只关心LDR链表(PEB_LDR_DATA)所在的未知，在Windbg中使用”!peb”命令可以得到LDR所在的位置。<br>在Windbg输出的PEB结构中，Ldr.InMemoryOrderModuleList中包含Kernel32.dll,在链表第三个未知，此列表显示了进程中各个内存模块（PE文件，可执行文件和dll文件）在内存中所在的位置。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Ldr.InMemoryOrderModuleList:         <span class="number">00000000002</span>b3150 . <span class="number">00000000002</span>b87d0</span><br><span class="line">        Base TimeStamp                     Module</span><br><span class="line">    ff600000 <span class="number">4</span>a5bc9d4 Jul <span class="number">13</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">08</span> <span class="number">2009</span> C:\Windows\System32\calc.exe</span><br><span class="line">    <span class="number">77</span>b90000 <span class="number">4</span>ce7c8f9 Nov <span class="number">20</span> <span class="number">05</span>:<span class="number">11</span>:<span class="number">21</span> <span class="number">2010</span> C:\Windows\SYSTEM32\ntdll.dll</span><br><span class="line">    <span class="number">77970000</span> <span class="number">4</span>ce7c78b Nov <span class="number">20</span> <span class="number">05</span>:<span class="number">05</span>:<span class="number">15</span> <span class="number">2010</span> C:\Windows\system32\kernel32.dll</span><br></pre></td></tr></table></figure></p>
<p>通过在Windbg中使用dt命令填充PEB结构，确定Ldr链表所在的位置。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dt _PEB 000007fffffd4000</span><br><span class="line">ntdll!_PEB</span><br><span class="line">   +0x000 InheritedAddressSpace : 0 ''</span><br><span class="line">   +0x001 ReadImageFileExecOptions : 0 ''</span><br><span class="line">   +0x002 BeingDebugged    : 0x1 ''</span><br><span class="line">   +0x003 BitField         : 0x8 ''</span><br><span class="line">   +0x003 ImageUsesLargePages : 0y0</span><br><span class="line">   +0x003 IsProtectedProcess : 0y0</span><br><span class="line">   +0x003 IsLegacyProcess  : 0y0</span><br><span class="line">   +0x003 IsImageDynamicallyRelocated : 0y1</span><br><span class="line">   +0x003 SkipPatchingUser32Forwarders : 0y0</span><br><span class="line">   +0x003 SpareBits        : 0y000</span><br><span class="line">   +0x008 Mutant           : 0xffffffff`ffffffff Void</span><br><span class="line">   +0x010 ImageBaseAddress : 0x00000000`ff600000 Void</span><br><span class="line">   +0x018 Ldr              : 0x00000000`77cc2640 _PEB_LDR_DATA</span><br></pre></td></tr></table></figure></p>
<p>Ldr链表位于PEB的0x18位置<br>现在，我们还需要做一下步骤：</p>
<ul>
<li><p>通过在PEB偏移0x18处获得Ldr链表，获得Ldr链表后，访问位于Ldr结构偏移0x20处的InMemoryOrderModuleList，如下输出</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dt _PEB_LDR_DATA 77cc2640</span><br><span class="line">ntdll!_PEB_LDR_DATA</span><br><span class="line">   +0x000 Length           : 0x58</span><br><span class="line">   +0x004 Initialized      : 0x1 ''</span><br><span class="line">   +0x008 SsHandle         : (null) </span><br><span class="line">   +0x010 InLoadOrderModuleList : _LIST_ENTRY [ 0x00000000`002b3140 - 0x00000000`002b87c0 ]</span><br><span class="line">   +0x020 InMemoryOrderModuleList : _LIST_ENTRY [ 0x00000000`002b3150 - 0x00000000`002b87d0 ]</span><br><span class="line">   +0x030 InInitializationOrderModuleList : _LIST_ENTRY [ 0x00000000`002b3270 - 0x00000000`002b87e0 ]</span><br><span class="line">   +0x040 EntryInProgress  : (null) </span><br><span class="line">   +0x048 ShutdownInProgress : 0 ''</span><br><span class="line">   +0x050 ShutdownThreadId : (null)</span><br></pre></td></tr></table></figure>
</li>
<li><p>偏移0x20处为InMemoryOrderModuleList，由InMemoryOrderModule列表的输出的图中可以看出，Kernel32.dll是第3个内存模块。在_LIST_ENTRY结构包含向前和向后的指针，所有_LIST_ENTRY组成一个循环链表，通过这个链表可以找到Kernel32的基地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _LIST_ENTRY</span><br><span class="line">ntdll!_LIST_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> Flink            : Ptr64 _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x008</span> Blink            : Ptr64 _LIST_ENTRY</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在Windbg中，使用!list可以遍历遍历_LIST_ENTRY结构组成的链表。!lis -x可以用于为每个位置的元素指定一个命令。我们用它去解析_PEB_LDR_DATA结构中的0x20偏移量，并通过_LIST_ENTRY元素进行解析。<br>将列出所有InMemoryOrderModule链表并显示相关的_LDR_DATA_TABLE_ENTRY<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _LDR_DATA_TABLE_ENTRY</span><br><span class="line">ntdll!_LDR_DATA_TABLE_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> InLoadOrderLinks : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x010</span> InMemoryOrderLinks : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x020</span> InInitializationOrderLinks : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x030</span> DllBase          : Ptr64 Void</span><br><span class="line">   +<span class="number">0x038</span> EntryPoint       : Ptr64 Void</span><br><span class="line">   +<span class="number">0x040</span> SizeOfImage      : Uint4B</span><br><span class="line">   +<span class="number">0x048</span> FullDllName      : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x058</span> BaseDllName      : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x068</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x06c</span> LoadCount        : Uint2B</span><br><span class="line">   +<span class="number">0x06e</span> TlsIndex         : Uint2B</span><br><span class="line">   +<span class="number">0x070</span> HashLinks        : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x070</span> SectionPointer   : Ptr64 Void</span><br><span class="line">   +<span class="number">0x078</span> CheckSum         : Uint4B</span><br><span class="line">   +<span class="number">0x080</span> TimeDateStamp    : Uint4B</span><br><span class="line">   +<span class="number">0x080</span> LoadedImports    : Ptr64 Void</span><br><span class="line">   +<span class="number">0x088</span> EntryPointActivationContext : Ptr64 _ACTIVATION_CONTEXT</span><br><span class="line">   +<span class="number">0x090</span> PatchInformation : Ptr64 Void</span><br><span class="line">   +<span class="number">0x098</span> ForwarderLinks   : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x0a8</span> ServiceTagLinks  : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x0b8</span> StaticLinks      : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x0c8</span> ContextInformation : Ptr64 Void</span><br><span class="line">   +<span class="number">0x0d0</span> OriginalBase     : Uint8B</span><br><span class="line">   +<span class="number">0x0d8</span> LoadTime         : _LARGE_INTEGER</span><br></pre></td></tr></table></figure></p>
<p>在_LDR_DATA_TABLE_ENTRY结构中，InLoadOrderLinks指向下一个模块结构，DllBase是模块的基地址，FullDllName是它模块名称的Unicode字符串。<br>因为我们知道kenel32.dll是第三个模块<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; !<span class="built_in">list</span> -t ntdll!_LIST_ENTRY.Flink  -x <span class="string">"dt _LDR_DATA_TABLE_ENTRY @$extret"</span> <span class="number">002</span>b3270</span><br><span class="line">---CUT</span><br><span class="line">ntdll!_LDR_DATA_TABLE_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> InLoadOrderLinks : _LIST_ENTRY [ <span class="number">0x00000000</span>`<span class="number">002</span>b3830 - <span class="number">0x00000000</span>`<span class="number">002</span>b3260 ]</span><br><span class="line">   +<span class="number">0x010</span> InMemoryOrderLinks : _LIST_ENTRY [ <span class="number">0x00000000</span>`<span class="number">002</span>b4980 - <span class="number">0x00000000</span>`<span class="number">002</span>b3840 ]</span><br><span class="line">   +<span class="number">0x020</span> InInitializationOrderLinks : _LIST_ENTRY [ <span class="number">0x00000000</span>`<span class="number">77970000</span> - <span class="number">0x00000000</span>`<span class="number">77985</span>ea0 ]</span><br><span class="line">   +<span class="number">0x030</span> DllBase          : <span class="number">0xbaadf00d</span>`<span class="number">0011f</span>000 Void</span><br><span class="line">   +<span class="number">0x038</span> EntryPoint       : <span class="number">0x00000000</span>`<span class="number">00420040</span> Void</span><br><span class="line">   +<span class="number">0x040</span> SizeOfImage      : <span class="number">0x2b35c0</span></span><br><span class="line">   +<span class="number">0x048</span> FullDllName      : _UNICODE_STRING <span class="string">"kernel32.dll"</span></span><br><span class="line">   +<span class="number">0x058</span> BaseDllName      : _UNICODE_STRING <span class="string">"ꩀ矌"</span></span><br><span class="line">   +<span class="number">0x068</span> Flags            : <span class="number">0x77ccaa40</span></span><br><span class="line">   +<span class="number">0x06c</span> LoadCount        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x06e</span> TlsIndex         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x070</span> HashLinks        : _LIST_ENTRY [ <span class="number">0xbaadf00d</span>`<span class="number">4</span>ce7c78b - <span class="number">0x00000000</span>`<span class="number">00000000</span> ]</span><br><span class="line">   +<span class="number">0x070</span> SectionPointer   : <span class="number">0xbaadf00d</span>`<span class="number">4</span>ce7c78b Void</span><br><span class="line">   +<span class="number">0x078</span> CheckSum         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x080</span> TimeDateStamp    : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x080</span> LoadedImports    : (null) </span><br><span class="line">   +<span class="number">0x088</span> EntryPointActivationContext : <span class="number">0x00000000</span>`<span class="number">002</span>b4d20 _ACTIVATION_CONTEXT</span><br><span class="line">   +<span class="number">0x090</span> PatchInformation : <span class="number">0x00000000</span>`<span class="number">002</span>b4d20 Void</span><br><span class="line">   +<span class="number">0x098</span> ForwarderLinks   : _LIST_ENTRY [ <span class="number">0x00000000</span>`<span class="number">002</span>b36e8 - <span class="number">0x00000000</span>`<span class="number">002</span>b36e8 ]</span><br><span class="line">   +<span class="number">0x0a8</span> ServiceTagLinks  : _LIST_ENTRY [ <span class="number">0x00000000</span>`<span class="number">002</span>b3980 - <span class="number">0x00000000</span>`<span class="number">002</span>b3750 ]</span><br><span class="line">   +<span class="number">0x0b8</span> StaticLinks      : _LIST_ENTRY [ <span class="number">0x00000000</span>`<span class="number">77</span>c95124 - <span class="number">0x00000000</span>`<span class="number">78</span>d20000 ]</span><br><span class="line">   +<span class="number">0x0c8</span> ContextInformation : <span class="number">0x01d00f7c</span>`<span class="number">80e29</span>f8e Void</span><br><span class="line">   +<span class="number">0x0d0</span> OriginalBase     : <span class="number">0xabababab</span>`abababab</span><br><span class="line">   +<span class="number">0x0d8</span> LoadTime         : _LARGE_INTEGER <span class="number">0xabababab</span>`abababab</span><br><span class="line">   ---CUT</span><br></pre></td></tr></table></figure></p>
<p>现在知道加载的模块基地址在_LDR_DATA_TABLE_ENTRY的0x30偏移处。<br>a.通过访问[gs:60h]找到PEB<br>b.通过在PEB中偏移0x18进入LDR链表。<br>c.偏移0x20是InMemoryOrderModuleList。<br>d.InMemoryOrderModuleList中的第3个元素是Kernel32，0x30th offset是模块的基地址。<br>e.我们要调用ExitProcess，这实际上是来自ntdll.dll的RtlExitUserProcess。Ntdll.dll是InMemoryOrderModuleList中的第二个条目，我也将获取它的基地址并将其存储在r15中供以后使用。我发现这个方法比依靠Kernel32在ntdll中正确执行一个函数更容易和更可靠</p>
<p><div align="center"><br><img src="/img/x64_shellcode.jpg" align="center"><br></div><br>从dependency walker中可以看出ExitProcess指向Ntdll.RtlExitUserProcess。</p>
<h3 id="开始编写汇编代码">开始编写汇编代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mov r12, [gs:<span class="number">60</span>h]       ;peb</span><br><span class="line">mov r12, [r12 + <span class="number">0x18</span>]   ;Peb --&gt; LDR</span><br><span class="line">mov r12, [r12 + <span class="number">0x20</span>]   ;Peb.Ldr.InMemoryOrderModuleList</span><br><span class="line">mov r12, [r12]          ;<span class="number">2</span>st entry</span><br><span class="line">mov r15, [r12 + <span class="number">0x20</span>]   ;ntdll.dll base address!</span><br><span class="line">mov r12, [r12]          ;<span class="number">3</span>nd entry</span><br><span class="line">mov r12, [r12 + <span class="number">0x20</span>]   ;kernel32.dll base address! We go <span class="number">20</span> bytes in here as we are already <span class="number">10</span> bytes into the _LDR_DATA_TABLE_ENTRY from the InMemoryOrderModuleList </span><br><span class="line">``` </span><br><span class="line">这里将Kernel32的地址放入r12寄存器(r12寄存器不是Clobber寄存器),在shellcode执行期间需要已知保留Kernel32的地址。现在找到了kernel32模块的地址，可以通过kernel32加载其他模块和获取其他函数的地址。</span><br><span class="line">```<span class="function">c</span><br><span class="line">HMODULE WINAPI <span class="title">LoadLibrary</span><span class="params">(</span><br><span class="line">_In_  LPCTSTR lpFileName</span><br><span class="line">)</span></span>;</span><br></pre></td></tr></table></figure>
<p>LoadLibraryA用于将其他dll模块加载到当前进程，因为shellcode需要与地址无关，不能依赖任何已经在目标进程中的dll。在本例中需要加载user32.dll。<br>为了使用LoadLibraryA函数，它必须在kernel32.dll中找它的地址，这就需要GetProcAddress函数了。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FARPROC WINAPI <span class="title">GetProcAddress</span><span class="params">(</span><br><span class="line">_In_  HMODULE hModule,</span><br><span class="line">_In_  LPCSTR lpProcName</span><br><span class="line">)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>GetProcAddress需要两个参数，需要获得的函数模块句柄以及函数名。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">;find address of loadLibraryA from kernel32.dll which was found above. </span><br><span class="line">mov rdx, <span class="number">0xec0e4e8e</span>  ;lpProcName (loadLibraryA hash from ror13)</span><br><span class="line">mov rcx, r12         ;hModule</span><br><span class="line">call GetProcessAddress</span><br></pre></td></tr></table></figure></p>
<p>一旦我们知道LoadLibraryA的地址，我们可以使用它来加载user32.dll。<br>“0xec0e4e8e”为函数名称的hash,将该hash赋值给rdx作为函数名参数。<br>0xec0e4e8e是LoadLibraryA的每个字母ROR 0x13相加所得的总和。这在Shellcode中是常见的，在MetaSploit等项目使用。我写了一个简单的C程序来用来计算这些hash。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#./rot13.exe LoadLibraryA</span></span><br><span class="line">LoadLibraryA</span><br><span class="line">ROR13 of LoadLibraryA is: <span class="number">0xec0e4e8e</span></span><br></pre></td></tr></table></figure></p>
<p>现在加载user32.dll<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">;import user32</span><br><span class="line">lea rcx, [user32_dll]</span><br><span class="line">call rax                ;load user32.dll</span><br><span class="line">user_32dll: db 'user32.dll', 0</span><br></pre></td></tr></table></figure></p>
<p>现在可以获得MessageBox函数的地址了<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov rdx, <span class="number">0xbc4da2a8</span> 	;hash <span class="keyword">for</span> MessageBoxA from rot13</span><br><span class="line">mov rcx, rax</span><br><span class="line">call GetProcessAddress</span><br></pre></td></tr></table></figure></p>
<p>然后执行MessageBox<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">;messageBox</span><br><span class="line">xor r9, r9            ;uType</span><br><span class="line">lea r8, [title_str]   ;lpCaptopn</span><br><span class="line">lea rdx, [hello_str]  ;lpText</span><br><span class="line">xor rcx, rcx          ;hWnd</span><br><span class="line">call rax              ;display message box	</span><br><span class="line">title_str:  db  '0xdeadbeef',   0</span><br><span class="line">hello_str:  db  'This is fun!', 0</span><br></pre></td></tr></table></figure></p>
<p>最后使用ExitProcess函数结束进程<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID WINAPI <span class="title">ExitProcess</span><span class="params">(</span><br><span class="line">_In_  UINT uExitCode</span><br><span class="line">)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>需要注意的是ExitProcess是kernel32所导出的函数，但是这里使用RtlExitUserProcess。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">;ExitProcess</span><br><span class="line">mov rdx, <span class="number">0x2d3fcd70</span>				</span><br><span class="line">mov rcx, r15 			;base address of ntdll</span><br><span class="line">call GetProcessAddress</span><br><span class="line">xor  rcx, rcx 			;uExitCode</span><br><span class="line">call rax</span><br></pre></td></tr></table></figure></p>
<p>完整的shellcode与GetProcess函数实现如下:<br>这里使用call/pop指令实现”lea”指令<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">bits 64</span><br><span class="line">section .text</span><br><span class="line">global start</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">;get dll base addresses</span><br><span class="line">	sub rsp, 28h                     ;reserve stack space for called functions</span><br><span class="line">	and rsp, 0fffffffffffffff0h      ;make sure stack 16-byte aligned   </span><br><span class="line"> </span><br><span class="line">	mov r12, [gs:60h]                ;peb</span><br><span class="line">	mov r12, [r12 + 0x18]            ;Peb --&gt; LDR</span><br><span class="line">	mov r12, [r12 + 0x20]            ;Peb.Ldr.InMemoryOrderModuleList</span><br><span class="line">	mov r12, [r12]                   ;2st entry</span><br><span class="line">	mov r15, [r12 + 0x20]            ;ntdll.dll base address!</span><br><span class="line">	mov r12, [r12]                   ;3nd entry</span><br><span class="line">	mov r12, [r12 + 0x20]            ;kernel32.dll base address!</span><br><span class="line"> </span><br><span class="line">;find address of loadLibraryA from kernel32.dll which was found above. </span><br><span class="line">	mov rdx, 0xec0e4e8e</span><br><span class="line">	mov rcx, r12</span><br><span class="line">	call GetProcessAddress         </span><br><span class="line"> </span><br><span class="line">;import user32</span><br><span class="line">	jmp getUser32</span><br><span class="line">returnGetUser32:</span><br><span class="line">	pop rcx</span><br><span class="line">	call rax                        ;load user32.dll</span><br><span class="line">	</span><br><span class="line">;get messageBox address</span><br><span class="line">	mov rdx, 0xbc4da2a8</span><br><span class="line">	mov rcx, rax</span><br><span class="line">	call GetProcessAddress  </span><br><span class="line">	mov rbx, rax</span><br><span class="line"></span><br><span class="line">;messageBox</span><br><span class="line">	xor r9, r9                     ;uType</span><br><span class="line">	jmp getText</span><br><span class="line">returnGetText:</span><br><span class="line">	pop r8                         ;lpCaption</span><br><span class="line">	jmp getTitle</span><br><span class="line">returnGetTitle:</span><br><span class="line">	pop rdx                        ;lpTitle</span><br><span class="line">	xor rcx, rcx                   ;hWnd</span><br><span class="line">	call rbx                       ;display message box	</span><br><span class="line">	</span><br><span class="line">;ExitProcess</span><br><span class="line">	mov rdx, 0x2d3fcd70				</span><br><span class="line">	mov rcx, r15</span><br><span class="line">	call GetProcessAddress</span><br><span class="line">	xor  rcx, rcx                  ;uExitCode</span><br><span class="line">	call rax       </span><br><span class="line"></span><br><span class="line">;get strings	</span><br><span class="line">getUser32:</span><br><span class="line">	call returnGetUser32</span><br><span class="line">	db  'user32.dll'</span><br><span class="line">	db	0x00</span><br><span class="line">getTitle:</span><br><span class="line">	call returnGetTitle</span><br><span class="line">	db  'This is fun!'</span><br><span class="line">	db	0x00</span><br><span class="line">getText:</span><br><span class="line">	call returnGetText</span><br><span class="line">	db  '0xdeadbeef'</span><br><span class="line">	db	0x00</span><br><span class="line"></span><br><span class="line">;Hashing section to resolve a function address	</span><br><span class="line">GetProcessAddress:		</span><br><span class="line">	mov r13, rcx                     ;base address of dll loaded </span><br><span class="line">	mov eax, [r13d + 0x3c]           ;skip DOS header and go to PE header</span><br><span class="line">	mov r14d, [r13d + eax + 0x88]    ;0x88 offset from the PE header is the export table. </span><br><span class="line"></span><br><span class="line">	add r14d, r13d                  ;make the export table an absolute base address and put it in r14d.</span><br><span class="line">	mov r10d, [r14d + 0x18]         ;go into the export table and get the numberOfNames </span><br><span class="line">	mov ebx, [r14d + 0x20]          ;get the AddressOfNames offset. </span><br><span class="line">	add ebx, r13d                   ;AddressofNames base. </span><br><span class="line">	</span><br><span class="line">find_function_loop:	</span><br><span class="line">	jecxz find_function_finished   ;if ecx is zero, quit :( nothing found. </span><br><span class="line">	dec r10d                       ;dec ECX by one for the loop until a match/none are found</span><br><span class="line">	mov esi, [ebx + r10d * 4]      ;get a name to play with from the export table. </span><br><span class="line">	add esi, r13d                  ;esi is now the current name to search on. </span><br><span class="line">	</span><br><span class="line">find_hashes:</span><br><span class="line">	xor edi, edi</span><br><span class="line">	xor eax, eax</span><br><span class="line">	cld			</span><br><span class="line">	</span><br><span class="line">continue_hashing:	</span><br><span class="line">	lodsb                         ;get into al from esi</span><br><span class="line">	test al, al                   ;is the end of string resarched?</span><br><span class="line">	jz compute_hash_finished</span><br><span class="line">	ror dword edi, 0xd            ;ROR13 for hash calculation!</span><br><span class="line">	add edi, eax		</span><br><span class="line">	jmp continue_hashing</span><br><span class="line">	</span><br><span class="line">compute_hash_finished:</span><br><span class="line">	cmp edi, edx                  ;edx has the function hash</span><br><span class="line">	jnz find_function_loop        ;didn't match, keep trying!</span><br><span class="line">	mov ebx, [r14d + 0x24]        ;put the address of the ordinal table and put it in ebx. </span><br><span class="line">	add ebx, r13d                 ;absolute address</span><br><span class="line">	xor ecx, ecx                  ;ensure ecx is 0'd. </span><br><span class="line">	mov cx, [ebx + 2 * r10d]      ;ordinal = 2 bytes. Get the current ordinal and put it in cx. ECX was our counter for which # we were in. </span><br><span class="line">	mov ebx, [r14d + 0x1c]        ;extract the address table offset</span><br><span class="line">	add ebx, r13d                 ;put absolute address in EBX.</span><br><span class="line">	mov eax, [ebx + 4 * ecx]      ;relative address</span><br><span class="line">	add eax, r13d	</span><br><span class="line">	</span><br><span class="line">find_function_finished:</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure></p>
<p>有关GetProcAddress函数的magic请参考<a href="www.nologin.com/Downloads/Papers/win32-shellcode.pdf">Skape</a>的教程。<br>现在我们编译链接我们的shellcode，然后测试是否可以执行<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nasm -f win64 messageBox64bit.<span class="keyword">asm</span> -o messageBox64bit.obj  </span><br><span class="line">golink /console messageBox64bit.obj</span><br><span class="line">./messageBox64bit.exe</span><br></pre></td></tr></table></figure></p>
<p><div align="center"><br><img src="/img/x64_shellcode2.jpg" align="center"><br></div><br>通过这种方式编译出来的shellcode是一个PE可执行文件，这里在将他编译成一个纯shellcode文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">nasm -f bin messageBox64bit.<span class="keyword">asm</span> -o messageBox64bit.sc </span><br><span class="line">xxd -i messageBox64bit.sc</span><br><span class="line">xxd -i messageBox64bit.sc</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> messageBox64bit_sc[] = &#123;</span><br><span class="line">  <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xec</span>, <span class="number">0x28</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xe4</span>, <span class="number">0xf0</span>, <span class="number">0x65</span>, <span class="number">0x4c</span>, <span class="number">0x8b</span>, <span class="number">0x24</span>,</span><br><span class="line">  <span class="number">0x25</span>, <span class="number">0x60</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4d</span>, <span class="number">0x8b</span>, <span class="number">0x64</span>, <span class="number">0x24</span>, <span class="number">0x18</span>, <span class="number">0x4d</span>, <span class="number">0x8b</span>,</span><br><span class="line">  <span class="number">0x64</span>, <span class="number">0x24</span>, <span class="number">0x20</span>, <span class="number">0x4d</span>, <span class="number">0x8b</span>, <span class="number">0x24</span>, <span class="number">0x24</span>, <span class="number">0x4d</span>, <span class="number">0x8b</span>, <span class="number">0x7c</span>, <span class="number">0x24</span>, <span class="number">0x20</span>,</span><br><span class="line">  <span class="number">0x4d</span>, <span class="number">0x8b</span>, <span class="number">0x24</span>, <span class="number">0x24</span>, <span class="number">0x4d</span>, <span class="number">0x8b</span>, <span class="number">0x64</span>, <span class="number">0x24</span>, <span class="number">0x20</span>, <span class="number">0xba</span>, <span class="number">0x8e</span>, <span class="number">0x4e</span>,</span><br><span class="line">  <span class="number">0x0e</span>, <span class="number">0xec</span>, <span class="number">0x4c</span>, <span class="number">0x89</span>, <span class="number">0xe1</span>, <span class="number">0xe8</span>, <span class="number">0x68</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xeb</span>, <span class="number">0x34</span>,</span><br><span class="line">  <span class="number">0x59</span>, <span class="number">0xff</span>, <span class="number">0xd0</span>, <span class="number">0xba</span>, <span class="number">0xa8</span>, <span class="number">0xa2</span>, <span class="number">0x4d</span>, <span class="number">0xbc</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xc1</span>, <span class="number">0xe8</span>,</span><br><span class="line">  <span class="number">0x56</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xc3</span>, <span class="number">0x4d</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>, <span class="number">0xeb</span>, <span class="number">0x2c</span>,</span><br><span class="line">  <span class="number">0x41</span>, <span class="number">0x58</span>, <span class="number">0xeb</span>, <span class="number">0x3a</span>, <span class="number">0x5a</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>, <span class="number">0xff</span>, <span class="number">0xd3</span>, <span class="number">0xba</span>, <span class="number">0x70</span>,</span><br><span class="line">  <span class="number">0xcd</span>, <span class="number">0x3f</span>, <span class="number">0x2d</span>, <span class="number">0x4c</span>, <span class="number">0x89</span>, <span class="number">0xf9</span>, <span class="number">0xe8</span>, <span class="number">0x37</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line">  <span class="number">0x31</span>, <span class="number">0xc9</span>, <span class="number">0xff</span>, <span class="number">0xd0</span>, <span class="number">0xe8</span>, <span class="number">0xc7</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0x75</span>, <span class="number">0x73</span>, <span class="number">0x65</span>,</span><br><span class="line">  <span class="number">0x72</span>, <span class="number">0x33</span>, <span class="number">0x32</span>, <span class="number">0x2e</span>, <span class="number">0x64</span>, <span class="number">0x6c</span>, <span class="number">0x6c</span>, <span class="number">0x00</span>, <span class="number">0xe8</span>, <span class="number">0xcf</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">  <span class="number">0xff</span>, <span class="number">0x54</span>, <span class="number">0x68</span>, <span class="number">0x69</span>, <span class="number">0x73</span>, <span class="number">0x20</span>, <span class="number">0x69</span>, <span class="number">0x73</span>, <span class="number">0x20</span>, <span class="number">0x66</span>, <span class="number">0x75</span>, <span class="number">0x6e</span>,</span><br><span class="line">  <span class="number">0x21</span>, <span class="number">0x00</span>, <span class="number">0xe8</span>, <span class="number">0xc1</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0x30</span>, <span class="number">0x78</span>, <span class="number">0x64</span>, <span class="number">0x65</span>, <span class="number">0x61</span>,</span><br><span class="line">  <span class="number">0x64</span>, <span class="number">0x62</span>, <span class="number">0x65</span>, <span class="number">0x65</span>, <span class="number">0x66</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xcd</span>, <span class="number">0x67</span>, <span class="number">0x41</span>, <span class="number">0x8b</span>,</span><br><span class="line">  <span class="number">0x45</span>, <span class="number">0x3c</span>, <span class="number">0x67</span>, <span class="number">0x45</span>, <span class="number">0x8b</span>, <span class="number">0xb4</span>, <span class="number">0x05</span>, <span class="number">0x88</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x45</span>,</span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0xee</span>, <span class="number">0x67</span>, <span class="number">0x45</span>, <span class="number">0x8b</span>, <span class="number">0x56</span>, <span class="number">0x18</span>, <span class="number">0x67</span>, <span class="number">0x41</span>, <span class="number">0x8b</span>, <span class="number">0x5e</span>, <span class="number">0x20</span>,</span><br><span class="line">  <span class="number">0x44</span>, <span class="number">0x01</span>, <span class="number">0xeb</span>, <span class="number">0x67</span>, <span class="number">0xe3</span>, <span class="number">0x3f</span>, <span class="number">0x41</span>, <span class="number">0xff</span>, <span class="number">0xca</span>, <span class="number">0x67</span>, <span class="number">0x42</span>, <span class="number">0x8b</span>,</span><br><span class="line">  <span class="number">0x34</span>, <span class="number">0x93</span>, <span class="number">0x44</span>, <span class="number">0x01</span>, <span class="number">0xee</span>, <span class="number">0x31</span>, <span class="number">0xff</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0xfc</span>, <span class="number">0xac</span>, <span class="number">0x84</span>,</span><br><span class="line">  <span class="number">0xc0</span>, <span class="number">0x74</span>, <span class="number">0x07</span>, <span class="number">0xc1</span>, <span class="number">0xcf</span>, <span class="number">0x0d</span>, <span class="number">0x01</span>, <span class="number">0xc7</span>, <span class="number">0xeb</span>, <span class="number">0xf4</span>, <span class="number">0x39</span>, <span class="number">0xd7</span>,</span><br><span class="line">  <span class="number">0x75</span>, <span class="number">0xdd</span>, <span class="number">0x67</span>, <span class="number">0x41</span>, <span class="number">0x8b</span>, <span class="number">0x5e</span>, <span class="number">0x24</span>, <span class="number">0x44</span>, <span class="number">0x01</span>, <span class="number">0xeb</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>,</span><br><span class="line">  <span class="number">0x66</span>, <span class="number">0x67</span>, <span class="number">0x42</span>, <span class="number">0x8b</span>, <span class="number">0x0c</span>, <span class="number">0x53</span>, <span class="number">0x67</span>, <span class="number">0x41</span>, <span class="number">0x8b</span>, <span class="number">0x5e</span>, <span class="number">0x1c</span>, <span class="number">0x44</span>,</span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0xeb</span>, <span class="number">0x67</span>, <span class="number">0x8b</span>, <span class="number">0x04</span>, <span class="number">0x8b</span>, <span class="number">0x44</span>, <span class="number">0x01</span>, <span class="number">0xe8</span>, <span class="number">0xc3</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> messageBox64bit_sc_len = <span class="number">258</span>;</span><br></pre></td></tr></table></figure>
<p>shellcode以16进制字符返回，然后通过我编写的另一个小程序在calc进程中执行该shellcode。需要说明的是这个小程序现在仅仅还是一个测试版，编写这个小程序的目的主要是为了测试另一个开源反汇编项目<a href="http://www.beaengine.org/home" target="_blank" rel="external">BeaEngine</a></p>
<p><div align="center"><br><img src="/img/x64_shellcode3.jpg" align="center"><br></div><br>启动这个小程序，将16进制数据拷贝到左边文本框中，选择64位版本，点击”Fire Shellcode”后，汇编代码将出现在右侧文本框中。实现汇编功能主要为了让这个小程序功能更加完整，通过这个功能也可以反编译一些不知道功能的shellcode。<br>点击”fire”后，小程序将运行calc并注入一个线程执行shellcode。</p>
<p><div align="center"><br><img src="/img/x64_shellcode4.jpg" align="center"><br></div><br>成功！</p>
<h1 id="后记">后记</h1><p>我希望这篇文章有助于帮助开发Win64 Shellcode，我刚开始写我在研究中学到的东西，希望以后能够继续坚持写。</p>
<p>可以在这里下载我使用的一些程序，我将它压缩并放到这里:<a href="http://www.tophertimzen.com/resources/win64BlogPost/Windows-x64-Shellcode-resources.zip" target="_blank" rel="external">资源</a>。</p>
<p>更新3/18/2015：我开源的我开发的shellcode Tester，将它放在了github:<a href="https://github.com/tophertimzen/shellcodeTester" target="_blank" rel="external">shellcodeTester</a>。</p>
<p><em>写于2014年12月4日</em></p>
<h1 id="其他关于x64_Shellcode不错的文章(译文添加)">其他关于x64 Shellcode不错的文章(译文添加)</h1><p><a href="http://mcdermottcybersecurity.com/articles/windows-x64-shellcode" target="_blank" rel="external">Windows x64 Shellcode</a></p>

      
    </div>
    <footer>
      

        
          <div class="alignleft post-nav">
            <em>上一篇: </em><a href="/2017/05/23/Windows/Kernel Data and Filtering Support/">Kernel Data and Filtering Support for Windows Server 2008（翻译）</a>
          </div>
        
        
          <div class="alignright post-nav">
            <em>下一篇: </em><a href="/2016/12/23/Learning/The-Art-of-Unpacking/">脱壳的艺术（翻译:The Art of Unpacking）</a>
          </div>
          <div class="clearfix"></div>
        

        
          <div class="copyright">
            
              <span class="claim">转载请注明youngroe.com</span>
            
            
              <span class="from-link">
                <em>本文链接地址:</em>
                <a href="/2017/05/17/Windows/Windows-x64-Shellcode/">
                  http://www.youngroe.com/2017/05/17/Windows/Windows-x64-Shellcode/
                </a>
              </span>
            
          </div>
        
		<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
  
  <div class="categories">
    <a href="/categories/Windows/">Windows</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/ASM/">ASM</a>, <a href="/tags/Shellcode/">Shellcode</a>, <a href="/tags/x64/">x64</a>
  </div>

        <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone"></a><a href="#" class="bds_tsina" data-cmd="tsina"></a><a href="#" class="bds_tqq" data-cmd="tqq"></a><a href="#" class="bds_renren" data-cmd="renren"></a><a href="#" class="bds_weixin" data-cmd="weixin"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdPic":"","bdStyle":"0","bdSize":"16"},"share":{},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"������","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
      
      <div class="clearfix"></div>
    </footer>
  </div>
</span>
</article>


<section id="comment">
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Cybersecurity/">Cybersecurity</a><small>1</small></li>
  
    <li><a href="/categories/Debug/">Debug</a><small>7</small></li>
  
    <li><a href="/categories/Kernel/">Kernel</a><small>4</small></li>
  
    <li><a href="/categories/Learning/">Learning</a><small>8</small></li>
  
    <li><a href="/categories/Life/">Life</a><small>7</small></li>
  
    <li><a href="/categories/Others/">Others</a><small>1</small></li>
  
    <li><a href="/categories/Read-Notes/">Read Notes</a><small>7</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>6</small></li>
  
    <li><a href="/categories/Vulnerabilities/">Vulnerabilities</a><small>0</small></li>
  
    <li><a href="/categories/Windows/">Windows</a><small>14</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2019/07/01/Windows/delphi_reverse_summary/">Delphi程序逆向反汇编技巧小记</a>
      </li>
    
      <li>
        <a href="/2019/06/25/Kernel/kernel_enum_wfp_callout_function/">Windows内核重拾：如何枚举系统中Windows Filtering Platform (WFP)驱动中的callout函数</a>
      </li>
    
      <li>
        <a href="/2019/05/06/Kernel/windows-driver-testing-basics/">Windows内核重拾：Windows驱动测试基础：工具、功能和示例（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2019/04/06/Windows/how-to-reverse-engineer-software-windows-in-a-right-way/">如何正确的对Windows软件进行逆向工程（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2019/01/12/Windows/a_crash_lead_deadlock/">Windows平台下一个崩溃而导致的死锁分析</a>
      </li>
    
      <li>
        <a href="/2018/12/01/Windows/windows_client_dns_over_https/">Windows客户端如何透明使用DNS-over-HTTPS</a>
      </li>
    
      <li>
        <a href="/2018/10/06/Cybersecurity/ddos-protection-techniques/">现代DDoS对抗技术概述（翻译/转载）</a>
      </li>
    
      <li>
        <a href="/2018/09/18/Life/xian/">西安周末游</a>
      </li>
    
      <li>
        <a href="/2018/01/06/Kernel/WindowsKernel_DebugObject/">Windows内核重拾：DebugObject</a>
      </li>
    
      <li>
        <a href="/2017/10/23/Tools/IDA-Pro-ClassInformer-Tutorial/">IDA Pro ClassInformer使用指南（翻译）</a>
      </li>
    
      <li>
        <a href="/2017/05/23/Windows/Kernel Data and Filtering Support/">Kernel Data and Filtering Support for Windows Server 2008（翻译）</a>
      </li>
    
      <li>
        <a href="/2017/05/17/Windows/Windows-x64-Shellcode/">Windows x64 Shellcode编写指南(翻译)</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/ASM/" style="font-size: 12.5px;">ASM</a> <a href="/tags/Boost/" style="font-size: 10px;">Boost</a> <a href="/tags/DDoS/" style="font-size: 10px;">DDoS</a> <a href="/tags/DNS-over-HTTPS/" style="font-size: 10px;">DNS-over-HTTPS</a> <a href="/tags/Delphi/" style="font-size: 10px;">Delphi</a> <a href="/tags/Dll劫持/" style="font-size: 10px;">Dll劫持</a> <a href="/tags/GCC-GDB/" style="font-size: 10px;">GCC&GDB</a> <a href="/tags/GetVersionEx/" style="font-size: 10px;">GetVersionEx</a> <a href="/tags/Http/" style="font-size: 10px;">Http</a> <a href="/tags/IDA-Pro/" style="font-size: 12.5px;">IDA Pro</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/MSDN/" style="font-size: 12.5px;">MSDN</a> <a href="/tags/Malware/" style="font-size: 12.5px;">Malware</a> <a href="/tags/MiniDumpWriteDump/" style="font-size: 10px;">MiniDumpWriteDump</a> <a href="/tags/PEB/" style="font-size: 10px;">PEB</a> <a href="/tags/Procmon/" style="font-size: 10px;">Procmon</a> <a href="/tags/Runtime-Error/" style="font-size: 10px;">Runtime Error</a> <a href="/tags/SEH/" style="font-size: 10px;">SEH</a> <a href="/tags/Shellcode/" style="font-size: 10px;">Shellcode</a> <a href="/tags/SysinternalsSuite/" style="font-size: 10px;">SysinternalsSuite</a> <a href="/tags/Tips/" style="font-size: 10px;">Tips</a> <a href="/tags/UAC/" style="font-size: 10px;">UAC</a> <a href="/tags/UAF漏洞/" style="font-size: 10px;">UAF漏洞</a> <a href="/tags/VC/" style="font-size: 10px;">VC</a> <a href="/tags/Visual-Studio/" style="font-size: 12.5px;">Visual Studio</a> <a href="/tags/Windbg/" style="font-size: 10px;">Windbg</a> <a href="/tags/Windows/" style="font-size: 20px;">Windows</a> <a href="/tags/Windows核心编程/" style="font-size: 17.5px;">Windows核心编程</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/getaddrinfo/" style="font-size: 10px;">getaddrinfo</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/libeay32/" style="font-size: 10px;">libeay32</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/ndk/" style="font-size: 10px;">ndk</a> <a href="/tags/sublime-text3/" style="font-size: 10px;">sublime text3</a> <a href="/tags/x64/" style="font-size: 12.5px;">x64</a> <a href="/tags/体验/" style="font-size: 10px;">体验</a> <a href="/tags/内核/" style="font-size: 12.5px;">内核</a> <a href="/tags/内核结构/" style="font-size: 15px;">内核结构</a> <a href="/tags/学习/" style="font-size: 10px;">学习</a> <a href="/tags/安全机制/" style="font-size: 10px;">安全机制</a> <a href="/tags/异常处理/" style="font-size: 10px;">异常处理</a> <a href="/tags/提权/" style="font-size: 10px;">提权</a> <a href="/tags/服务/" style="font-size: 10px;">服务</a> <a href="/tags/权限/" style="font-size: 12.5px;">权限</a> <a href="/tags/栈溢出漏洞/" style="font-size: 10px;">栈溢出漏洞</a> <a href="/tags/测试/" style="font-size: 10px;">测试</a> <a href="/tags/浮躁/" style="font-size: 10px;">浮躁</a> <a href="/tags/漏洞调试/" style="font-size: 12.5px;">漏洞调试</a> <a href="/tags/生活/" style="font-size: 15px;">生活</a> <a href="/tags/脱壳/" style="font-size: 10px;">脱壳</a> <a href="/tags/西安/" style="font-size: 10px;">西安</a> <a href="/tags/计划/" style="font-size: 10px;">计划</a> <a href="/tags/读书/" style="font-size: 10px;">读书</a> <a href="/tags/调试/" style="font-size: 15px;">调试</a> <a href="/tags/转换/" style="font-size: 10px;">转换</a> <a href="/tags/进程/" style="font-size: 10px;">进程</a> <a href="/tags/逆向/" style="font-size: 10px;">逆向</a> <a href="/tags/重庆/" style="font-size: 10px;">重庆</a> <a href="/tags/驱动/" style="font-size: 15px;">驱动</a>
  </div>
</div>


  <div class="widget tag">
<h3 class="title">Links</h3>
<ul class="entry">
<li><a href="http://blog.ourren.com/" title="Ourren">Ourren</a></li>
<li><a href="http://www.hyjal.net/" title="Hyjal">Hyjal</a></li>
<li><a href="http://www.jianshu.com/users/fa15f4e416ae/latest_articles" title="Daemonceltics">Daemonceltics</a></li>
<li><a href="http://papap.info/" title="isee">isee</a></li>
</ul>
</div>

  <script type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=putG&d=yoFnN6V-ovhL-H4e9_69LvkTiX4uX7rEYJ15yL3G1Wg"></script>
</aside>
    <div class="clearfix"></div>
  </div>
  <div id="go-pg-top"><i class="icon-arrow-up"></i></div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2020 Lyon
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/page.js"></script>

</body>

</html>